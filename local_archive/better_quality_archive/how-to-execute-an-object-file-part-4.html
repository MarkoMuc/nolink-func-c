<!DOCTYPE html>
<html dir="ltr" lang="en-us"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><script defer="defer" referrerpolicy="origin" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/s.js"></script><script type="module" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/index.astro_astro_type_script_index_0_lang.CoXd8L9s.js"></script>  <script async="" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/otSDKStub.js" data-document-language="true" type="text/javascript" data-domain-script="b1e05d49-f072-4bae-9116-bdb78af15448"></script><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="KeThzeyMOr"><meta name="baidu-site-verification" content="code-NIlrS7gNhx"><meta charset="UTF-8"><meta name="description" content="The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture."><title>How to execute an object file: part 4, AArch64 edition</title><meta name="title" content="How to execute an object file: part 4, AArch64 edition"><meta name="msvalidate.01" content="CF295E1604697F9CAD18B5A232E871F6"><meta class="swiftype" name="language" data-type="string" content="en"><script src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/i.js" type="text/javascript" referrerpolicy="origin"></script><script>(function(w,d){})(window,document)</script><meta name="viewport" content="width=device-width, initial-scale=1.0"><link rel="apple-touch-icon" sizes="180x180" href="https://blog.cloudflare.com/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="32x32" href="https://blog.cloudflare.com/images/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://blog.cloudflare.com/images/favicon-32x32.png"><link rel="mask-icon" href="https://blog.cloudflare.com/images/favicon-32x32.png" color="#f78100"><link rel="stylesheet" href="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/ashes.min.css"><link rel="sitemap" href="https://blog.cloudflare.com/sitemap.xml"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><link rel="canonical" href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-4/"><link rel="alternate" hreflang="en-us" href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-4/"><!-- General Meta Tags --><meta property="article:published_time" content="2023-11-17T14:00:35.000+00:00"><meta property="article:modified_time" content="2024-10-09T23:26:26.129Z"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Programming"><meta property="article:tag" content="Deep Dive"><meta property="article:publisher" content="https://www.facebook.com/cloudflare"><!-- Facebook Meta Tags --><meta property="og:site_name" content="The Cloudflare Blog"><meta property="og:type" content="article"><meta property="og:title" content="How to execute an object file: part 4, AArch64 edition"><meta property="og:description" content="The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture."><meta property="og:url" content="https://blog.cloudflare.com/how-to-execute-an-object-file-part-4/"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="628"><!-- Twitter/X Meta Tags --><meta name="twitter:title" content="How to execute an object file: part 4, AArch64 edition"><meta name="twitter:description" content="The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture."><meta name="twitter:url" content="https://blog.cloudflare.com/how-to-execute-an-object-file-part-4/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data1" content="Oxana Kharitonova"><meta name="twitter:label2" content="Filed under"><meta name="twitter:data2" content="Linux,Programming,Deep Dive"><meta name="twitter:site" content="@cloudflare"><meta property="og:image" content="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/32iMMwlljd5QlJuzD2MLTo/9f476195e6436ca8bfba6d9e5b9e5ac3/how-to-execute-an-object-file-part-4-zy4TY1.png"><meta name="twitter:image" content="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/32iMMwlljd5QlJuzD2MLTo/9f476195e6436ca8bfba6d9e5b9e5ac3/how-to-execute-an-object-file-part-4-zy4TY1.png"><link rel="stylesheet" href="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/index.Bpd2cWaZ.css"><style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();;(()=>{var A=Object.defineProperty;var g=(i,o,a)=>o in i?A(i,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[o]=a;var d=(i,o,a)=>g(i,typeof o!="symbol"?o+"":o,a);{let i={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},o=t=>{let[l,e]=t;return l in i?i[l](e):void 0},a=t=>t.map(o),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([l,e])=>[l,o(e)]));class y extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var b;if(!this.hydrator||!this.isConnected)return;let e=(b=this.parentElement)==null?void 0:b.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let c=this.querySelectorAll("astro-slot"),n={},h=this.querySelectorAll("template[data-astro-template]");for(let r of h){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("data-astro-template")||"default"]=r.innerHTML,r.remove())}for(let r of c){let s=r.closest(this.tagName);s!=null&&s.isSameNode(this)&&(n[r.getAttribute("name")||"default"]=r.innerHTML)}let p;try{p=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(r){let s=this.getAttribute("component-url")||"<unknown>",v=this.getAttribute("component-export");throw v&&(s+=` (export ${v})`),console.error(`[hydrate] Error parsing props for component ${s}`,this.getAttribute("props"),r),r}let u;await this.hydrator(this)(this.Component,p,n,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),c.disconnect(),this.childrenConnectedCallback()},c=new MutationObserver(()=>{var n;((n=this.lastChild)==null?void 0:n.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});c.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),c=this.getAttribute("client");if(Astro[c]===void 0){window.addEventListener(`astro:${c}`,()=>this.start(),{once:!0});return}try{await Astro[c](async()=>{let n=this.getAttribute("renderer-url"),[h,{default:p}]=await Promise.all([import(this.getAttribute("component-url")),n?import(n):()=>()=>{}]),u=this.getAttribute("component-export")||"default";if(!u.includes("."))this.Component=h[u];else{this.Component=h;for(let f of u.split("."))this.Component=this.Component[f]}return this.hydrator=p,this.hydrate},e,this)}catch(n){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,n)}}attributeChangedCallback(){this.hydrate()}}d(y,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",y)}})();</script><script src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/otBannerSdk.js" async="" type="text/javascript"></script><script>(function(w,d){;w.zarazData.executed.push("CErT");;w.zarazData.executed.push("iklv");;w.zarazData.executed.push("qjvZ");;w.zarazData.executed.push("Pageview");})(window,document)</script><script>(function(w,d){})(window,document)</script><style id="onetrust-style">#onetrust-banner-sdk .onetrust-vendors-list-handler{cursor:pointer;color:#1f96db;font-size:inherit;font-weight:bold;text-decoration:none;margin-left:5px}#onetrust-banner-sdk .onetrust-vendors-list-handler:hover{color:#1f96db}#onetrust-banner-sdk:focus{outline:2px solid #000;outline-offset:-2px}#onetrust-banner-sdk a:focus{outline:2px solid #000}#onetrust-banner-sdk #onetrust-accept-btn-handler,#onetrust-banner-sdk #onetrust-reject-all-handler,#onetrust-banner-sdk #onetrust-pc-btn-handler{outline-offset:1px}#onetrust-banner-sdk.ot-bnr-w-logo .ot-bnr-logo{height:64px;width:64px}#onetrust-banner-sdk .ot-tcf2-vendor-count.ot-text-bold{font-weight:bold}#onetrust-banner-sdk .ot-close-icon,#onetrust-pc-sdk .ot-close-icon,#ot-sync-ntfy .ot-close-icon{background-size:contain;background-repeat:no-repeat;background-position:center;height:12px;width:12px}#onetrust-banner-sdk .powered-by-logo,#onetrust-banner-sdk .ot-pc-footer-logo a,#onetrust-pc-sdk .powered-by-logo,#onetrust-pc-sdk .ot-pc-footer-logo a,#ot-sync-ntfy .powered-by-logo,#ot-sync-ntfy .ot-pc-footer-logo a{background-size:contain;background-repeat:no-repeat;background-position:center;height:25px;width:152px;display:block;text-decoration:none;font-size:.75em}#onetrust-banner-sdk .powered-by-logo:hover,#onetrust-banner-sdk .ot-pc-footer-logo a:hover,#onetrust-pc-sdk .powered-by-logo:hover,#onetrust-pc-sdk .ot-pc-footer-logo a:hover,#ot-sync-ntfy .powered-by-logo:hover,#ot-sync-ntfy .ot-pc-footer-logo a:hover{color:#565656}#onetrust-banner-sdk h3 *,#onetrust-banner-sdk h4 *,#onetrust-banner-sdk h6 *,#onetrust-banner-sdk button *,#onetrust-banner-sdk a[data-parent-id] *,#onetrust-pc-sdk h3 *,#onetrust-pc-sdk h4 *,#onetrust-pc-sdk h6 *,#onetrust-pc-sdk button *,#onetrust-pc-sdk a[data-parent-id] *,#ot-sync-ntfy h3 *,#ot-sync-ntfy h4 *,#ot-sync-ntfy h6 *,#ot-sync-ntfy button *,#ot-sync-ntfy a[data-parent-id] *{font-size:inherit;font-weight:inherit;color:inherit}#onetrust-banner-sdk .ot-hide,#onetrust-pc-sdk .ot-hide,#ot-sync-ntfy .ot-hide{display:none !important}#onetrust-banner-sdk button.ot-link-btn:hover,#onetrust-pc-sdk button.ot-link-btn:hover,#ot-sync-ntfy button.ot-link-btn:hover{text-decoration:underline;opacity:1}#onetrust-pc-sdk .ot-sdk-row .ot-sdk-column{padding:0}#onetrust-pc-sdk .ot-sdk-container{padding-right:0}#onetrust-pc-sdk .ot-sdk-row{flex-direction:initial;width:100%}#onetrust-pc-sdk [type=checkbox]:checked,#onetrust-pc-sdk [type=checkbox]:not(:checked){pointer-events:initial}#onetrust-pc-sdk [type=checkbox]:disabled+label::before,#onetrust-pc-sdk [type=checkbox]:disabled+label:after,#onetrust-pc-sdk [type=checkbox]:disabled+label{pointer-events:none;opacity:.7}#onetrust-pc-sdk #vendor-list-content{transform:translate3d(0, 0, 0)}#onetrust-pc-sdk li input[type=checkbox]{z-index:1}#onetrust-pc-sdk li .ot-checkbox label{z-index:2}#onetrust-pc-sdk li .ot-checkbox input[type=checkbox]{height:auto;width:auto}#onetrust-pc-sdk li .host-title a,#onetrust-pc-sdk li .ot-host-name a,#onetrust-pc-sdk li .accordion-text,#onetrust-pc-sdk li .ot-acc-txt{z-index:2;position:relative}#onetrust-pc-sdk input{margin:3px .1ex}#onetrust-pc-sdk .pc-logo,#onetrust-pc-sdk .ot-pc-logo{height:60px;width:180px;background-position:center;background-size:contain;background-repeat:no-repeat;display:inline-flex;justify-content:center;align-items:center}#onetrust-pc-sdk .pc-logo img,#onetrust-pc-sdk .ot-pc-logo img{max-height:100%;max-width:100%}#onetrust-pc-sdk .screen-reader-only,#onetrust-pc-sdk .ot-scrn-rdr,.ot-sdk-cookie-policy .screen-reader-only,.ot-sdk-cookie-policy .ot-scrn-rdr{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}#onetrust-pc-sdk.ot-fade-in,.onetrust-pc-dark-filter.ot-fade-in,#onetrust-banner-sdk.ot-fade-in{animation-name:onetrust-fade-in;animation-duration:400ms;animation-timing-function:ease-in-out}#onetrust-pc-sdk.ot-hide{display:none !important}.onetrust-pc-dark-filter.ot-hide{display:none !important}#ot-sdk-btn.ot-sdk-show-settings,#ot-sdk-btn.optanon-show-settings{color:#68b631;border:1px solid #68b631;height:auto;white-space:normal;word-wrap:break-word;padding:.8em 2em;font-size:.8em;line-height:1.2;cursor:pointer;-moz-transition:.1s ease;-o-transition:.1s ease;-webkit-transition:1s ease;transition:.1s ease}#ot-sdk-btn.ot-sdk-show-settings:hover,#ot-sdk-btn.optanon-show-settings:hover{color:#fff;background-color:#68b631}.onetrust-pc-dark-filter{background:rgba(0,0,0,.5);z-index:2147483646;width:100%;height:100%;overflow:hidden;position:fixed;top:0;bottom:0;left:0}@keyframes onetrust-fade-in{0%{opacity:0}100%{opacity:1}}.ot-cookie-label{text-decoration:underline}@media only screen and (min-width: 426px)and (max-width: 896px)and (orientation: landscape){#onetrust-pc-sdk p{font-size:.75em}}#onetrust-banner-sdk .banner-option-input:focus+label{outline:1px solid #000;outline-style:auto}.category-vendors-list-handler+a:focus,.category-vendors-list-handler+a:focus-visible{outline:2px solid #000}#onetrust-pc-sdk .ot-userid-title{margin-top:10px}#onetrust-pc-sdk .ot-userid-title>span,#onetrust-pc-sdk .ot-userid-timestamp>span{font-weight:700}#onetrust-pc-sdk .ot-userid-desc{font-style:italic}#onetrust-pc-sdk .ot-host-desc a{pointer-events:initial}#onetrust-pc-sdk .ot-ven-hdr>p a{position:relative;z-index:2;pointer-events:initial}#onetrust-pc-sdk .ot-vnd-serv .ot-vnd-item .ot-vnd-info a,#onetrust-pc-sdk .ot-vs-list .ot-vnd-item .ot-vnd-info a{margin-right:auto}#onetrust-pc-sdk .ot-pc-footer-logo img{width:136px;height:16px}#onetrust-pc-sdk .ot-pur-vdr-count{font-weight:400;font-size:.7rem;padding-top:3px;display:block}#onetrust-banner-sdk .ot-optout-signal,#onetrust-pc-sdk .ot-optout-signal{border:1px solid #32ae88;border-radius:3px;padding:5px;margin-bottom:10px;background-color:#f9fffa;font-size:.85rem;line-height:2}#onetrust-banner-sdk .ot-optout-signal .ot-optout-icon,#onetrust-pc-sdk .ot-optout-signal .ot-optout-icon{display:inline;margin-right:5px}#onetrust-banner-sdk .ot-optout-signal svg,#onetrust-pc-sdk .ot-optout-signal svg{height:20px;width:30px;transform:scale(0.5)}#onetrust-banner-sdk .ot-optout-signal svg path,#onetrust-pc-sdk .ot-optout-signal svg path{fill:#32ae88}#onetrust-consent-sdk .ot-general-modal{overflow:hidden;position:fixed;margin:0 auto;top:50%;left:50%;width:40%;padding:1.5rem;max-width:575px;min-width:575px;z-index:2147483647;border-radius:2.5px;transform:translate(-50%, -50%)}#onetrust-consent-sdk .ot-signature-health-group{margin-top:1rem;padding-left:1.25rem;padding-right:1.25rem;margin-bottom:.625rem;width:calc(100% - 2.5rem)}#onetrust-consent-sdk .ot-signature-health-group .ot-signature-health-form{gap:.5rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-health-form{width:70%;gap:.35rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-input{height:38px;padding:6px 10px;background-color:#fff;border:1px solid #d1d1d1;border-radius:4px;box-shadow:none;box-sizing:border-box}#onetrust-consent-sdk .ot-signature-health .ot-signature-subtitle{font-size:1.125rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-group-title{font-size:1.25rem;font-weight:bold}#onetrust-consent-sdk .ot-signature-health,#onetrust-consent-sdk .ot-signature-health-group{display:flex;flex-direction:column;gap:1rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-cont,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-cont{display:flex;flex-direction:column;gap:.25rem}#onetrust-consent-sdk .ot-signature-health .ot-signature-paragraph,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-paragraph{margin:0;line-height:20px;font-size:max(14px,.875rem)}#onetrust-consent-sdk .ot-signature-health .ot-health-signature-error,#onetrust-consent-sdk .ot-signature-health-group .ot-health-signature-error{color:#4d4d4d;font-size:min(12px,.75rem)}#onetrust-consent-sdk .ot-signature-health .ot-signature-buttons-cont,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-buttons-cont{margin-top:max(.75rem,2%);gap:1rem;display:flex;justify-content:flex-end}#onetrust-consent-sdk .ot-signature-health .ot-signature-button,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-button{flex:1;height:auto;color:#fff;cursor:pointer;line-height:1.2;min-width:125px;font-weight:600;font-size:.813em;border-radius:2px;padding:12px 10px;white-space:normal;word-wrap:break-word;word-break:break-word;background-color:#68b631;border:2px solid #68b631}#onetrust-consent-sdk .ot-signature-health .ot-signature-button.reject,#onetrust-consent-sdk .ot-signature-health-group .ot-signature-button.reject{background-color:#fff}#onetrust-consent-sdk .ot-input-field-cont{display:flex;flex-direction:column;gap:.5rem}#onetrust-consent-sdk .ot-input-field-cont .ot-signature-input{width:65%}#onetrust-consent-sdk .ot-signature-health-form{display:flex;flex-direction:column}#onetrust-consent-sdk .ot-signature-health-form .ot-signature-label{margin-bottom:0;line-height:20px;font-size:max(14px,.875rem)}@media only screen and (max-width: 600px){#onetrust-consent-sdk .ot-general-modal{min-width:100%}#onetrust-consent-sdk .ot-signature-health .ot-signature-health-form{width:100%}#onetrust-consent-sdk .ot-input-field-cont .ot-signature-input{width:100%}}#onetrust-banner-sdk,#onetrust-pc-sdk,#ot-sdk-cookie-policy,#ot-sync-ntfy{font-size:16px}#onetrust-banner-sdk *,#onetrust-banner-sdk ::after,#onetrust-banner-sdk ::before,#onetrust-pc-sdk *,#onetrust-pc-sdk ::after,#onetrust-pc-sdk ::before,#ot-sdk-cookie-policy *,#ot-sdk-cookie-policy ::after,#ot-sdk-cookie-policy ::before,#ot-sync-ntfy *,#ot-sync-ntfy ::after,#ot-sync-ntfy ::before{-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}#onetrust-banner-sdk div,#onetrust-banner-sdk span,#onetrust-banner-sdk h1,#onetrust-banner-sdk h2,#onetrust-banner-sdk h3,#onetrust-banner-sdk h4,#onetrust-banner-sdk h5,#onetrust-banner-sdk h6,#onetrust-banner-sdk p,#onetrust-banner-sdk img,#onetrust-banner-sdk svg,#onetrust-banner-sdk button,#onetrust-banner-sdk section,#onetrust-banner-sdk a,#onetrust-banner-sdk label,#onetrust-banner-sdk input,#onetrust-banner-sdk ul,#onetrust-banner-sdk li,#onetrust-banner-sdk nav,#onetrust-banner-sdk table,#onetrust-banner-sdk thead,#onetrust-banner-sdk tr,#onetrust-banner-sdk td,#onetrust-banner-sdk tbody,#onetrust-banner-sdk .ot-main-content,#onetrust-banner-sdk .ot-toggle,#onetrust-banner-sdk #ot-content,#onetrust-banner-sdk #ot-pc-content,#onetrust-banner-sdk .checkbox,#onetrust-pc-sdk div,#onetrust-pc-sdk span,#onetrust-pc-sdk h1,#onetrust-pc-sdk h2,#onetrust-pc-sdk h3,#onetrust-pc-sdk h4,#onetrust-pc-sdk h5,#onetrust-pc-sdk h6,#onetrust-pc-sdk p,#onetrust-pc-sdk img,#onetrust-pc-sdk svg,#onetrust-pc-sdk button,#onetrust-pc-sdk section,#onetrust-pc-sdk a,#onetrust-pc-sdk label,#onetrust-pc-sdk input,#onetrust-pc-sdk ul,#onetrust-pc-sdk li,#onetrust-pc-sdk nav,#onetrust-pc-sdk table,#onetrust-pc-sdk thead,#onetrust-pc-sdk tr,#onetrust-pc-sdk td,#onetrust-pc-sdk tbody,#onetrust-pc-sdk .ot-main-content,#onetrust-pc-sdk .ot-toggle,#onetrust-pc-sdk #ot-content,#onetrust-pc-sdk #ot-pc-content,#onetrust-pc-sdk .checkbox,#ot-sdk-cookie-policy div,#ot-sdk-cookie-policy span,#ot-sdk-cookie-policy h1,#ot-sdk-cookie-policy h2,#ot-sdk-cookie-policy h3,#ot-sdk-cookie-policy h4,#ot-sdk-cookie-policy h5,#ot-sdk-cookie-policy h6,#ot-sdk-cookie-policy p,#ot-sdk-cookie-policy img,#ot-sdk-cookie-policy svg,#ot-sdk-cookie-policy button,#ot-sdk-cookie-policy section,#ot-sdk-cookie-policy a,#ot-sdk-cookie-policy label,#ot-sdk-cookie-policy input,#ot-sdk-cookie-policy ul,#ot-sdk-cookie-policy li,#ot-sdk-cookie-policy nav,#ot-sdk-cookie-policy table,#ot-sdk-cookie-policy thead,#ot-sdk-cookie-policy tr,#ot-sdk-cookie-policy td,#ot-sdk-cookie-policy tbody,#ot-sdk-cookie-policy .ot-main-content,#ot-sdk-cookie-policy .ot-toggle,#ot-sdk-cookie-policy #ot-content,#ot-sdk-cookie-policy #ot-pc-content,#ot-sdk-cookie-policy .checkbox,#ot-sync-ntfy div,#ot-sync-ntfy span,#ot-sync-ntfy h1,#ot-sync-ntfy h2,#ot-sync-ntfy h3,#ot-sync-ntfy h4,#ot-sync-ntfy h5,#ot-sync-ntfy h6,#ot-sync-ntfy p,#ot-sync-ntfy img,#ot-sync-ntfy svg,#ot-sync-ntfy button,#ot-sync-ntfy section,#ot-sync-ntfy a,#ot-sync-ntfy label,#ot-sync-ntfy input,#ot-sync-ntfy ul,#ot-sync-ntfy li,#ot-sync-ntfy nav,#ot-sync-ntfy table,#ot-sync-ntfy thead,#ot-sync-ntfy tr,#ot-sync-ntfy td,#ot-sync-ntfy tbody,#ot-sync-ntfy .ot-main-content,#ot-sync-ntfy .ot-toggle,#ot-sync-ntfy #ot-content,#ot-sync-ntfy #ot-pc-content,#ot-sync-ntfy .checkbox{font-family:inherit;font-weight:normal;-webkit-font-smoothing:auto;letter-spacing:normal;line-height:normal;padding:0;margin:0;height:auto;min-height:0;max-height:none;width:auto;min-width:0;max-width:none;border-radius:0;border:none;clear:none;float:none;position:static;bottom:auto;left:auto;right:auto;top:auto;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;white-space:normal;background:none;overflow:visible;vertical-align:baseline;visibility:visible;z-index:auto;box-shadow:none}#onetrust-banner-sdk label:before,#onetrust-banner-sdk label:after,#onetrust-banner-sdk .checkbox:after,#onetrust-banner-sdk .checkbox:before,#onetrust-pc-sdk label:before,#onetrust-pc-sdk label:after,#onetrust-pc-sdk .checkbox:after,#onetrust-pc-sdk .checkbox:before,#ot-sdk-cookie-policy label:before,#ot-sdk-cookie-policy label:after,#ot-sdk-cookie-policy .checkbox:after,#ot-sdk-cookie-policy .checkbox:before,#ot-sync-ntfy label:before,#ot-sync-ntfy label:after,#ot-sync-ntfy .checkbox:after,#ot-sync-ntfy .checkbox:before{content:"";content:none}#onetrust-banner-sdk .ot-sdk-container,#onetrust-pc-sdk .ot-sdk-container,#ot-sdk-cookie-policy .ot-sdk-container{position:relative;width:100%;max-width:100%;margin:0 auto;padding:0 20px;box-sizing:border-box}#onetrust-banner-sdk .ot-sdk-column,#onetrust-banner-sdk .ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-column,#onetrust-pc-sdk .ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-column,#ot-sdk-cookie-policy .ot-sdk-columns{width:100%;float:left;box-sizing:border-box;padding:0;display:initial}@media(min-width: 400px){#onetrust-banner-sdk .ot-sdk-container,#onetrust-pc-sdk .ot-sdk-container,#ot-sdk-cookie-policy .ot-sdk-container{width:90%;padding:0}}@media(min-width: 550px){#onetrust-banner-sdk .ot-sdk-container,#onetrust-pc-sdk .ot-sdk-container,#ot-sdk-cookie-policy .ot-sdk-container{width:100%}#onetrust-banner-sdk .ot-sdk-column,#onetrust-banner-sdk .ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-column,#onetrust-pc-sdk .ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-column,#ot-sdk-cookie-policy .ot-sdk-columns{margin-left:4%}#onetrust-banner-sdk .ot-sdk-column:first-child,#onetrust-banner-sdk .ot-sdk-columns:first-child,#onetrust-pc-sdk .ot-sdk-column:first-child,#onetrust-pc-sdk .ot-sdk-columns:first-child,#ot-sdk-cookie-policy .ot-sdk-column:first-child,#ot-sdk-cookie-policy .ot-sdk-columns:first-child{margin-left:0}#onetrust-banner-sdk .ot-sdk-two.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-two.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-two.ot-sdk-columns{width:13.3333333333%}#onetrust-banner-sdk .ot-sdk-three.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-three.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-three.ot-sdk-columns{width:22%}#onetrust-banner-sdk .ot-sdk-four.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-four.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-four.ot-sdk-columns{width:30.6666666667%}#onetrust-banner-sdk .ot-sdk-eight.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-eight.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-eight.ot-sdk-columns{width:65.3333333333%}#onetrust-banner-sdk .ot-sdk-nine.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-nine.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-nine.ot-sdk-columns{width:74%}#onetrust-banner-sdk .ot-sdk-ten.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-ten.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-ten.ot-sdk-columns{width:82.6666666667%}#onetrust-banner-sdk .ot-sdk-eleven.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-eleven.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-eleven.ot-sdk-columns{width:91.3333333333%}#onetrust-banner-sdk .ot-sdk-twelve.ot-sdk-columns,#onetrust-pc-sdk .ot-sdk-twelve.ot-sdk-columns,#ot-sdk-cookie-policy .ot-sdk-twelve.ot-sdk-columns{width:100%;margin-left:0}}#onetrust-banner-sdk h1,#onetrust-banner-sdk h2,#onetrust-banner-sdk h3,#onetrust-banner-sdk h4,#onetrust-banner-sdk h5,#onetrust-banner-sdk h6,#onetrust-pc-sdk h1,#onetrust-pc-sdk h2,#onetrust-pc-sdk h3,#onetrust-pc-sdk h4,#onetrust-pc-sdk h5,#onetrust-pc-sdk h6,#ot-sdk-cookie-policy h1,#ot-sdk-cookie-policy h2,#ot-sdk-cookie-policy h3,#ot-sdk-cookie-policy h4,#ot-sdk-cookie-policy h5,#ot-sdk-cookie-policy h6{margin-top:0;font-weight:600;font-family:inherit}#onetrust-banner-sdk h1,#onetrust-pc-sdk h1,#ot-sdk-cookie-policy h1{font-size:1.5rem;line-height:1.2}#onetrust-banner-sdk h2,#onetrust-pc-sdk h2,#ot-sdk-cookie-policy h2{font-size:1.5rem;line-height:1.25}#onetrust-banner-sdk h3,#onetrust-pc-sdk h3,#ot-sdk-cookie-policy h3{font-size:1.5rem;line-height:1.3}#onetrust-banner-sdk h4,#onetrust-pc-sdk h4,#ot-sdk-cookie-policy h4{font-size:1.5rem;line-height:1.35}#onetrust-banner-sdk h5,#onetrust-pc-sdk h5,#ot-sdk-cookie-policy h5{font-size:1.5rem;line-height:1.5}#onetrust-banner-sdk h6,#onetrust-pc-sdk h6,#ot-sdk-cookie-policy h6{font-size:1.5rem;line-height:1.6}@media(min-width: 550px){#onetrust-banner-sdk h1,#onetrust-pc-sdk h1,#ot-sdk-cookie-policy h1{font-size:1.5rem}#onetrust-banner-sdk h2,#onetrust-pc-sdk h2,#ot-sdk-cookie-policy h2{font-size:1.5rem}#onetrust-banner-sdk h3,#onetrust-pc-sdk h3,#ot-sdk-cookie-policy h3{font-size:1.5rem}#onetrust-banner-sdk h4,#onetrust-pc-sdk h4,#ot-sdk-cookie-policy h4{font-size:1.5rem}#onetrust-banner-sdk h5,#onetrust-pc-sdk h5,#ot-sdk-cookie-policy h5{font-size:1.5rem}#onetrust-banner-sdk h6,#onetrust-pc-sdk h6,#ot-sdk-cookie-policy h6{font-size:1.5rem}}#onetrust-banner-sdk p,#onetrust-pc-sdk p,#ot-sdk-cookie-policy p{margin:0 0 1em 0;font-family:inherit;line-height:normal}#onetrust-banner-sdk a,#onetrust-pc-sdk a,#ot-sdk-cookie-policy a{color:#565656;text-decoration:underline}#onetrust-banner-sdk a:hover,#onetrust-pc-sdk a:hover,#ot-sdk-cookie-policy a:hover{color:#565656;text-decoration:none}#onetrust-banner-sdk .ot-sdk-button,#onetrust-banner-sdk button,#onetrust-pc-sdk .ot-sdk-button,#onetrust-pc-sdk button,#ot-sdk-cookie-policy .ot-sdk-button,#ot-sdk-cookie-policy button{margin-bottom:1rem;font-family:inherit}#onetrust-banner-sdk .ot-sdk-button,#onetrust-banner-sdk button,#onetrust-pc-sdk .ot-sdk-button,#onetrust-pc-sdk button,#ot-sdk-cookie-policy .ot-sdk-button,#ot-sdk-cookie-policy button{display:inline-block;height:38px;padding:0 30px;color:#555;text-align:center;font-size:.9em;font-weight:400;line-height:38px;letter-spacing:.01em;text-decoration:none;white-space:nowrap;background-color:rgba(0,0,0,0);border-radius:2px;border:1px solid #bbb;cursor:pointer;box-sizing:border-box}#onetrust-banner-sdk .ot-sdk-button:hover,#onetrust-banner-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):hover,#onetrust-banner-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):focus,#onetrust-pc-sdk .ot-sdk-button:hover,#onetrust-pc-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):hover,#onetrust-pc-sdk :not(.ot-leg-btn-container)>button:not(.ot-link-btn):focus,#ot-sdk-cookie-policy .ot-sdk-button:hover,#ot-sdk-cookie-policy :not(.ot-leg-btn-container)>button:not(.ot-link-btn):hover,#ot-sdk-cookie-policy :not(.ot-leg-btn-container)>button:not(.ot-link-btn):focus{color:#333;border-color:#888;opacity:.7}#onetrust-banner-sdk .ot-sdk-button:focus,#onetrust-banner-sdk :not(.ot-leg-btn-container)>button:focus,#onetrust-pc-sdk .ot-sdk-button:focus,#onetrust-pc-sdk :not(.ot-leg-btn-container)>button:focus,#ot-sdk-cookie-policy .ot-sdk-button:focus,#ot-sdk-cookie-policy :not(.ot-leg-btn-container)>button:focus{outline:2px solid #000}#onetrust-banner-sdk .ot-sdk-button.ot-sdk-button-primary,#onetrust-banner-sdk button.ot-sdk-button-primary,#onetrust-banner-sdk input[type=submit].ot-sdk-button-primary,#onetrust-banner-sdk input[type=reset].ot-sdk-button-primary,#onetrust-banner-sdk input[type=button].ot-sdk-button-primary,#onetrust-pc-sdk .ot-sdk-button.ot-sdk-button-primary,#onetrust-pc-sdk button.ot-sdk-button-primary,#onetrust-pc-sdk input[type=submit].ot-sdk-button-primary,#onetrust-pc-sdk input[type=reset].ot-sdk-button-primary,#onetrust-pc-sdk input[type=button].ot-sdk-button-primary,#ot-sdk-cookie-policy .ot-sdk-button.ot-sdk-button-primary,#ot-sdk-cookie-policy button.ot-sdk-button-primary,#ot-sdk-cookie-policy input[type=submit].ot-sdk-button-primary,#ot-sdk-cookie-policy input[type=reset].ot-sdk-button-primary,#ot-sdk-cookie-policy input[type=button].ot-sdk-button-primary{color:#fff;background-color:#33c3f0;border-color:#33c3f0}#onetrust-banner-sdk .ot-sdk-button.ot-sdk-button-primary:hover,#onetrust-banner-sdk button.ot-sdk-button-primary:hover,#onetrust-banner-sdk input[type=submit].ot-sdk-button-primary:hover,#onetrust-banner-sdk input[type=reset].ot-sdk-button-primary:hover,#onetrust-banner-sdk input[type=button].ot-sdk-button-primary:hover,#onetrust-banner-sdk .ot-sdk-button.ot-sdk-button-primary:focus,#onetrust-banner-sdk button.ot-sdk-button-primary:focus,#onetrust-banner-sdk input[type=submit].ot-sdk-button-primary:focus,#onetrust-banner-sdk input[type=reset].ot-sdk-button-primary:focus,#onetrust-banner-sdk input[type=button].ot-sdk-button-primary:focus,#onetrust-pc-sdk .ot-sdk-button.ot-sdk-button-primary:hover,#onetrust-pc-sdk button.ot-sdk-button-primary:hover,#onetrust-pc-sdk input[type=submit].ot-sdk-button-primary:hover,#onetrust-pc-sdk input[type=reset].ot-sdk-button-primary:hover,#onetrust-pc-sdk input[type=button].ot-sdk-button-primary:hover,#onetrust-pc-sdk .ot-sdk-button.ot-sdk-button-primary:focus,#onetrust-pc-sdk button.ot-sdk-button-primary:focus,#onetrust-pc-sdk input[type=submit].ot-sdk-button-primary:focus,#onetrust-pc-sdk input[type=reset].ot-sdk-button-primary:focus,#onetrust-pc-sdk input[type=button].ot-sdk-button-primary:focus,#ot-sdk-cookie-policy .ot-sdk-button.ot-sdk-button-primary:hover,#ot-sdk-cookie-policy button.ot-sdk-button-primary:hover,#ot-sdk-cookie-policy input[type=submit].ot-sdk-button-primary:hover,#ot-sdk-cookie-policy input[type=reset].ot-sdk-button-primary:hover,#ot-sdk-cookie-policy input[type=button].ot-sdk-button-primary:hover,#ot-sdk-cookie-policy .ot-sdk-button.ot-sdk-button-primary:focus,#ot-sdk-cookie-policy button.ot-sdk-button-primary:focus,#ot-sdk-cookie-policy input[type=submit].ot-sdk-button-primary:focus,#ot-sdk-cookie-policy input[type=reset].ot-sdk-button-primary:focus,#ot-sdk-cookie-policy input[type=button].ot-sdk-button-primary:focus{color:#fff;background-color:#1eaedb;border-color:#1eaedb}#onetrust-banner-sdk input[type=text],#onetrust-pc-sdk input[type=text],#ot-sdk-cookie-policy input[type=text]{height:38px;padding:6px 10px;background-color:#fff;border:1px solid #d1d1d1;border-radius:4px;box-shadow:none;box-sizing:border-box}#onetrust-banner-sdk input[type=text],#onetrust-pc-sdk input[type=text],#ot-sdk-cookie-policy input[type=text]{-webkit-appearance:none;-moz-appearance:none;appearance:none}#onetrust-banner-sdk input[type=text]:focus,#onetrust-pc-sdk input[type=text]:focus,#ot-sdk-cookie-policy input[type=text]:focus{border:1px solid #000;outline:0}#onetrust-banner-sdk label,#onetrust-pc-sdk label,#ot-sdk-cookie-policy label{display:block;margin-bottom:.5rem;font-weight:600}#onetrust-banner-sdk input[type=checkbox],#onetrust-pc-sdk input[type=checkbox],#ot-sdk-cookie-policy input[type=checkbox]{display:inline}#onetrust-banner-sdk ul,#onetrust-pc-sdk ul,#ot-sdk-cookie-policy ul{list-style:circle inside}#onetrust-banner-sdk ul,#onetrust-pc-sdk ul,#ot-sdk-cookie-policy ul{padding-left:0;margin-top:0}#onetrust-banner-sdk ul ul,#onetrust-pc-sdk ul ul,#ot-sdk-cookie-policy ul ul{margin:1.5rem 0 1.5rem 3rem;font-size:90%}#onetrust-banner-sdk li,#onetrust-pc-sdk li,#ot-sdk-cookie-policy li{margin-bottom:1rem}#onetrust-banner-sdk th,#onetrust-banner-sdk td,#onetrust-pc-sdk th,#onetrust-pc-sdk td,#ot-sdk-cookie-policy th,#ot-sdk-cookie-policy td{padding:12px 15px;text-align:left;border-bottom:1px solid #e1e1e1}#onetrust-banner-sdk button,#onetrust-pc-sdk button,#ot-sdk-cookie-policy button{margin-bottom:1rem;font-family:inherit}#onetrust-banner-sdk .ot-sdk-container:after,#onetrust-banner-sdk .ot-sdk-row:after,#onetrust-pc-sdk .ot-sdk-container:after,#onetrust-pc-sdk .ot-sdk-row:after,#ot-sdk-cookie-policy .ot-sdk-container:after,#ot-sdk-cookie-policy .ot-sdk-row:after{content:"";display:table;clear:both}#onetrust-banner-sdk .ot-sdk-row,#onetrust-pc-sdk .ot-sdk-row,#ot-sdk-cookie-policy .ot-sdk-row{margin:0;max-width:none;display:block}.ot-sdk-cookie-policy{font-family:inherit;font-size:16px}.ot-sdk-cookie-policy.otRelFont{font-size:1rem}.ot-sdk-cookie-policy h3,.ot-sdk-cookie-policy h4,.ot-sdk-cookie-policy h6,.ot-sdk-cookie-policy p,.ot-sdk-cookie-policy li,.ot-sdk-cookie-policy a,.ot-sdk-cookie-policy th,.ot-sdk-cookie-policy #cookie-policy-description,.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group,.ot-sdk-cookie-policy #cookie-policy-title{color:dimgray}.ot-sdk-cookie-policy #cookie-policy-description{margin-bottom:1em}.ot-sdk-cookie-policy h4{font-size:1.2em}.ot-sdk-cookie-policy h6{font-size:1em;margin-top:2em}.ot-sdk-cookie-policy th{min-width:75px}.ot-sdk-cookie-policy a,.ot-sdk-cookie-policy a:hover{background:#fff}.ot-sdk-cookie-policy thead{background-color:#f6f6f4;font-weight:bold}.ot-sdk-cookie-policy .ot-mobile-border{display:none}.ot-sdk-cookie-policy section{margin-bottom:2em}.ot-sdk-cookie-policy table{border-collapse:inherit}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy{font-family:inherit;font-size:1rem}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h3,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h4,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h6,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy p,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy li,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-title{color:dimgray}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description{margin-bottom:1em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-subgroup{margin-left:1.5em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group-desc,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-table-header,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy span,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td{font-size:.9em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td span,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td a{font-size:inherit}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group{font-size:1em;margin-bottom:.6em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-title{margin-bottom:1.2em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy>section{margin-bottom:1em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th{min-width:75px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a:hover{background:#fff}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy thead{background-color:#f6f6f4;font-weight:bold}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-mobile-border{display:none}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy section{margin-bottom:2em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-subgroup ul li{list-style:disc;margin-left:1.5em}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-subgroup ul li h4{display:inline-block}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table{border-collapse:inherit;margin:auto;border:1px solid #d7d7d7;border-radius:5px;border-spacing:initial;width:100%;overflow:hidden}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table th,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table td{border-bottom:1px solid #d7d7d7;border-right:1px solid #d7d7d7}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr:last-child td{border-bottom:0px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr th:last-child,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr td:last-child{border-right:0px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-host,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-cookies-type{width:25%}.ot-sdk-cookie-policy[dir=rtl]{text-align:left}#ot-sdk-cookie-policy h3{font-size:1.5em}@media only screen and (max-width: 530px){.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) table,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) thead,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tbody,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) th,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td,.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr{display:block}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) thead tr{position:absolute;top:-9999px;left:-9999px}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr{margin:0 0 1em 0}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr:nth-child(odd),.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) tr:nth-child(odd) a{background:#f6f6f4}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:50%}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td:before{position:absolute;height:100%;left:6px;width:40%;padding-right:10px}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) .ot-mobile-border{display:inline-block;background-color:#e4e4e4;position:absolute;height:100%;top:0;left:45%;width:2px}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) td:before{content:attr(data-label);font-weight:bold}.ot-sdk-cookie-policy:not(#ot-sdk-cookie-policy-v2) li{word-break:break-word;word-wrap:break-word}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table{overflow:hidden}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table td{border:none;border-bottom:1px solid #d7d7d7}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy thead,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy tbody,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy tr{display:block}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-host,#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table .ot-cookies-type{width:auto}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy tr{margin:0 0 1em 0}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td:before{height:100%;width:40%;padding-right:10px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td:before{content:attr(data-label);font-weight:bold}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy li{word-break:break-word;word-wrap:break-word}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy thead tr{position:absolute;top:-9999px;left:-9999px;z-index:-9999}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr:last-child td{border-bottom:1px solid #d7d7d7;border-right:0px}#ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table tr:last-child td:last-child{border-bottom:0px}}
                
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h5,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy h6,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy li,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy p,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy a,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy span,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy td,
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-description {
                        color: #404242;
                    }
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy th {
                        color: #404242;
                    }
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy .ot-sdk-cookie-policy-group {
                        color: #404242;
                    }
                    
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy #cookie-policy-title {
                            color: #404242;
                        }
                    
            
                    #ot-sdk-cookie-policy-v2.ot-sdk-cookie-policy table th {
                            background-color: #F8F8F8;
                        }
                    
            .ot-floating-button__front{background-image:url('https://ot.www.cloudflare.com/public/vendor/onetrust/consent/b1e05d49-f072-4bae-9116-bdb78af15448/018debfb-4ca4-7537-992d-44786afb66f9/logos/static/ot_persistent_cookie_icon.png')}</style></head><body class="vsc-initialized"><astro-island uid="1uuOW1" component-url="/_astro/GoogleAnalytics.DSjxwi8U.js" component-export="GoogleAnalytics" renderer-url="/_astro/client.DLO1yDVm.js" props="{&quot;title&quot;:[0,&quot;How to execute an object file: part 4, AArch64 edition&quot;],&quot;canonical&quot;:[0,&quot;https://blog.cloudflare.com/how-to-execute-an-object-file-part-4&quot;],&quot;info&quot;:[0,{&quot;id&quot;:[0,&quot;6bGK0NoXnHBGOjKvJ60FRu&quot;],&quot;title&quot;:[0,&quot;How to execute an object file: part 4, AArch64 edition&quot;],&quot;slug&quot;:[0,&quot;how-to-execute-an-object-file-part-4&quot;],&quot;excerpt&quot;:[0,&quot;The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;\n            &lt;figure class=\&quot;kg-card kg-image-card \&quot;&gt;\n            \n            &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5Ih4pvbZshdUy2ihfodYAU/7800842ad2c0270609b36a8a99d0ceb4/image1-1.png\&quot; alt=\&quot;How to execute an object file: part 4, AArch64 edition\&quot; class=\&quot;kg-image\&quot; width=\&quot;1999\&quot; height=\&quot;1125\&quot; loading=\&quot;lazy\&quot;/&gt;\n            \n            &lt;/figure&gt;&lt;p&gt;Translating source code written in a high-level programming language into an executable binary typically involves a series of steps, namely compiling and assembling the code into object files, and then linking those object files into the final executable. However, there are certain scenarios where it can be useful to apply an alternate approach that involves executing object files directly, bypassing the linker. For example, we might use it for malware analysis or when part of the code requires an incompatible compiler. We’ll be focusing on the latter scenario: when one of our libraries needed to be compiled differently from the rest of the code. Learning how to execute an object file directly will give you a much better sense of how code is compiled and linked together.&lt;/p&gt;&lt;p&gt;To demonstrate how this was done, we have previously published a series of posts on executing an object file:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;a href=\&quot;/how-to-execute-an-object-file-part-1/\&quot;&gt;How to execute an object file: Part 1&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;How to execute an object file: Part 2&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=\&quot;/how-to-execute-an-object-file-part-3/\&quot;&gt;How to execute an object file: Part 3&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;The initial posts are dedicated to the x86 architecture. Since then the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture. You can pause here to read the previous blog posts before proceeding with this one, or read through the brief summary below and reference the earlier posts for more detail. We might reiterate some theory as working with ELF files can be daunting, if it’s not your day-to-day routine. Also, please be mindful that for simplicity, these examples omit bounds and integrity checks. Let the journey begin!&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;introduction\&quot;&gt;Introduction&lt;/h2&gt;\n            &lt;a href=\&quot;#introduction\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;In order to obtain an object file or an executable binary from a high-level compiled programming language the code needs to be processed by three components: compiler, assembler and linker. The compiler generates an assembly listing. This assembly listing is picked up by the assembler and translated into an object file. All source files, if a program contains multiple, go through these two steps generating an object file for each source file. At the final step the linker unites all object files into one binary, additionally resolving references to the shared libraries (i.e. we don’t implement the &lt;code&gt;printf&lt;/code&gt; function each time, rather we take it from a system library). Even though the approach is platform independent, the compiler output varies by platform as the assembly listing is closely tied to the CPU architecture.&lt;/p&gt;&lt;p&gt;GCC (GNU Compiler Collection) can run each step: compiler, assembler and linker separately for us:&lt;/p&gt;&lt;p&gt;main.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;#include &amp;lt;stdio.h&amp;gt;\n\nint main(void)\n{\n\tputs(&amp;quot;Hello, world!&amp;quot;);\n\treturn 0;\n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compiler (output &lt;code&gt;main.s&lt;/code&gt; - assembly listing):&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -S main.c\n$ ls\nmain.c  main.s&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Assembler (output &lt;code&gt;main.o&lt;/code&gt; - an object file):&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -c main.s -o main.o\n$ ls\nmain.c  main.o  main.s&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Linker (&lt;code&gt;main&lt;/code&gt; - an object file):&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc main.o -o main\n$ ls\nmain  main.c  main.o  main.s\n$ ./main\nHello, world!&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;All the examples assume gcc is running on a native aarch64 architecture or include a cross compilation flag for those who want to reproduce and have no aarch64.&lt;/p&gt;&lt;p&gt;We have two object files in the output above: &lt;code&gt;main.o&lt;/code&gt; and &lt;code&gt;main&lt;/code&gt;. Object files are files encoded with the &lt;a href=\&quot;https://en.wikipedia.org/wiki/Executable_and_Linkable_Format\&quot;&gt;ELF (Executable and Linkable Format)&lt;/a&gt; standard. Although, &lt;code&gt;main.o&lt;/code&gt; is an ELF file, it doesn’t contain all the information to be fully executable.&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ file main.o\nmain.o: ELF 64-bit LSB relocatable, ARM aarch64, version 1 (SYSV), not stripped\n\n$ file main\nmain: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically\nlinked, interpreter /lib/ld-linux-aarch64.so.1,\nBuildID[sha1]=d3ecd2f8ac3b2dec11ed4cc424f15b3e1f130dd4, for GNU/Linux 3.7.0, not stripped&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;the-elf-file\&quot;&gt;The ELF File&lt;/h2&gt;\n            &lt;a href=\&quot;#the-elf-file\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;The central idea of this series of blog posts is to understand how to resolve dependencies from object files without directly involving the linker. For illustrative purposes we generated an object file based on some C-code and used it as a library for our main program. Before switching to the code, we need to understand the basics of the ELF structure.&lt;/p&gt;&lt;p&gt;Each ELF file is made up of one &lt;i&gt;ELF header&lt;/i&gt;, followed by file data. The data can include: a &lt;i&gt;program header&lt;/i&gt; table, a &lt;i&gt;section header&lt;/i&gt; table, and the data which is referred to by the program or section header tables.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;the-elf-header\&quot;&gt;The ELF Header&lt;/h3&gt;\n            &lt;a href=\&quot;#the-elf-header\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;The ELF header provides some basic information about the file: what architecture the file is compiled for, the program entry point and the references to other tables.&lt;/p&gt;&lt;p&gt;The ELF Header:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf -h main\nELF Header:\n  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 \n  Class:                             ELF64\n  Data:                              2&amp;#039;s complement, little endian\n  Version:                           1 (current)\n  OS/ABI:                            UNIX - System V\n  ABI Version:                       0\n  Type:                              DYN (Position-Independent Executable file)\n  Machine:                           AArch64\n  Version:                           0x1\n  Entry point address:               0x640\n  Start of program headers:          64 (bytes into file)\n  Start of section headers:          68576 (bytes into file)\n  Flags:                             0x0\n  Size of this header:               64 (bytes)\n  Size of program headers:           56 (bytes)\n  Number of program headers:         9\n  Size of section headers:           64 (bytes)\n  Number of section headers:         29\n  Section header string table index: 28&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;the-elf-program-header\&quot;&gt;The ELF Program Header&lt;/h3&gt;\n            &lt;a href=\&quot;#the-elf-program-header\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;The execution process of almost every program starts from an auxiliary program, called loader, which arranges the memory and calls the program’s entry point. In the following output the loader is marked with a line &lt;code&gt;“Requesting program interpreter: /lib/ld-linux-aarch64.so.1”&lt;/code&gt;. The whole program memory is split into different segments with associated size, permissions and type (which instructs the loader on how to interpret this block of memory). Because the execution process should be performed in the shortest possible time, the &lt;i&gt;sections&lt;/i&gt; with the same characteristics and located nearby are grouped into bigger blocks — &lt;i&gt;segments&lt;/i&gt; — and placed in the &lt;i&gt;program header&lt;/i&gt;. We can say that the &lt;i&gt;program header&lt;/i&gt; summarizes the types of data that appear in the &lt;i&gt;section header&lt;/i&gt;.&lt;/p&gt;&lt;p&gt;The ELF Program Header:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf -Wl main\n\nElf file type is DYN (Position-Independent Executable file)\nEntry point 0x640\nThere are 9 program headers, starting at offset 64\n\nProgram Headers:\n  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align\n  PHDR           0x000040 0x0000000000000040 0x0000000000000040 0x0001f8 0x0001f8 R   0x8\n  INTERP         0x000238 0x0000000000000238 0x0000000000000238 0x00001b 0x00001b R   0x1\n      [Requesting program interpreter: /lib/ld-linux-aarch64.so.1]\n  LOAD           0x000000 0x0000000000000000 0x0000000000000000 0x00088c 0x00088c R E 0x10000\n  LOAD           0x00fdc8 0x000000000001fdc8 0x000000000001fdc8 0x000270 0x000278 RW  0x10000\n  DYNAMIC        0x00fdd8 0x000000000001fdd8 0x000000000001fdd8 0x0001e0 0x0001e0 RW  0x8\n  NOTE           0x000254 0x0000000000000254 0x0000000000000254 0x000044 0x000044 R   0x4\n  GNU_EH_FRAME   0x0007a0 0x00000000000007a0 0x00000000000007a0 0x00003c 0x00003c R   0x4\n  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RW  0x10\n  GNU_RELRO      0x00fdc8 0x000000000001fdc8 0x000000000001fdc8 0x000238 0x000238 R   0x1\n\n Section to Segment mapping:\n  Segment Sections...\n   00     \n   01     .interp \n   02     .interp .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .text .fini .rodata .eh_frame_hdr .eh_frame \n   03     .init_array .fini_array .dynamic .got .got.plt .data .bss \n   04     .dynamic \n   05     .note.gnu.build-id .note.ABI-tag \n   06     .eh_frame_hdr \n   07     \n   08     .init_array .fini_array .dynamic .got &lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;the-elf-section-header\&quot;&gt;The ELF Section Header&lt;/h3&gt;\n            &lt;a href=\&quot;#the-elf-section-header\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;In the source code of high-level languages, variables, functions, and constants are mixed together. However, in assembly you might see that the data and instructions are separated into different blocks. The ELF file content is divided in an even more granular way. For example, variables with initial values are placed into different sections than the uninitialized ones. This approach optimizes for space, otherwise the values for uninitialized variables would be filled with zeros. Along with the space efficiency, there are security reasons for stratification — executable instructions can’t have writable permissions, while memory containing variables can&amp;#39;t be executable. The section header describes each of these sections.&lt;/p&gt;&lt;p&gt;The ELF Section Header:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf -SW main\nThere are 29 section headers, starting at offset 0x10be0:\n\nSection Headers:\n  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al\n  [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0\n  [ 1] .interp           PROGBITS        0000000000000238 000238 00001b 00   A  0   0  1\n  [ 2] .note.gnu.build-id NOTE            0000000000000254 000254 000024 00   A  0   0  4\n  [ 3] .note.ABI-tag     NOTE            0000000000000278 000278 000020 00   A  0   0  4\n  [ 4] .gnu.hash         GNU_HASH        0000000000000298 000298 00001c 00   A  5   0  8\n  [ 5] .dynsym           DYNSYM          00000000000002b8 0002b8 0000f0 18   A  6   3  8\n  [ 6] .dynstr           STRTAB          00000000000003a8 0003a8 000092 00   A  0   0  1\n  [ 7] .gnu.version      VERSYM          000000000000043a 00043a 000014 02   A  5   0  2\n  [ 8] .gnu.version_r    VERNEED         0000000000000450 000450 000030 00   A  6   1  8\n  [ 9] .rela.dyn         RELA            0000000000000480 000480 0000c0 18   A  5   0  8\n  [10] .rela.plt         RELA            0000000000000540 000540 000078 18  AI  5  22  8\n  [11] .init             PROGBITS        00000000000005b8 0005b8 000018 00  AX  0   0  4\n  [12] .plt              PROGBITS        00000000000005d0 0005d0 000070 00  AX  0   0 16\n  [13] .text             PROGBITS        0000000000000640 000640 000134 00  AX  0   0 64\n  [14] .fini             PROGBITS        0000000000000774 000774 000014 00  AX  0   0  4\n  [15] .rodata           PROGBITS        0000000000000788 000788 000016 00   A  0   0  8\n  [16] .eh_frame_hdr     PROGBITS        00000000000007a0 0007a0 00003c 00   A  0   0  4\n  [17] .eh_frame         PROGBITS        00000000000007e0 0007e0 0000ac 00   A  0   0  8\n  [18] .init_array       INIT_ARRAY      000000000001fdc8 00fdc8 000008 08  WA  0   0  8\n  [19] .fini_array       FINI_ARRAY      000000000001fdd0 00fdd0 000008 08  WA  0   0  8\n  [20] .dynamic          DYNAMIC         000000000001fdd8 00fdd8 0001e0 10  WA  6   0  8\n  [21] .got              PROGBITS        000000000001ffb8 00ffb8 000030 08  WA  0   0  8\n  [22] .got.plt          PROGBITS        000000000001ffe8 00ffe8 000040 08  WA  0   0  8\n  [23] .data             PROGBITS        0000000000020028 010028 000010 00  WA  0   0  8\n  [24] .bss              NOBITS          0000000000020038 010038 000008 00  WA  0   0  1\n  [25] .comment          PROGBITS        0000000000000000 010038 00001f 01  MS  0   0  1\n  [26] .symtab           SYMTAB          0000000000000000 010058 000858 18     27  66  8\n  [27] .strtab           STRTAB          0000000000000000 0108b0 00022c 00      0   0  1\n  [28] .shstrtab         STRTAB          0000000000000000 010adc 000103 00      0   0  1\nKey to Flags:\n  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),\n  L (link order), O (extra OS processing required), G (group), T (TLS),\n  C (compressed), x (unknown), o (OS specific), E (exclude),\n  D (mbind), p (processor specific)&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;executing-example-from-part-1-on-aarch64\&quot;&gt;Executing example from Part 1 on aarch64&lt;/h2&gt;\n            &lt;a href=\&quot;#executing-example-from-part-1-on-aarch64\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Actually, our &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/1\&quot;&gt;initial code&lt;/a&gt; from &lt;a href=\&quot;/how-to-execute-an-object-file-part-1/\&quot;&gt;Part 1&lt;/a&gt; works on aarch64 as is!&lt;/p&gt;&lt;p&gt;Let’s have a quick summary about what was done in the code:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;We need to find the code of two functions (&lt;code&gt;add5&lt;/code&gt; and &lt;code&gt;add10&lt;/code&gt;) in the &lt;code&gt;.text&lt;/code&gt; section of our object file (&lt;code&gt;obj.o&lt;/code&gt;)&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Load the functions in the executable memory&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Return the memory locations of the functions to the main program&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;There is one nuance: even though all the sections are in the section header, neither of them have a string name. Without the names we can’t identify them. However, having an additional character field for each section in the ELF structure would be inefficient for the space — it must be limited by some maximum length and those names which are shorter would leave the space unfilled. Instead, ELF provides an additional section, &lt;code&gt;.shstrtab&lt;/code&gt;. This string table concatenates all the names where each name ends with a null terminated byte. We can iterate over the names and match with an offset held by other sections to reference their name. But how do we find &lt;code&gt;.shstrtab&lt;/code&gt; itself if we don’t have a name? To solve this chicken and egg problem, the ELF program header provides a direct pointer to &lt;code&gt;.shstrtab&lt;/code&gt;. The similar approach is applied to two other sections: &lt;code&gt;.symtab&lt;/code&gt; and &lt;code&gt;.strtab&lt;/code&gt;. Where &lt;code&gt;.symtab&lt;/code&gt; contains all information about the symbols and &lt;code&gt;.strtab&lt;/code&gt; holds the list of symbol names. In the code we work with these tables to resolve all their dependencies and find our functions.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;executing-example-from-part-2-on-aarch64\&quot;&gt;Executing example from Part 2 on aarch64&lt;/h2&gt;\n            &lt;a href=\&quot;#executing-example-from-part-2-on-aarch64\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;At the beginning of the second blog post on &lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;how to execute an object file&lt;/a&gt; we made the function &lt;code&gt;add10&lt;/code&gt; depend on &lt;code&gt;add5&lt;/code&gt; instead of being self-contained. This is the first time when we faced relocations. &lt;i&gt;Relocations&lt;/i&gt; is the process of loading symbols defined outside the current scope. The relocated symbols can present global or thread-local variables, constant, functions, etc. We’ll start from checking assembly instructions which trigger relocations and uncovering how the ELF format handles them in a more general way.&lt;/p&gt;&lt;p&gt;After making &lt;code&gt;add10&lt;/code&gt; depend on &lt;code&gt;add5&lt;/code&gt; our aarch64 version stopped working as well, similarly to the x86. Let’s take a look at assembly listing:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ objdump --disassemble --section=.text obj.o\n\nobj.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;add5&amp;gt;:\n   0:\td10043ff \tsub\tsp, sp, #0x10\n   4:\tb9000fe0 \tstr\tw0, [sp, #12]\n   8:\tb9400fe0 \tldr\tw0, [sp, #12]\n   c:\t11001400 \tadd\tw0, w0, #0x5\n  10:\t910043ff \tadd\tsp, sp, #0x10\n  14:\td65f03c0 \tret\n\n0000000000000018 &amp;lt;add10&amp;gt;:\n  18:\ta9be7bfd \tstp\tx29, x30, [sp, #-32]!\n  1c:\t910003fd \tmov\tx29, sp\n  20:\tb9001fe0 \tstr\tw0, [sp, #28]\n  24:\tb9401fe0 \tldr\tw0, [sp, #28]\n  28:\t94000000 \tbl\t0 &amp;lt;add5&amp;gt;\n  2c:\tb9001fe0 \tstr\tw0, [sp, #28]\n  30:\tb9401fe0 \tldr\tw0, [sp, #28]\n  34:\t94000000 \tbl\t0 &amp;lt;add5&amp;gt;\n  38:\ta8c27bfd \tldp\tx29, x30, [sp], #32\n  3c:\td65f03c0 \tret&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Have you noticed that all the hex values in the second column are exactly the same length, in contrast with the instructions lengths seen for x86 in Part 2 of our series? This is because all Armv8-A instructions are presented in 32 bits. Since it is impossible to encode every immediate value into less than 32 bits, some operations require more than one instruction, as we’ll see later. For now, we’re interested in one instruction &lt;code&gt;- bl&lt;/code&gt; (&lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BL--Branch-with-Link-?lang=en\&quot;&gt;branch with link&lt;/a&gt;) on rows &lt;code&gt;28&lt;/code&gt; and &lt;code&gt;34&lt;/code&gt;. The &lt;code&gt;bl&lt;/code&gt; is a “jump” instruction, but before the jump it preserves the next instruction after the current one in the link register (&lt;code&gt;lr&lt;/code&gt;). When the callee finishes execution the caller address is recovered from &lt;code&gt;lr&lt;/code&gt;. Usually, the aarch64 instructions reserve the last 6 bits [31:26] for opcode and some auxiliary fields such as running architecture (32 or 64 bits), condition flag and others. Remaining bits are shared between arguments like source register, destination register and immediate value. Since the &lt;code&gt;bl&lt;/code&gt; instruction does not require a source or destination register, the full 26 bits can be used to encode the immediate offset instead. However, 26 bits can only encode a small range (+/-32 MB), but because the jump can only target a beginning of an instruction, it must always be aligned to 4 bytes, which increases the effective range of the encoded immediate fourfold, to +/-128 MB.&lt;/p&gt;&lt;p&gt;Similarly to what we did in &lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;Part 2&lt;/a&gt; we’re going to resolve our relocations - first by manually calculating the correct addresses and then by using an approach similar to what the linker does. The current value of our &lt;code&gt;bl&lt;/code&gt; instruction is &lt;code&gt;94000000&lt;/code&gt; or in binary representation &lt;code&gt;100101**00000000000000000000000000**&lt;/code&gt;. All 26 bits are zeros, so we don&amp;#39;t jump anywhere. The address is calculated by an offset from the current &lt;i&gt;program counter&lt;/i&gt; (&lt;code&gt;pc&lt;/code&gt;), which can be positive or negative. In our case we expect it to be &lt;code&gt;-0x28&lt;/code&gt; and &lt;code&gt;-0x34&lt;/code&gt;. As described above, it should be divided by 4 and taken as &lt;a href=\&quot;https://en.wikipedia.org/wiki/Two%27s_complement\&quot;&gt;two&amp;#39;s complements&lt;/a&gt;: &lt;code&gt;-0x28 / 4 = -0xA == 0xFFFFFFF6&lt;/code&gt; and &lt;code&gt;-0x34 / 4 = -0xD == 0xFFFFFFF3&lt;/code&gt;. From these values we need to take the lower 26 bits and concatenate them with the initial 6 bits to get the final instruction. So, the final ones will be: &lt;code&gt;100101**11111111111111111111110110** == 0x97FFFFF6&lt;/code&gt; and &lt;code&gt;100101**11111111111111111111110011** == 0x97FFFFF3&lt;/code&gt;. Have you noticed that all the distance calculations are done relative to the &lt;code&gt;bl&lt;/code&gt; (or current &lt;code&gt;pc&lt;/code&gt;), not the next instruction as in x86?&lt;/p&gt;&lt;p&gt;Let’s add to the code and execute:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;... \n\nstatic void parse_obj(void)\n{\n\t...\n\t/* copy the contents of `.text` section from the ELF file */\n\tmemcpy(text_runtime_base, obj.base + text_hdr-&amp;gt;sh_offset, text_hdr-&amp;gt;sh_size);\n\n\t*((uint32_t *)(text_runtime_base + 0x28)) = 0x97FFFFF6;\n\t*((uint32_t *)(text_runtime_base + 0x34)) = 0x97FFFFF3;\n\n\t/* make the `.text` copy readonly and executable */\n\tif (mprotect(text_runtime_base, page_align(text_hdr-&amp;gt;sh_size), PROT_READ | PROT_EXEC)) {\n\t...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compile and run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c\n$ ./loader\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;It works! But this is not how the linker handles the relocations. The linker resolves relocation based on the type and formula assigned to this type. In our &lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;Part 2&lt;/a&gt; we investigated it quite well. Here again we need to find the type and check the formula for this type:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf --relocs obj.o\n\nRelocation section &amp;#039;.rela.text&amp;#039; at offset 0x228 contains 2 entries:\n  Offset          Info           Type           Sym. Value    Sym. Name + Addend\n000000000028  000a0000011b R_AARCH64_CALL26  0000000000000000 add5 + 0\n000000000034  000a0000011b R_AARCH64_CALL26  0000000000000000 add5 + 0\n\nRelocation section &amp;#039;.rela.eh_frame&amp;#039; at offset 0x258 contains 2 entries:\n  Offset          Info           Type           Sym. Value    Sym. Name + Addend\n00000000001c  000200000105 R_AARCH64_PREL32  0000000000000000 .text + 0\n000000000034  000200000105 R_AARCH64_PREL32  0000000000000000 .text + 18&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Our Type is R_AARCH64_CALL26 and the &lt;a href=\&quot;https://github.com/ARM-software/abi-aa/blob/main/aaelf64/aaelf64.rst#5733relocation-operations\&quot;&gt;formula&lt;/a&gt; for it is:&lt;/p&gt;&lt;!--kg-card-begin: html--&gt;&lt;table cellspacing=\&quot;0\&quot; style=\&quot;border-collapse:collapse; border:none; width:100%\&quot;&gt;\n\t&lt;tbody&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;ELF64 Code&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:179px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Name&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:145px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Operation&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;283&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:179px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;R_&amp;lt;CLS&amp;gt;_CALL26&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:145px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;S + A - P&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t&lt;/tbody&gt;\n&lt;/table&gt;&lt;!--kg-card-end: html--&gt;&lt;p&gt;where:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;S&lt;/code&gt; (when used on its own) is the address of the symbol&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;A&lt;/code&gt; is the addend for the relocation&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;P&lt;/code&gt; is the address of the place being relocated (derived from &lt;code&gt;r_offset&lt;/code&gt;)&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Here are the relevant changes to loader.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;/* Replace `#define R_X86_64_PLT32 4` with our Type */\n#define R_AARCH64_CALL26 283\n...\n\nstatic void do_text_relocations(void)\n{\n\t...\n\tuint32_t val;\n\n\tswitch (type)\n\t{\n\tcase R_AARCH64_CALL26:\n\t\t/* The mask separates opcode (6 bits) and the immediate value */\n\t\tuint32_t mask_bl = (0xffffffff &amp;lt;&amp;lt; 26);\n\t\t/* S+A-P, divided by 4 */\n\t\tval = (symbol_address + relocations[i].r_addend - patch_offset) &amp;gt;&amp;gt; 2;\n\t\t/* Concatenate opcode and value to get final instruction */\n\t\t*((uint32_t *)patch_offset) &amp;amp;= mask_bl;\n\t\tval &amp;amp;= ~mask_bl;\n\t\t*((uint32_t *)patch_offset) |= val;\n\t\tbreak;\n\t}\n\t...\n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compile and run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c \n$ ./loader\nCalculated relocation: 0x97fffff6\nCalculated relocation: 0x97fffff3\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;So far so good. The next challenge is to &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/2/obj.c#L16-L31\&quot;&gt;add constant data and global variables&lt;/a&gt; to our object file and check relocations again:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf --relocs --wide obj.o\n\nRelocation section &amp;#039;.rela.text&amp;#039; at offset 0x388 contains 8 entries:\n    Offset             Info             Type               Symbol&amp;#039;s Value  Symbol&amp;#039;s Name + Addend\n0000000000000000  0000000500000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .rodata + 0\n0000000000000004  0000000500000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .rodata + 0\n000000000000000c  0000000300000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .data + 0\n0000000000000010  0000000300000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .data + 0\n0000000000000024  0000000300000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .data + 0\n0000000000000028  0000000300000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .data + 0\n0000000000000068  000000110000011b R_AARCH64_CALL26       0000000000000040 add5 + 0\n0000000000000074  000000110000011b R_AARCH64_CALL26       0000000000000040 add5 + 0\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;We have even two new relocations: &lt;code&gt;R_AARCH64_ADD_ABS_LO12_NC&lt;/code&gt; and &lt;code&gt;R_AARCH64_ADR_PREL_PG_HI21&lt;/code&gt;. Their formulas are:&lt;/p&gt;&lt;!--kg-card-begin: html--&gt;&lt;table cellspacing=\&quot;0\&quot; style=\&quot;border-collapse:collapse; border:none; width:100%\&quot;&gt;\n\t&lt;tbody&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;ELF64 Code&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:237px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Name&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:221px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Operation&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;&lt;span style=\&quot;background-color:#ffffff\&quot;&gt;275&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:237px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;&lt;span style=\&quot;background-color:#ffffff\&quot;&gt;R_&amp;lt;CLS&amp;gt;_ ADR_PREL_PG_HI21&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:221px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;&lt;span style=\&quot;background-color:#ffffff\&quot;&gt;Page(S+A) - Page(P)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;277&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:237px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;R_&amp;lt;CLS&amp;gt;_ ADD_ABS_LO12_NC&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:221px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;S + A&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t&lt;/tbody&gt;\n&lt;/table&gt;&lt;!--kg-card-end: html--&gt;&lt;p&gt;where:&lt;/p&gt;&lt;p&gt;&lt;code&gt;Page(expr)&lt;/code&gt; is the page address of the expression expr, defined as &lt;code&gt;(expr &amp;amp; ~0xFFF)&lt;/code&gt;. (This applies even if the machine page size supported by the platform has a different value.)&lt;/p&gt;&lt;p&gt;It’s a bit unclear why we have two new types, while in x86 we had only one. Let’s investigate the assembly code:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ objdump --disassemble --section=.text obj.o\n\nobj.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;get_hello&amp;gt;:\n   0:\t90000000 \tadrp\tx0, 0 &amp;lt;get_hello&amp;gt;\n   4:\t91000000 \tadd\tx0, x0, #0x0\n   8:\td65f03c0 \tret\n\n000000000000000c &amp;lt;get_var&amp;gt;:\n   c:\t90000000 \tadrp\tx0, 0 &amp;lt;get_hello&amp;gt;\n  10:\t91000000 \tadd\tx0, x0, #0x0\n  14:\tb9400000 \tldr\tw0, [x0]\n  18:\td65f03c0 \tret\n\n000000000000001c &amp;lt;set_var&amp;gt;:\n  1c:\td10043ff \tsub\tsp, sp, #0x10\n  20:\tb9000fe0 \tstr\tw0, [sp, #12]\n  24:\t90000000 \tadrp\tx0, 0 &amp;lt;get_hello&amp;gt;\n  28:\t91000000 \tadd\tx0, x0, #0x0\n  2c:\tb9400fe1 \tldr\tw1, [sp, #12]\n  30:\tb9000001 \tstr\tw1, [x0]\n  34:\td503201f \tnop\n  38:\t910043ff \tadd\tsp, sp, #0x10\n  3c:\td65f03c0 \tret&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;We see that all &lt;code&gt;adrp&lt;/code&gt; instructions are followed by &lt;code&gt;add&lt;/code&gt; instructions. The &lt;code&gt;[add](https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADD--immediate---Add--immediate--?lang=en)&lt;/code&gt; instruction adds an immediate value to the source register and writes the result to the destination register. The source and destination registers can be the same, the immediate value is 12 bits. The &lt;code&gt;[adrp](https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADRP--Form-PC-relative-address-to-4KB-page-?lang=en)&lt;/code&gt; instruction generates a &lt;code&gt;pc&lt;/code&gt;-relative (program counter) address and writes the result to the destination register. It takes &lt;code&gt;pc&lt;/code&gt; of the instruction itself and adds a 21-bit immediate value shifted left by 12 bits. If the immediate value weren’t shifted it would lie in a range of +/-1 MB memory, which isn’t enough. The left shift increases the range up to +/-1 GB. However, because the 12 bits are masked out with the shift, we need to store them somewhere and restore later. That’s why we see add instruction following &lt;code&gt;adrp&lt;/code&gt; and two types instead of one. Also, it’s a bit tricky to encode &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADRP--Form-PC-relative-address-to-4KB-page-?lang=en\&quot;&gt;&lt;code&gt;adrp&lt;/code&gt;&lt;/a&gt;: 2 low bits of immediate value are placed in the position 30:29 and the rest in the position 23:5. Due to size limitations, the aarch64 instructions try to make the most out of 32 bits.&lt;/p&gt;&lt;p&gt;In the code we are going to use the formulas to calculate the values and description of &lt;code&gt;adrp&lt;/code&gt; and &lt;code&gt;add&lt;/code&gt; instructions to obtain the final opcode:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;#define R_AARCH64_CALL26 283\n#define R_AARCH64_ADD_ABS_LO12_NC 277\n#define R_AARCH64_ADR_PREL_PG_HI21 275\n...\n\n{\ncase R_AARCH64_CALL26:\n\t/* The mask separates opcode (6 bits) and the immediate value */\n\tuint32_t mask_bl = (0xffffffff &amp;lt;&amp;lt; 26);\n\t/* S+A-P, divided by 4 */\n\tval = (symbol_address + relocations[i].r_addend - patch_offset) &amp;gt;&amp;gt; 2;\n\t/* Concatenate opcode and value to get final instruction */\n\t*((uint32_t *)patch_offset) &amp;amp;= mask_bl;\n\tval &amp;amp;= ~mask_bl;\n\t*((uint32_t *)patch_offset) |= val;\n\tbreak;\ncase R_AARCH64_ADD_ABS_LO12_NC:\n\t/* The mask of `add` instruction to separate \n\t* opcode, registers and calculated value \n\t*/\n\tuint32_t mask_add = 0b11111111110000000000001111111111;\n\t/* S + A */\n\tuint32_t val = *(symbol_address + relocations[i].r_addend);\n\tval &amp;amp;= ~mask_add;\n\t*((uint32_t *)patch_offset) &amp;amp;= mask_add;\n\t/* Final instruction */\n\t*((uint32_t *)patch_offset) |= val;\ncase R_AARCH64_ADR_PREL_PG_HI21:\n\t/* Page(S+A)-Page(P), Page(expr) is defined as (expr &amp;amp; ~0xFFF) */\n\tval = (((uint64_t)(symbol_address + relocations[i].r_addend)) &amp;amp; ~0xFFF) - (((uint64_t)patch_offset) &amp;amp; ~0xFFF);\n\t/* Shift right the calculated value by 12 bits.\n\t * During decoding it will be shifted left as described above, \n\t * so we do the opposite.\n\t*/\n\tval &amp;gt;&amp;gt;= 12;\n\t/* Separate the lower and upper bits to place them in different positions */ \n\tuint32_t immlo = (val &amp;amp; (0xf &amp;gt;&amp;gt; 2)) &amp;lt;&amp;lt; 29 ;\n\tuint32_t immhi = (val &amp;amp; ((0xffffff &amp;gt;&amp;gt; 13) &amp;lt;&amp;lt; 2)) &amp;lt;&amp;lt; 22;\n\t*((uint32_t *)patch_offset) |= immlo;\n\t*((uint32_t *)patch_offset) |= immhi;\n\tbreak;\n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compile and run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c \n$ ./loader\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52\nExecuting get_hello...\nget_hello() = Hello, world!\nExecuting get_var...\nget_var() = 5\nExecuting set_var(42)...\nExecuting get_var again...\nget_var() = 42&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;It works! The final code is &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/4/2\&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;executing-example-from-part-3-on-aarch64\&quot;&gt;Executing example from Part 3 on aarch64&lt;/h2&gt;\n            &lt;a href=\&quot;#executing-example-from-part-3-on-aarch64\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Our &lt;a href=\&quot;/how-to-execute-an-object-file-part-3/\&quot;&gt;Part 3&lt;/a&gt; is about resolving external dependencies. When we write code we don’t think much about how to allocate memory or print debug information to the console. Instead, we involve functions from the system libraries. But the code of system libraries needs to be passed through to our programs somehow. Additionally, for optimization purposes, it would be nice if this code would be stored in one place and shared between all programs. And another wish — we don’t want to resolve all the functions and global variables from the libraries, only those which we need and at those times when we need them. To solve these problems, ELF introduced two sections: PLT (the procedure linkage table) and GOT (the global offset table). The dynamic loader creates a list which contains all external functions and variables from the shared library, but doesn’t resolve them immediately; instead they are placed in the PLT section. Each external symbol is presented by a small function, a stub, e.g. &lt;code&gt;puts@plt&lt;/code&gt;. When an external symbol is requested, the stub checks if it was resolved previously. If not, the stub searches for an absolute address of the symbol, returns to the requester and writes it in the GOT table. The next time, the address returns directly from the GOT table.&lt;/p&gt;&lt;p&gt;In &lt;a href=\&quot;/how-to-execute-an-object-file-part-3/\&quot;&gt;Part 3&lt;/a&gt; we implemented a simplified PLT/GOT resolution. Firstly, we added a new function &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/obj.c#L35\&quot;&gt;&lt;code&gt;say_hello&lt;/code&gt;&lt;/a&gt; in the &lt;code&gt;obj.c&lt;/code&gt;, which calls unresolved system library function &lt;code&gt;puts&lt;/code&gt;. Further we added an optional wrapper &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L73\&quot;&gt;&lt;code&gt;my_puts&lt;/code&gt;&lt;/a&gt; in the &lt;code&gt;loader.c&lt;/code&gt;. The wrapper isn’t required, we could’ve resolved directly to a standard function, but it&amp;#39;s a good example of how the implementation of some functions can be overwritten with custom code. In the next steps we added our PLT/GOT resolution:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;PLT section we replaced with a &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L340\&quot;&gt;jumptable&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;GOT we replaced with &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238-L248\&quot;&gt;assembly instructions&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Basically, we created a small stub with assembly code (our &lt;code&gt;jumptable&lt;/code&gt;) to resolve the global address of our &lt;code&gt;my_puts&lt;/code&gt; wrapper and jump to it.&lt;/p&gt;&lt;p&gt;The approach for aarch64 is the same. But the &lt;code&gt;jumptable&lt;/code&gt; is very different as it consists of different assembly instructions.&lt;/p&gt;&lt;p&gt;The big difference here compared to the other parts is that we need to work with a 64-bit address for the GOT resolution. Our custom PLT or &lt;code&gt;jumptable&lt;/code&gt; is placed close to the main code of &lt;code&gt;obj.c&lt;/code&gt; and can operate with the relative addresses as before. For the GOT or referencing &lt;code&gt;my_puts&lt;/code&gt; wrapper we’ll use different branch instructions — &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BR--Branch-to-Register-\&quot;&gt;&lt;code&gt;br&lt;/code&gt;&lt;/a&gt; or &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BLR--Branch-with-Link-to-Register-\&quot;&gt;&lt;code&gt;blr&lt;/code&gt;&lt;/a&gt;. These instructions branch to the register, where the aarch64 registers can hold 64-bit values.&lt;/p&gt;&lt;p&gt;We can check how it resolves with the native PLT/GOT in our loader assembly code:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ objdump --disassemble --section=.text loader\n...\n1d2c:\t97fffb45 \tbl\ta40 &amp;lt;puts@plt&amp;gt;\n1d30:\tf94017e0 \tldr\tx0, [sp, #40]\n1d34:\td63f0000 \tblr\tx0\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The first instruction is &lt;code&gt;bl&lt;/code&gt; jump to &lt;code&gt;puts@plt&lt;/code&gt; stub. The next &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/LDR--immediate---Load-Register--immediate--\&quot;&gt;&lt;code&gt;ldr&lt;/code&gt;&lt;/a&gt; instruction tells us that some value was loaded into the register &lt;code&gt;x0&lt;/code&gt; from the stack. Each function has its own &lt;a href=\&quot;https://en.wikipedia.org/wiki/Call_stack#Stack_and_frame_pointers\&quot;&gt;stack frame&lt;/a&gt; to hold the local variables. The last &lt;code&gt;blr&lt;/code&gt; instruction makes a jump to the address stored in &lt;code&gt;x0&lt;/code&gt; register. There is an agreement in the register naming: if the stored value is 64-bits then the register is called &lt;code&gt;x0-x30&lt;/code&gt;; if only 32-bits are used then it’s called &lt;code&gt;w0-w30&lt;/code&gt; (the value will be stored in the lower 32-bits and upper 32-bits will be zeroed).&lt;/p&gt;&lt;p&gt;We need to do something similar — place the absolute address of our &lt;code&gt;my_puts&lt;/code&gt; wrapper in some register and call &lt;code&gt;br&lt;/code&gt; on this register. We don’t need to store the link before branching, the call will be returned to &lt;code&gt;say_hello&lt;/code&gt; from &lt;code&gt;obj.c&lt;/code&gt;, which is why a plain &lt;code&gt;br&lt;/code&gt; will be enough. Let’s check an assembly of simple C-function:&lt;/p&gt;&lt;p&gt;hello.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;#include &amp;lt;stdint.h&amp;gt;\n\nvoid say_hello(void)\n{\n    uint64_t reg = 0x555555550c14;\n}&lt;/pre&gt;&lt;/code&gt;\n            \n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -c hello.c\n$ objdump --disassemble --section=.text hello.o\n\nhello.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;say_hello&amp;gt;:\n   0:\td10043ff \tsub\tsp, sp, #0x10\n   4:\td2818280 \tmov\tx0, #0xc14                 \t// #3092\n   8:\tf2aaaaa0 \tmovk\tx0, #0x5555, lsl #16\n   c:\tf2caaaa0 \tmovk\tx0, #0x5555, lsl #32\n  10:\tf90007e0 \tstr\tx0, [sp, #8]\n  14:\td503201f \tnop\n  18:\t910043ff \tadd\tsp, sp, #0x10\n  1c:\td65f03c0 \tret&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The number &lt;code&gt;0x555555550c14&lt;/code&gt; is the address returned by &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238\&quot;&gt;&lt;code&gt;lookup_ext_function&lt;/code&gt;&lt;/a&gt;. We’ve printed it out to use as an example, but any &lt;a href=\&quot;https://www.kernel.org/doc/html/latest/arch/arm64/memory.html\&quot;&gt;48-bits&lt;/a&gt; hex value can be used.&lt;/p&gt;&lt;p&gt;In our output we see that the value was split in three sections and written in &lt;code&gt;x0&lt;/code&gt; register with three instructions: one &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOV--inverted-wide-immediate---Move--inverted-wide-immediate---an-alias-of-MOVN-\&quot;&gt;&lt;code&gt;mov&lt;/code&gt;&lt;/a&gt; and two &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOVK--Move-wide-with-keep-?lang=en\&quot;&gt;&lt;code&gt;movk&lt;/code&gt;&lt;/a&gt;. The documentation says that there are only 16 bits for the immediate value, but a shift can be applied (in our case left shift &lt;code&gt;lsl&lt;/code&gt;).&lt;/p&gt;&lt;p&gt;However, we can’t use &lt;code&gt;x0&lt;/code&gt; in our context. By &lt;a href=\&quot;https://developer.arm.com/documentation/den0024/a/The-ABI-for-ARM-64-bit-Architecture/Register-use-in-the-AArch64-Procedure-Call-Standard/Parameters-in-general-purpose-registers\&quot;&gt;convention&lt;/a&gt; the registers &lt;code&gt;x0-x7&lt;/code&gt; are caller-saved and used to pass function parameters between calls to other functions. Let’s use &lt;code&gt;x9&lt;/code&gt; then.&lt;/p&gt;&lt;p&gt;We need to modify our loader. Firstly let’s change the jumptable structure.&lt;/p&gt;&lt;p&gt;loader.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;...\nstruct ext_jump {\n\tuint32_t instr[4];\n};\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;As we saw above, we need four instructions: &lt;code&gt;mov&lt;/code&gt;, &lt;code&gt;movk&lt;/code&gt;, &lt;code&gt;movk&lt;/code&gt;, &lt;code&gt;br&lt;/code&gt;. We don’t need a stack frame as we aren’t preserving any local variables. We just want to load the address into the register and branch to it. But we can’t write human-readable code&lt;/p&gt;&lt;p&gt;e.g. &lt;code&gt;mov &nbsp;x0, #0xc14&lt;/code&gt; into instructions, we need machine binary or hex representation, e.g. &lt;code&gt;d2818280&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Let’s write a simple assembly code to get it:&lt;/p&gt;&lt;p&gt;hw.s:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;.global _start\n\n_start: mov     x9, #0xc14 \n        movk    x9, #0x5555, lsl #16\n        movk    x9, #0x5555, lsl #32\n        br      x9&lt;/pre&gt;&lt;/code&gt;\n            \n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ as -o hw.o hw.s\n$ objdump --disassemble --section=.text hw.o\n\nhw.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;_start&amp;gt;:\n   0:\td2818289 \tmov\tx9, #0xc14                 \t// #3092\n   4:\tf2aaaaa9 \tmovk\tx9, #0x5555, lsl #16\n   8:\tf2caaaa9 \tmovk\tx9, #0x5555, lsl #32\n   c:\td61f0120 \tbr\tx9&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Almost done! But there’s one more thing to consider. Even if the value &lt;code&gt;0x555555550c14&lt;/code&gt; is a real &lt;code&gt;my_puts&lt;/code&gt; wrapper address, it will be different on each run if &lt;a href=\&quot;https://en.wikipedia.org/wiki/Address_space_layout_randomization\&quot;&gt;ASLR(Address space layout randomization)&lt;/a&gt; is enabled. We need to patch these instructions to put the value which will be returned by &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238\&quot;&gt;&lt;code&gt;lookup_ext_function&lt;/code&gt;&lt;/a&gt; on each run. We’ll split the obtained value in three parts, 16-bits each, and replace them in our &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOV--inverted-wide-immediate---Move--inverted-wide-immediate---an-alias-of-MOVN-\&quot;&gt;&lt;code&gt;mov&lt;/code&gt;&lt;/a&gt; and &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOVK--Move-wide-with-keep-?lang=en\&quot;&gt;&lt;code&gt;movk&lt;/code&gt;&lt;/a&gt; instructions according to the documentation, similar to what we did before for our second part.&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;if (symbols[symbol_idx].st_shndx == SHN_UNDEF) {\n\tstatic int curr_jmp_idx = 0;\n\n\tuint64_t addr = lookup_ext_function(strtab +  symbols[symbol_idx].st_name);\n\tuint32_t mov = 0b11010010100000000000000000001001 | ((addr &amp;lt;&amp;lt; 48) &amp;gt;&amp;gt; 43);\n\tuint32_t movk1 = 0b11110010101000000000000000001001 | (((addr &amp;gt;&amp;gt; 16) &amp;lt;&amp;lt; 48) &amp;gt;&amp;gt; 43);\n\tuint32_t movk2 = 0b11110010110000000000000000001001 | (((addr &amp;gt;&amp;gt; 32) &amp;lt;&amp;lt; 48) &amp;gt;&amp;gt; 43);\n\tjumptable[curr_jmp_idx].instr[0] = mov;         // mov  x9, #0x0c14\n\tjumptable[curr_jmp_idx].instr[1] = movk1;       // movk x9, #0x5555, lsl #16\n\tjumptable[curr_jmp_idx].instr[2] = movk2;       // movk x9, #0x5555, lsl #32\n\tjumptable[curr_jmp_idx].instr[3] = 0xd61f0120;  // br   x9\n\n\tsymbol_address = (uint8_t *)(&amp;amp;jumptable[curr_jmp_idx].instr[0]);\n\tcurr_jmp_idx++;\n} else {\n\tsymbol_address = section_runtime_base(&amp;amp;sections[symbols[symbol_idx].st_shndx]) + symbols[symbol_idx].st_value;\n}\nuint32_t val;\nswitch (type)\n{\ncase R_AARCH64_CALL26:\n\t/* The mask separates opcode (6 bits) and the immediate value */\n\tuint32_t mask_bl = (0xffffffff &amp;lt;&amp;lt; 26);\n\t/* S+A-P, divided by 4 */\n\tval = (symbol_address + relocations[i].r_addend - patch_offset) &amp;gt;&amp;gt; 2;\n\t/* Concatenate opcode and value to get final instruction */\n\t*((uint32_t *)patch_offset) &amp;amp;= mask_bl;\n\tval &amp;amp;= ~mask_bl;\n\t*((uint32_t *)patch_offset) |= val;\n\tbreak;\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;In the code we took the address of the first instruction &lt;code&gt;&amp;amp;jumptable[curr_jmp_idx].instr[0]&lt;/code&gt; and wrote it in the &lt;code&gt;symbol_address&lt;/code&gt;, further because the &lt;code&gt;type&lt;/code&gt; is still &lt;code&gt;R_AARCH64_CALL26&lt;/code&gt; it will be put into &lt;code&gt;bl&lt;/code&gt; - jump to the relative address. Where our relative address is the first &lt;code&gt;mov&lt;/code&gt; instruction. The whole &lt;code&gt;jumptable&lt;/code&gt; code will be executed and finished with the &lt;code&gt;blr&lt;/code&gt; instruction.&lt;/p&gt;&lt;p&gt;The final run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c\n$ ./loader\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52\nExecuting get_hello...\nget_hello() = Hello, world!\nExecuting get_var...\nget_var() = 5\nExecuting set_var(42)...\nExecuting get_var again...\nget_var() = 42\nExecuting say_hello...\nmy_puts executed\nHello, world!&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The final code is &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/4/3\&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;summary\&quot;&gt;Summary&lt;/h2&gt;\n            &lt;a href=\&quot;#summary\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;There are several things we covered in this blog post. We gave a brief introduction on how the binary got executed on Linux and how all components are linked together. We saw a big difference between x86 and aarch64 assembly. We learned how we can hook into the code and change its behavior. But just as it was said in the first blog post of this series, the most important thing is to remember to always think about security first. Processing external inputs should always be done with great care. Bounds and integrity checks have been omitted for the purposes of keeping the examples short, so readers should be aware that the code is not production ready and is designed for educational purposes only.&lt;/p&gt;&quot;],&quot;published_at&quot;:[0,&quot;2023-11-17T14:00:35.000+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-10-09T23:26:26.129Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7v5UY4RrgvrEIaQ7k6TcVa/8a3cb0bf88d8a3aa3a780c71dff0bef1/how-to-execute-an-object-file-part-4.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;383iv0UQ6Lp0GZwOAxGq2p&quot;],&quot;name&quot;:[0,&quot;Linux&quot;],&quot;slug&quot;:[0,&quot;linux&quot;]}],[0,{&quot;id&quot;:[0,&quot;6lhzEBz2B56RKa4nUEAGYJ&quot;],&quot;name&quot;:[0,&quot;Programming&quot;],&quot;slug&quot;:[0,&quot;programming&quot;]}],[0,{&quot;id&quot;:[0,&quot;2UVIYusJwlvsmPYl2AvSuR&quot;],&quot;name&quot;:[0,&quot;Deep Dive&quot;],&quot;slug&quot;:[0,&quot;deep-dive&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Oxana Kharitonova&quot;],&quot;slug&quot;:[0,&quot;oxana&quot;],&quot;bio&quot;:[0,null],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3VMs5mLnM2JGDuB1x0sRSE/957ab30efef528d9fa8ccf73f1c20242/oxana.png&quot;],&quot;location&quot;:[0,&quot;London&quot;],&quot;website&quot;:[0,null],&quot;twitter&quot;:[0,null],&quot;facebook&quot;:[0,null]}]]],&quot;meta_description&quot;:[0,&quot;The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;How to execute an object file: part 4, AArch64 edition Config&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/how-to-execute-an-object-file-part-4&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;How to execute an object file: part 4, AArch64 edition&quot;],&quot;description&quot;:[0,&quot;The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/32iMMwlljd5QlJuzD2MLTo/9f476195e6436ca8bfba6d9e5b9e5ac3/how-to-execute-an-object-file-part-4-zy4TY1.png&quot;]}]}],&quot;tagInfo&quot;:[0],&quot;authorInfo&quot;:[0],&quot;translatedPosts&quot;:[1,[]]}" client="only" opts="{&quot;name&quot;:&quot;GoogleAnalytics&quot;,&quot;value&quot;:&quot;react&quot;}"></astro-island><script>(()=>{var l=(n,t)=>{let i=async()=>{await(await n())()},e=typeof t.value=="object"?t.value:void 0,s={timeout:e==null?void 0:e.timeout};"requestIdleCallback"in window?window.requestIdleCallback(i,s):setTimeout(i,s.timeout||200)};(self.Astro||(self.Astro={})).idle=l;window.dispatchEvent(new Event("astro:idle"));})();</script><astro-island uid="Z2d3s0a" prefix="r3" component-url="/_astro/Navigation.CSu6dGvY.js" component-export="Navigation" renderer-url="/_astro/client.DLO1yDVm.js" props="{&quot;title&quot;:[0,&quot;The Cloudflare Blog&quot;],&quot;logo&quot;:[0,&quot;//images.ctfassets.net/zkvhlag99gkb/69RwBidpiEHCDZ9rFVVk7T/092507edbed698420b89658e5a6d5105/CF_logo_stacked_blktype.png&quot;],&quot;pagesStore&quot;:[0,{&quot;page&quot;:[0,&quot;Post&quot;],&quot;slug&quot;:[0,&quot;how-to-execute-an-object-file-part-4&quot;],&quot;translationsAvailable&quot;:[1,[]],&quot;navData&quot;:[1,[[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;J61Eszqn98amrYHq4IhTx&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:46.068Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-24T08:02:58.555Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,67],&quot;revision&quot;:[0,29],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Zero Trust&quot;],&quot;name&quot;:[0,&quot;Zero Trust&quot;],&quot;slug&quot;:[0,&quot;zero-trust&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;5kZtWqjqa7aOUoZr8NFGwI&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:26.040Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-18T05:02:47.858Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,106],&quot;revision&quot;:[0,33],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Cloudflare Radar&quot;],&quot;name&quot;:[0,&quot;Radar&quot;],&quot;slug&quot;:[0,&quot;cloudflare-radar&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;6Mp7ouACN2rT3YjL1xaXJx&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:42:46.231Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-18T05:02:46.749Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,66],&quot;revision&quot;:[0,23],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Security&quot;],&quot;name&quot;:[0,&quot;Security&quot;],&quot;slug&quot;:[0,&quot;security&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;6Foe3R8of95cWVnQwe5Toi&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T22:44:28.803Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-10T05:02:55.192Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,62],&quot;revision&quot;:[0,23],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;AI&quot;],&quot;name&quot;:[0,&quot;AI&quot;],&quot;slug&quot;:[0,&quot;ai&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;6QktrXeEFcl4e2dZUTZVGl&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:20.198Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-04T17:23:05.518Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,57],&quot;revision&quot;:[0,24],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Product News&quot;],&quot;name&quot;:[0,&quot;Product News&quot;],&quot;slug&quot;:[0,&quot;product-news&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;4HIPcb68qM0e26fIxyfzwQ&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:43:21.536Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-04T17:19:33.689Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,59],&quot;revision&quot;:[0,26],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Developers&quot;],&quot;name&quot;:[0,&quot;Developers&quot;],&quot;slug&quot;:[0,&quot;developers&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;48r7QV00gLMWOIcM1CSDRy&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:54:22.790Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-04T17:17:33.067Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,59],&quot;revision&quot;:[0,26],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Speed &amp; Reliability&quot;],&quot;name&quot;:[0,&quot;Speed &amp; Reliability&quot;],&quot;slug&quot;:[0,&quot;speed-and-reliability&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;V86khSc459Yi1AhTlvtY7&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:46:53.657Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-04T17:12:59.473Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,57],&quot;revision&quot;:[0,21],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Partners&quot;],&quot;name&quot;:[0,&quot;Partners&quot;],&quot;slug&quot;:[0,&quot;partners&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;4g8tPriKOAUwdUT4jNPebe&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:46:40.927Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-02-04T17:11:28.566Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,55],&quot;revision&quot;:[0,24],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Life at Cloudflare&quot;],&quot;name&quot;:[0,&quot;Life at Cloudflare&quot;],&quot;slug&quot;:[0,&quot;life-at-cloudflare&quot;],&quot;featured&quot;:[0,true]}]}],[0,{&quot;metadata&quot;:[0,{&quot;tags&quot;:[1,[]],&quot;concepts&quot;:[1,[]]}],&quot;sys&quot;:[0,{&quot;space&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Space&quot;],&quot;id&quot;:[0,&quot;zkvhlag99gkb&quot;]}]}],&quot;id&quot;:[0,&quot;16yk8DVbNNifxov5cWvAov&quot;],&quot;type&quot;:[0,&quot;Entry&quot;],&quot;createdAt&quot;:[0,&quot;2024-10-09T19:56:23.848Z&quot;],&quot;updatedAt&quot;:[0,&quot;2025-01-29T05:03:35.958Z&quot;],&quot;environment&quot;:[0,{&quot;sys&quot;:[0,{&quot;id&quot;:[0,&quot;master&quot;],&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;Environment&quot;]}]}],&quot;publishedVersion&quot;:[0,63],&quot;revision&quot;:[0,28],&quot;contentType&quot;:[0,{&quot;sys&quot;:[0,{&quot;type&quot;:[0,&quot;Link&quot;],&quot;linkType&quot;:[0,&quot;ContentType&quot;],&quot;id&quot;:[0,&quot;blogTag&quot;]}]}],&quot;locale&quot;:[0,&quot;en-US&quot;]}],&quot;fields&quot;:[0,{&quot;entryTitle&quot;:[0,&quot;Policy &amp; Legal&quot;],&quot;name&quot;:[0,&quot;Policy &amp; Legal&quot;],&quot;slug&quot;:[0,&quot;policy&quot;],&quot;featured&quot;:[0,true]}]}]]]}],&quot;locale&quot;:[0,&quot;en-us&quot;],&quot;translations&quot;:[0,{&quot;posts.by&quot;:[0,&quot;By&quot;],&quot;footer.gdpr&quot;:[0,&quot;GDPR&quot;],&quot;lang_blurb1&quot;:[0,&quot;This post is also available in {lang1}.&quot;],&quot;lang_blurb2&quot;:[0,&quot;This post is also available in {lang1} and {lang2}.&quot;],&quot;lang_blurb3&quot;:[0,&quot;This post is also available in {lang1}, {lang2} and {lang3}.&quot;],&quot;footer.press&quot;:[0,&quot;Press&quot;],&quot;header.title&quot;:[0,&quot;The Cloudflare Blog&quot;],&quot;search.clear&quot;:[0,&quot;Clear&quot;],&quot;search.filter&quot;:[0,&quot;Filter&quot;],&quot;search.source&quot;:[0,&quot;Source&quot;],&quot;footer.careers&quot;:[0,&quot;Careers&quot;],&quot;footer.company&quot;:[0,&quot;Company&quot;],&quot;footer.support&quot;:[0,&quot;Support&quot;],&quot;footer.the_net&quot;:[0,&quot;theNet&quot;],&quot;search.filters&quot;:[0,&quot;Filters&quot;],&quot;footer.our_team&quot;:[0,&quot;Our team&quot;],&quot;footer.webinars&quot;:[0,&quot;Webinars&quot;],&quot;page.more_posts&quot;:[0,&quot;More posts&quot;],&quot;posts.time_read&quot;:[0,&quot;{time} min read&quot;],&quot;search.language&quot;:[0,&quot;Language&quot;],&quot;footer.community&quot;:[0,&quot;Community&quot;],&quot;footer.resources&quot;:[0,&quot;Resources&quot;],&quot;footer.solutions&quot;:[0,&quot;Solutions&quot;],&quot;footer.trademark&quot;:[0,&quot;Trademark&quot;],&quot;header.subscribe&quot;:[0,&quot;Subscribe&quot;],&quot;footer.compliance&quot;:[0,&quot;Compliance&quot;],&quot;footer.free_plans&quot;:[0,&quot;Free plans&quot;],&quot;footer.impact_ESG&quot;:[0,&quot;Impact/ESG&quot;],&quot;posts.follow_on_X&quot;:[0,&quot;Follow on X&quot;],&quot;footer.help_center&quot;:[0,&quot;Help center&quot;],&quot;footer.network_map&quot;:[0,&quot;Network Map&quot;],&quot;header.please_wait&quot;:[0,&quot;Please Wait&quot;],&quot;page.related_posts&quot;:[0,&quot;Related posts&quot;],&quot;search.result_stat&quot;:[0,&quot;Results &lt;strong&gt;{search_range}&lt;/strong&gt; of &lt;strong&gt;{search_total}&lt;/strong&gt; for &lt;strong&gt;{search_keyword}&lt;/strong&gt;&quot;],&quot;footer.case_studies&quot;:[0,&quot;Case Studies&quot;],&quot;footer.connect_2024&quot;:[0,&quot;Connect 2024&quot;],&quot;footer.terms_of_use&quot;:[0,&quot;Terms of Use&quot;],&quot;footer.white_papers&quot;:[0,&quot;White Papers&quot;],&quot;footer.cloudflare_tv&quot;:[0,&quot;Cloudflare TV&quot;],&quot;footer.community_hub&quot;:[0,&quot;Community Hub&quot;],&quot;footer.compare_plans&quot;:[0,&quot;Compare plans&quot;],&quot;footer.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.email_address&quot;:[0,&quot;Email Address&quot;],&quot;page.error.not_found&quot;:[0,&quot;Page not found&quot;],&quot;footer.developer_docs&quot;:[0,&quot;Developer docs&quot;],&quot;footer.privacy_policy&quot;:[0,&quot;Privacy Policy&quot;],&quot;footer.request_a_demo&quot;:[0,&quot;Request a demo&quot;],&quot;page.continue_reading&quot;:[0,&quot;Continue reading&quot;],&quot;footer.analysts_report&quot;:[0,&quot;Analyst reports&quot;],&quot;footer.for_enterprises&quot;:[0,&quot;For enterprises&quot;],&quot;footer.getting_started&quot;:[0,&quot;Getting Started&quot;],&quot;footer.learning_center&quot;:[0,&quot;Learning Center&quot;],&quot;footer.project_galileo&quot;:[0,&quot;Project Galileo&quot;],&quot;pagination.newer_posts&quot;:[0,&quot;Newer Posts&quot;],&quot;pagination.older_posts&quot;:[0,&quot;Older Posts&quot;],&quot;posts.social_buttons.x&quot;:[0,&quot;Discuss on X&quot;],&quot;search.icon_aria_label&quot;:[0,&quot;Search&quot;],&quot;search.source_location&quot;:[0,&quot;Source/Location&quot;],&quot;footer.about_cloudflare&quot;:[0,&quot;About Cloudflare&quot;],&quot;footer.athenian_project&quot;:[0,&quot;Athenian Project&quot;],&quot;footer.become_a_partner&quot;:[0,&quot;Become a partner&quot;],&quot;footer.cloudflare_radar&quot;:[0,&quot;Cloudflare Radar&quot;],&quot;footer.network_services&quot;:[0,&quot;Network services&quot;],&quot;footer.trust_and_safety&quot;:[0,&quot;Trust &amp; Safety&quot;],&quot;header.get_started_free&quot;:[0,&quot;Get Started Free&quot;],&quot;page.search.placeholder&quot;:[0,&quot;Search Cloudflare&quot;],&quot;footer.cloudflare_status&quot;:[0,&quot;Cloudflare Status&quot;],&quot;footer.cookie_preference&quot;:[0,&quot;Cookie Preferences&quot;],&quot;header.valid_email_error&quot;:[0,&quot;Must be valid email.&quot;],&quot;search.result_stat_empty&quot;:[0,&quot;Results &lt;strong&gt;{search_range}&lt;/strong&gt; of &lt;strong&gt;{search_total}&lt;/strong&gt;&quot;],&quot;footer.connectivity_cloud&quot;:[0,&quot;Connectivity cloud&quot;],&quot;footer.developer_services&quot;:[0,&quot;Developer services&quot;],&quot;footer.investor_relations&quot;:[0,&quot;Investor relations&quot;],&quot;page.not_found.error_code&quot;:[0,&quot;Error Code: 404&quot;],&quot;search.autocomplete_title&quot;:[0,&quot;Insert a query. Press enter to send&quot;],&quot;footer.logos_and_press_kit&quot;:[0,&quot;Logos &amp; press kit&quot;],&quot;footer.application_services&quot;:[0,&quot;Application services&quot;],&quot;footer.get_a_recommendation&quot;:[0,&quot;Get a recommendation&quot;],&quot;posts.social_buttons.reddit&quot;:[0,&quot;Discuss on Reddit&quot;],&quot;footer.sse_and_sase_services&quot;:[0,&quot;SSE and SASE services&quot;],&quot;page.not_found.outdated_link&quot;:[0,&quot;You may have used an outdated link, or you may have typed the address incorrectly.&quot;],&quot;footer.report_security_issues&quot;:[0,&quot;Report Security Issues&quot;],&quot;page.error.error_message_page&quot;:[0,&quot;Sorry, we can't find the page you are looking for.&quot;],&quot;header.subscribe_notifications&quot;:[0,&quot;Subscribe to receive notifications of new posts:&quot;],&quot;footer.cloudflare_for_campaigns&quot;:[0,&quot;Cloudflare for Campaigns&quot;],&quot;header.subscription_confimation&quot;:[0,&quot;Subscription confirmed. Thank you for subscribing!&quot;],&quot;posts.social_buttons.hackernews&quot;:[0,&quot;Discuss on Hacker News&quot;],&quot;footer.diversity_equity_inclusion&quot;:[0,&quot;Diversity, equity &amp; inclusion&quot;],&quot;footer.critical_infrastructure_defense_project&quot;:[0,&quot;Critical Infrastructure Defense Project&quot;]}]}" client="idle" opts="{&quot;name&quot;:&quot;NavigationComponent&quot;,&quot;value&quot;:true}" await-children=""><header class="flex flex-row flex-wrap justify-between items-flex-end mw8 center mv3 pl3 pr1"><div class="w-100 flex items-flex-end justify-between justify-start-l"><div class="w-100 tr flex justify-end"><div class="flex justify-between items-center"><span class="dn di-l pr1"><a href="https://dash.cloudflare.com/sign-up" class="f1 blue1 dn di-l b no-underline underline-hover" target="_blank" rel="noreferrer">Get Started Free</a></span><span class="f1 gray4 dn di-l pr1">|</span><span class="dn di-l"><a target="_blank" href="https://www.cloudflare.com/plans/enterprise/contact/" class="f1 gray4 no-underline underline-hover pr1" rel="noreferrer">Contact Sales</a></span></div></div></div><div class="w-100 w-50-l flex items-end nb5 nb1-l"><a href="https://blog.cloudflare.com/" class="header-logo mr4 dn db-l"><img class="header-logo" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/CF_logo_stacked_blktype.webp" alt="The Cloudflare Blog" width="170" height="57"></a><h2 class="mt0 mb1 dn di-l"><a href="https://blog.cloudflare.com/" class="fw5 f5 gray3 no-underline"><span class="dn di-l">The Cloudflare Blog</span></a></h2></div><div class="w-100 w-50-l dn db-l"><div class="w-100 tr mkto-sub-message"><p class="f2">Subscribe to receive notifications of new posts:</p></div><div class="w-100 tr"><div class="marketo-form-container"><form id="mktoForm_1653"><div class="top-subscribe-form-container"><div class="top-subscribe-form-field"><input placeholder="Email Address" class="top-subscribe-form-input" name="email" type="email" title="Must be valid email."></div><button class="top-subscribe-form-button" type="button">Subscribe</button></div></form></div></div></div></header><nav dir="ltr" class="bb b--black-10 db dn-l w-100 ph3 "><div class=" flex justify-between items-center" style="height:44px"><a href="https://blog.cloudflare.com/search/"><img class="h-6 w-6" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/magnifier.svg" alt="magnifier icon"></a><button type="button" style="background:transparent;border:none"><img src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/hamburger.svg" alt="hamburger menu"></button></div><div class="js-mobile-nav-container dn"><div class="flex flex-column flex-wrap bg-gray9 o-95 absolute w-90 ph3 z-1"><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/zero-trust/" class="no-underline gray1 f4 fw7">Zero Trust</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/cloudflare-radar/" class="no-underline gray1 f4 fw7">Radar</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/security/" class="no-underline gray1 f4 fw7">Security</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/ai/" class="no-underline gray1 f4 fw7">AI</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/product-news/" class="no-underline gray1 f4 fw7">Product News</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/developers/" class="no-underline gray1 f4 fw7">Developers</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/speed-and-reliability/" class="no-underline gray1 f4 fw7">Speed &amp; Reliability</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/partners/" class="no-underline gray1 f4 fw7">Partners</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/life-at-cloudflare/" class="no-underline gray1 f4 fw7">Life at Cloudflare</a></div><div class="pv3 ph2 tl"><a href="https://blog.cloudflare.com/tag/policy/" class="no-underline gray1 f4 fw7">Policy &amp; Legal</a></div></div></div></nav><nav id="nav" class="w-100 bb-0 bb-l b--black-10 z-1"><div id="desktop-nav-items-container" class="flex flex-wrap justify-between items-center mw8 center mv3 mv0-l"><div data-tag="zero-trust" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/zero-trust/" class="no-underline gray1 f2 fw5 pv3">Zero Trust</a></div><div data-tag="cloudflare-radar" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/cloudflare-radar/" class="no-underline gray1 f2 fw5 pv3">Radar</a></div><div data-tag="security" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/security/" class="no-underline gray1 f2 fw5 pv3">Security</a></div><div data-tag="ai" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/ai/" class="no-underline gray1 f2 fw5 pv3">AI</a></div><div data-tag="product-news" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/product-news/" class="no-underline gray1 f2 fw5 pv3">Product News</a></div><div data-tag="developers" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/developers/" class="no-underline gray1 f2 fw5 pv3">Developers</a></div><div data-tag="speed-and-reliability" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/speed-and-reliability/" class="no-underline gray1 f2 fw5 pv3">Speed &amp; Reliability</a></div><div data-tag="partners" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/partners/" class="no-underline gray1 f2 fw5 pv3">Partners</a></div><div data-tag="life-at-cloudflare" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/life-at-cloudflare/" class="no-underline gray1 f2 fw5 pv3">Life at Cloudflare</a></div><div data-tag="policy" class="nav-item nav-item-desktop ml3 mr2 dn db-l pv3"><a href="https://blog.cloudflare.com/tag/policy/" class="no-underline gray1 f2 fw5 pv3">Policy &amp; Legal</a></div><div class="nav-item ml2 mr3 dn db-l pv3" data-tag="search icon"><a href="https://blog.cloudflare.com/search/"><img id="search-icon" class="h-6 w-6" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/magnifier.svg" alt="magnifier icon"></a></div></div></nav></astro-island><progress class="reading-progress" value="0" max="100" aria-label="Reading progress"></progress><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();</script><astro-island uid="Z1iuthz" prefix="r1" component-url="/_astro/Post.CgzUE9si.js" component-export="Post" renderer-url="/_astro/client.DLO1yDVm.js" props="{&quot;post&quot;:[0,{&quot;id&quot;:[0,&quot;6bGK0NoXnHBGOjKvJ60FRu&quot;],&quot;title&quot;:[0,&quot;How to execute an object file: part 4, AArch64 edition&quot;],&quot;slug&quot;:[0,&quot;how-to-execute-an-object-file-part-4&quot;],&quot;excerpt&quot;:[0,&quot;The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;\n            &lt;figure class=\&quot;kg-card kg-image-card \&quot;&gt;\n            \n            &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5Ih4pvbZshdUy2ihfodYAU/7800842ad2c0270609b36a8a99d0ceb4/image1-1.png\&quot; alt=\&quot;How to execute an object file: part 4, AArch64 edition\&quot; class=\&quot;kg-image\&quot; width=\&quot;1999\&quot; height=\&quot;1125\&quot; loading=\&quot;lazy\&quot;/&gt;\n            \n            &lt;/figure&gt;&lt;p&gt;Translating source code written in a high-level programming language into an executable binary typically involves a series of steps, namely compiling and assembling the code into object files, and then linking those object files into the final executable. However, there are certain scenarios where it can be useful to apply an alternate approach that involves executing object files directly, bypassing the linker. For example, we might use it for malware analysis or when part of the code requires an incompatible compiler. We’ll be focusing on the latter scenario: when one of our libraries needed to be compiled differently from the rest of the code. Learning how to execute an object file directly will give you a much better sense of how code is compiled and linked together.&lt;/p&gt;&lt;p&gt;To demonstrate how this was done, we have previously published a series of posts on executing an object file:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;a href=\&quot;/how-to-execute-an-object-file-part-1/\&quot;&gt;How to execute an object file: Part 1&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;How to execute an object file: Part 2&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;a href=\&quot;/how-to-execute-an-object-file-part-3/\&quot;&gt;How to execute an object file: Part 3&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;The initial posts are dedicated to the x86 architecture. Since then the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture. You can pause here to read the previous blog posts before proceeding with this one, or read through the brief summary below and reference the earlier posts for more detail. We might reiterate some theory as working with ELF files can be daunting, if it’s not your day-to-day routine. Also, please be mindful that for simplicity, these examples omit bounds and integrity checks. Let the journey begin!&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;introduction\&quot;&gt;Introduction&lt;/h2&gt;\n            &lt;a href=\&quot;#introduction\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;In order to obtain an object file or an executable binary from a high-level compiled programming language the code needs to be processed by three components: compiler, assembler and linker. The compiler generates an assembly listing. This assembly listing is picked up by the assembler and translated into an object file. All source files, if a program contains multiple, go through these two steps generating an object file for each source file. At the final step the linker unites all object files into one binary, additionally resolving references to the shared libraries (i.e. we don’t implement the &lt;code&gt;printf&lt;/code&gt; function each time, rather we take it from a system library). Even though the approach is platform independent, the compiler output varies by platform as the assembly listing is closely tied to the CPU architecture.&lt;/p&gt;&lt;p&gt;GCC (GNU Compiler Collection) can run each step: compiler, assembler and linker separately for us:&lt;/p&gt;&lt;p&gt;main.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;#include &amp;lt;stdio.h&amp;gt;\n\nint main(void)\n{\n\tputs(&amp;quot;Hello, world!&amp;quot;);\n\treturn 0;\n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compiler (output &lt;code&gt;main.s&lt;/code&gt; - assembly listing):&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -S main.c\n$ ls\nmain.c  main.s&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Assembler (output &lt;code&gt;main.o&lt;/code&gt; - an object file):&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -c main.s -o main.o\n$ ls\nmain.c  main.o  main.s&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Linker (&lt;code&gt;main&lt;/code&gt; - an object file):&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc main.o -o main\n$ ls\nmain  main.c  main.o  main.s\n$ ./main\nHello, world!&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;All the examples assume gcc is running on a native aarch64 architecture or include a cross compilation flag for those who want to reproduce and have no aarch64.&lt;/p&gt;&lt;p&gt;We have two object files in the output above: &lt;code&gt;main.o&lt;/code&gt; and &lt;code&gt;main&lt;/code&gt;. Object files are files encoded with the &lt;a href=\&quot;https://en.wikipedia.org/wiki/Executable_and_Linkable_Format\&quot;&gt;ELF (Executable and Linkable Format)&lt;/a&gt; standard. Although, &lt;code&gt;main.o&lt;/code&gt; is an ELF file, it doesn’t contain all the information to be fully executable.&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ file main.o\nmain.o: ELF 64-bit LSB relocatable, ARM aarch64, version 1 (SYSV), not stripped\n\n$ file main\nmain: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically\nlinked, interpreter /lib/ld-linux-aarch64.so.1,\nBuildID[sha1]=d3ecd2f8ac3b2dec11ed4cc424f15b3e1f130dd4, for GNU/Linux 3.7.0, not stripped&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;the-elf-file\&quot;&gt;The ELF File&lt;/h2&gt;\n            &lt;a href=\&quot;#the-elf-file\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;The central idea of this series of blog posts is to understand how to resolve dependencies from object files without directly involving the linker. For illustrative purposes we generated an object file based on some C-code and used it as a library for our main program. Before switching to the code, we need to understand the basics of the ELF structure.&lt;/p&gt;&lt;p&gt;Each ELF file is made up of one &lt;i&gt;ELF header&lt;/i&gt;, followed by file data. The data can include: a &lt;i&gt;program header&lt;/i&gt; table, a &lt;i&gt;section header&lt;/i&gt; table, and the data which is referred to by the program or section header tables.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;the-elf-header\&quot;&gt;The ELF Header&lt;/h3&gt;\n            &lt;a href=\&quot;#the-elf-header\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;The ELF header provides some basic information about the file: what architecture the file is compiled for, the program entry point and the references to other tables.&lt;/p&gt;&lt;p&gt;The ELF Header:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf -h main\nELF Header:\n  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 \n  Class:                             ELF64\n  Data:                              2&amp;#039;s complement, little endian\n  Version:                           1 (current)\n  OS/ABI:                            UNIX - System V\n  ABI Version:                       0\n  Type:                              DYN (Position-Independent Executable file)\n  Machine:                           AArch64\n  Version:                           0x1\n  Entry point address:               0x640\n  Start of program headers:          64 (bytes into file)\n  Start of section headers:          68576 (bytes into file)\n  Flags:                             0x0\n  Size of this header:               64 (bytes)\n  Size of program headers:           56 (bytes)\n  Number of program headers:         9\n  Size of section headers:           64 (bytes)\n  Number of section headers:         29\n  Section header string table index: 28&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;the-elf-program-header\&quot;&gt;The ELF Program Header&lt;/h3&gt;\n            &lt;a href=\&quot;#the-elf-program-header\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;The execution process of almost every program starts from an auxiliary program, called loader, which arranges the memory and calls the program’s entry point. In the following output the loader is marked with a line &lt;code&gt;“Requesting program interpreter: /lib/ld-linux-aarch64.so.1”&lt;/code&gt;. The whole program memory is split into different segments with associated size, permissions and type (which instructs the loader on how to interpret this block of memory). Because the execution process should be performed in the shortest possible time, the &lt;i&gt;sections&lt;/i&gt; with the same characteristics and located nearby are grouped into bigger blocks — &lt;i&gt;segments&lt;/i&gt; — and placed in the &lt;i&gt;program header&lt;/i&gt;. We can say that the &lt;i&gt;program header&lt;/i&gt; summarizes the types of data that appear in the &lt;i&gt;section header&lt;/i&gt;.&lt;/p&gt;&lt;p&gt;The ELF Program Header:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf -Wl main\n\nElf file type is DYN (Position-Independent Executable file)\nEntry point 0x640\nThere are 9 program headers, starting at offset 64\n\nProgram Headers:\n  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align\n  PHDR           0x000040 0x0000000000000040 0x0000000000000040 0x0001f8 0x0001f8 R   0x8\n  INTERP         0x000238 0x0000000000000238 0x0000000000000238 0x00001b 0x00001b R   0x1\n      [Requesting program interpreter: /lib/ld-linux-aarch64.so.1]\n  LOAD           0x000000 0x0000000000000000 0x0000000000000000 0x00088c 0x00088c R E 0x10000\n  LOAD           0x00fdc8 0x000000000001fdc8 0x000000000001fdc8 0x000270 0x000278 RW  0x10000\n  DYNAMIC        0x00fdd8 0x000000000001fdd8 0x000000000001fdd8 0x0001e0 0x0001e0 RW  0x8\n  NOTE           0x000254 0x0000000000000254 0x0000000000000254 0x000044 0x000044 R   0x4\n  GNU_EH_FRAME   0x0007a0 0x00000000000007a0 0x00000000000007a0 0x00003c 0x00003c R   0x4\n  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RW  0x10\n  GNU_RELRO      0x00fdc8 0x000000000001fdc8 0x000000000001fdc8 0x000238 0x000238 R   0x1\n\n Section to Segment mapping:\n  Segment Sections...\n   00     \n   01     .interp \n   02     .interp .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .text .fini .rodata .eh_frame_hdr .eh_frame \n   03     .init_array .fini_array .dynamic .got .got.plt .data .bss \n   04     .dynamic \n   05     .note.gnu.build-id .note.ABI-tag \n   06     .eh_frame_hdr \n   07     \n   08     .init_array .fini_array .dynamic .got &lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;the-elf-section-header\&quot;&gt;The ELF Section Header&lt;/h3&gt;\n            &lt;a href=\&quot;#the-elf-section-header\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;In the source code of high-level languages, variables, functions, and constants are mixed together. However, in assembly you might see that the data and instructions are separated into different blocks. The ELF file content is divided in an even more granular way. For example, variables with initial values are placed into different sections than the uninitialized ones. This approach optimizes for space, otherwise the values for uninitialized variables would be filled with zeros. Along with the space efficiency, there are security reasons for stratification — executable instructions can’t have writable permissions, while memory containing variables can&amp;#39;t be executable. The section header describes each of these sections.&lt;/p&gt;&lt;p&gt;The ELF Section Header:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf -SW main\nThere are 29 section headers, starting at offset 0x10be0:\n\nSection Headers:\n  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al\n  [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0\n  [ 1] .interp           PROGBITS        0000000000000238 000238 00001b 00   A  0   0  1\n  [ 2] .note.gnu.build-id NOTE            0000000000000254 000254 000024 00   A  0   0  4\n  [ 3] .note.ABI-tag     NOTE            0000000000000278 000278 000020 00   A  0   0  4\n  [ 4] .gnu.hash         GNU_HASH        0000000000000298 000298 00001c 00   A  5   0  8\n  [ 5] .dynsym           DYNSYM          00000000000002b8 0002b8 0000f0 18   A  6   3  8\n  [ 6] .dynstr           STRTAB          00000000000003a8 0003a8 000092 00   A  0   0  1\n  [ 7] .gnu.version      VERSYM          000000000000043a 00043a 000014 02   A  5   0  2\n  [ 8] .gnu.version_r    VERNEED         0000000000000450 000450 000030 00   A  6   1  8\n  [ 9] .rela.dyn         RELA            0000000000000480 000480 0000c0 18   A  5   0  8\n  [10] .rela.plt         RELA            0000000000000540 000540 000078 18  AI  5  22  8\n  [11] .init             PROGBITS        00000000000005b8 0005b8 000018 00  AX  0   0  4\n  [12] .plt              PROGBITS        00000000000005d0 0005d0 000070 00  AX  0   0 16\n  [13] .text             PROGBITS        0000000000000640 000640 000134 00  AX  0   0 64\n  [14] .fini             PROGBITS        0000000000000774 000774 000014 00  AX  0   0  4\n  [15] .rodata           PROGBITS        0000000000000788 000788 000016 00   A  0   0  8\n  [16] .eh_frame_hdr     PROGBITS        00000000000007a0 0007a0 00003c 00   A  0   0  4\n  [17] .eh_frame         PROGBITS        00000000000007e0 0007e0 0000ac 00   A  0   0  8\n  [18] .init_array       INIT_ARRAY      000000000001fdc8 00fdc8 000008 08  WA  0   0  8\n  [19] .fini_array       FINI_ARRAY      000000000001fdd0 00fdd0 000008 08  WA  0   0  8\n  [20] .dynamic          DYNAMIC         000000000001fdd8 00fdd8 0001e0 10  WA  6   0  8\n  [21] .got              PROGBITS        000000000001ffb8 00ffb8 000030 08  WA  0   0  8\n  [22] .got.plt          PROGBITS        000000000001ffe8 00ffe8 000040 08  WA  0   0  8\n  [23] .data             PROGBITS        0000000000020028 010028 000010 00  WA  0   0  8\n  [24] .bss              NOBITS          0000000000020038 010038 000008 00  WA  0   0  1\n  [25] .comment          PROGBITS        0000000000000000 010038 00001f 01  MS  0   0  1\n  [26] .symtab           SYMTAB          0000000000000000 010058 000858 18     27  66  8\n  [27] .strtab           STRTAB          0000000000000000 0108b0 00022c 00      0   0  1\n  [28] .shstrtab         STRTAB          0000000000000000 010adc 000103 00      0   0  1\nKey to Flags:\n  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),\n  L (link order), O (extra OS processing required), G (group), T (TLS),\n  C (compressed), x (unknown), o (OS specific), E (exclude),\n  D (mbind), p (processor specific)&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;executing-example-from-part-1-on-aarch64\&quot;&gt;Executing example from Part 1 on aarch64&lt;/h2&gt;\n            &lt;a href=\&quot;#executing-example-from-part-1-on-aarch64\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Actually, our &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/1\&quot;&gt;initial code&lt;/a&gt; from &lt;a href=\&quot;/how-to-execute-an-object-file-part-1/\&quot;&gt;Part 1&lt;/a&gt; works on aarch64 as is!&lt;/p&gt;&lt;p&gt;Let’s have a quick summary about what was done in the code:&lt;/p&gt;&lt;ol&gt;&lt;li&gt;&lt;p&gt;We need to find the code of two functions (&lt;code&gt;add5&lt;/code&gt; and &lt;code&gt;add10&lt;/code&gt;) in the &lt;code&gt;.text&lt;/code&gt; section of our object file (&lt;code&gt;obj.o&lt;/code&gt;)&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Load the functions in the executable memory&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;Return the memory locations of the functions to the main program&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;There is one nuance: even though all the sections are in the section header, neither of them have a string name. Without the names we can’t identify them. However, having an additional character field for each section in the ELF structure would be inefficient for the space — it must be limited by some maximum length and those names which are shorter would leave the space unfilled. Instead, ELF provides an additional section, &lt;code&gt;.shstrtab&lt;/code&gt;. This string table concatenates all the names where each name ends with a null terminated byte. We can iterate over the names and match with an offset held by other sections to reference their name. But how do we find &lt;code&gt;.shstrtab&lt;/code&gt; itself if we don’t have a name? To solve this chicken and egg problem, the ELF program header provides a direct pointer to &lt;code&gt;.shstrtab&lt;/code&gt;. The similar approach is applied to two other sections: &lt;code&gt;.symtab&lt;/code&gt; and &lt;code&gt;.strtab&lt;/code&gt;. Where &lt;code&gt;.symtab&lt;/code&gt; contains all information about the symbols and &lt;code&gt;.strtab&lt;/code&gt; holds the list of symbol names. In the code we work with these tables to resolve all their dependencies and find our functions.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;executing-example-from-part-2-on-aarch64\&quot;&gt;Executing example from Part 2 on aarch64&lt;/h2&gt;\n            &lt;a href=\&quot;#executing-example-from-part-2-on-aarch64\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;At the beginning of the second blog post on &lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;how to execute an object file&lt;/a&gt; we made the function &lt;code&gt;add10&lt;/code&gt; depend on &lt;code&gt;add5&lt;/code&gt; instead of being self-contained. This is the first time when we faced relocations. &lt;i&gt;Relocations&lt;/i&gt; is the process of loading symbols defined outside the current scope. The relocated symbols can present global or thread-local variables, constant, functions, etc. We’ll start from checking assembly instructions which trigger relocations and uncovering how the ELF format handles them in a more general way.&lt;/p&gt;&lt;p&gt;After making &lt;code&gt;add10&lt;/code&gt; depend on &lt;code&gt;add5&lt;/code&gt; our aarch64 version stopped working as well, similarly to the x86. Let’s take a look at assembly listing:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ objdump --disassemble --section=.text obj.o\n\nobj.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;add5&amp;gt;:\n   0:\td10043ff \tsub\tsp, sp, #0x10\n   4:\tb9000fe0 \tstr\tw0, [sp, #12]\n   8:\tb9400fe0 \tldr\tw0, [sp, #12]\n   c:\t11001400 \tadd\tw0, w0, #0x5\n  10:\t910043ff \tadd\tsp, sp, #0x10\n  14:\td65f03c0 \tret\n\n0000000000000018 &amp;lt;add10&amp;gt;:\n  18:\ta9be7bfd \tstp\tx29, x30, [sp, #-32]!\n  1c:\t910003fd \tmov\tx29, sp\n  20:\tb9001fe0 \tstr\tw0, [sp, #28]\n  24:\tb9401fe0 \tldr\tw0, [sp, #28]\n  28:\t94000000 \tbl\t0 &amp;lt;add5&amp;gt;\n  2c:\tb9001fe0 \tstr\tw0, [sp, #28]\n  30:\tb9401fe0 \tldr\tw0, [sp, #28]\n  34:\t94000000 \tbl\t0 &amp;lt;add5&amp;gt;\n  38:\ta8c27bfd \tldp\tx29, x30, [sp], #32\n  3c:\td65f03c0 \tret&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Have you noticed that all the hex values in the second column are exactly the same length, in contrast with the instructions lengths seen for x86 in Part 2 of our series? This is because all Armv8-A instructions are presented in 32 bits. Since it is impossible to encode every immediate value into less than 32 bits, some operations require more than one instruction, as we’ll see later. For now, we’re interested in one instruction &lt;code&gt;- bl&lt;/code&gt; (&lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BL--Branch-with-Link-?lang=en\&quot;&gt;branch with link&lt;/a&gt;) on rows &lt;code&gt;28&lt;/code&gt; and &lt;code&gt;34&lt;/code&gt;. The &lt;code&gt;bl&lt;/code&gt; is a “jump” instruction, but before the jump it preserves the next instruction after the current one in the link register (&lt;code&gt;lr&lt;/code&gt;). When the callee finishes execution the caller address is recovered from &lt;code&gt;lr&lt;/code&gt;. Usually, the aarch64 instructions reserve the last 6 bits [31:26] for opcode and some auxiliary fields such as running architecture (32 or 64 bits), condition flag and others. Remaining bits are shared between arguments like source register, destination register and immediate value. Since the &lt;code&gt;bl&lt;/code&gt; instruction does not require a source or destination register, the full 26 bits can be used to encode the immediate offset instead. However, 26 bits can only encode a small range (+/-32 MB), but because the jump can only target a beginning of an instruction, it must always be aligned to 4 bytes, which increases the effective range of the encoded immediate fourfold, to +/-128 MB.&lt;/p&gt;&lt;p&gt;Similarly to what we did in &lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;Part 2&lt;/a&gt; we’re going to resolve our relocations - first by manually calculating the correct addresses and then by using an approach similar to what the linker does. The current value of our &lt;code&gt;bl&lt;/code&gt; instruction is &lt;code&gt;94000000&lt;/code&gt; or in binary representation &lt;code&gt;100101**00000000000000000000000000**&lt;/code&gt;. All 26 bits are zeros, so we don&amp;#39;t jump anywhere. The address is calculated by an offset from the current &lt;i&gt;program counter&lt;/i&gt; (&lt;code&gt;pc&lt;/code&gt;), which can be positive or negative. In our case we expect it to be &lt;code&gt;-0x28&lt;/code&gt; and &lt;code&gt;-0x34&lt;/code&gt;. As described above, it should be divided by 4 and taken as &lt;a href=\&quot;https://en.wikipedia.org/wiki/Two%27s_complement\&quot;&gt;two&amp;#39;s complements&lt;/a&gt;: &lt;code&gt;-0x28 / 4 = -0xA == 0xFFFFFFF6&lt;/code&gt; and &lt;code&gt;-0x34 / 4 = -0xD == 0xFFFFFFF3&lt;/code&gt;. From these values we need to take the lower 26 bits and concatenate them with the initial 6 bits to get the final instruction. So, the final ones will be: &lt;code&gt;100101**11111111111111111111110110** == 0x97FFFFF6&lt;/code&gt; and &lt;code&gt;100101**11111111111111111111110011** == 0x97FFFFF3&lt;/code&gt;. Have you noticed that all the distance calculations are done relative to the &lt;code&gt;bl&lt;/code&gt; (or current &lt;code&gt;pc&lt;/code&gt;), not the next instruction as in x86?&lt;/p&gt;&lt;p&gt;Let’s add to the code and execute:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;... \n\nstatic void parse_obj(void)\n{\n\t...\n\t/* copy the contents of `.text` section from the ELF file */\n\tmemcpy(text_runtime_base, obj.base + text_hdr-&amp;gt;sh_offset, text_hdr-&amp;gt;sh_size);\n\n\t*((uint32_t *)(text_runtime_base + 0x28)) = 0x97FFFFF6;\n\t*((uint32_t *)(text_runtime_base + 0x34)) = 0x97FFFFF3;\n\n\t/* make the `.text` copy readonly and executable */\n\tif (mprotect(text_runtime_base, page_align(text_hdr-&amp;gt;sh_size), PROT_READ | PROT_EXEC)) {\n\t...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compile and run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c\n$ ./loader\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;It works! But this is not how the linker handles the relocations. The linker resolves relocation based on the type and formula assigned to this type. In our &lt;a href=\&quot;/how-to-execute-an-object-file-part-2/\&quot;&gt;Part 2&lt;/a&gt; we investigated it quite well. Here again we need to find the type and check the formula for this type:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf --relocs obj.o\n\nRelocation section &amp;#039;.rela.text&amp;#039; at offset 0x228 contains 2 entries:\n  Offset          Info           Type           Sym. Value    Sym. Name + Addend\n000000000028  000a0000011b R_AARCH64_CALL26  0000000000000000 add5 + 0\n000000000034  000a0000011b R_AARCH64_CALL26  0000000000000000 add5 + 0\n\nRelocation section &amp;#039;.rela.eh_frame&amp;#039; at offset 0x258 contains 2 entries:\n  Offset          Info           Type           Sym. Value    Sym. Name + Addend\n00000000001c  000200000105 R_AARCH64_PREL32  0000000000000000 .text + 0\n000000000034  000200000105 R_AARCH64_PREL32  0000000000000000 .text + 18&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Our Type is R_AARCH64_CALL26 and the &lt;a href=\&quot;https://github.com/ARM-software/abi-aa/blob/main/aaelf64/aaelf64.rst#5733relocation-operations\&quot;&gt;formula&lt;/a&gt; for it is:&lt;/p&gt;&lt;!--kg-card-begin: html--&gt;&lt;table cellspacing=\&quot;0\&quot; style=\&quot;border-collapse:collapse; border:none; width:100%\&quot;&gt;\n\t&lt;tbody&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;ELF64 Code&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:179px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Name&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:145px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Operation&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;283&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:179px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;R_&amp;lt;CLS&amp;gt;_CALL26&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:145px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;S + A - P&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t&lt;/tbody&gt;\n&lt;/table&gt;&lt;!--kg-card-end: html--&gt;&lt;p&gt;where:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;S&lt;/code&gt; (when used on its own) is the address of the symbol&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;A&lt;/code&gt; is the addend for the relocation&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;code&gt;P&lt;/code&gt; is the address of the place being relocated (derived from &lt;code&gt;r_offset&lt;/code&gt;)&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Here are the relevant changes to loader.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;/* Replace `#define R_X86_64_PLT32 4` with our Type */\n#define R_AARCH64_CALL26 283\n...\n\nstatic void do_text_relocations(void)\n{\n\t...\n\tuint32_t val;\n\n\tswitch (type)\n\t{\n\tcase R_AARCH64_CALL26:\n\t\t/* The mask separates opcode (6 bits) and the immediate value */\n\t\tuint32_t mask_bl = (0xffffffff &amp;lt;&amp;lt; 26);\n\t\t/* S+A-P, divided by 4 */\n\t\tval = (symbol_address + relocations[i].r_addend - patch_offset) &amp;gt;&amp;gt; 2;\n\t\t/* Concatenate opcode and value to get final instruction */\n\t\t*((uint32_t *)patch_offset) &amp;amp;= mask_bl;\n\t\tval &amp;amp;= ~mask_bl;\n\t\t*((uint32_t *)patch_offset) |= val;\n\t\tbreak;\n\t}\n\t...\n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compile and run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c \n$ ./loader\nCalculated relocation: 0x97fffff6\nCalculated relocation: 0x97fffff3\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;So far so good. The next challenge is to &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/2/obj.c#L16-L31\&quot;&gt;add constant data and global variables&lt;/a&gt; to our object file and check relocations again:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ readelf --relocs --wide obj.o\n\nRelocation section &amp;#039;.rela.text&amp;#039; at offset 0x388 contains 8 entries:\n    Offset             Info             Type               Symbol&amp;#039;s Value  Symbol&amp;#039;s Name + Addend\n0000000000000000  0000000500000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .rodata + 0\n0000000000000004  0000000500000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .rodata + 0\n000000000000000c  0000000300000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .data + 0\n0000000000000010  0000000300000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .data + 0\n0000000000000024  0000000300000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .data + 0\n0000000000000028  0000000300000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .data + 0\n0000000000000068  000000110000011b R_AARCH64_CALL26       0000000000000040 add5 + 0\n0000000000000074  000000110000011b R_AARCH64_CALL26       0000000000000040 add5 + 0\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;We have even two new relocations: &lt;code&gt;R_AARCH64_ADD_ABS_LO12_NC&lt;/code&gt; and &lt;code&gt;R_AARCH64_ADR_PREL_PG_HI21&lt;/code&gt;. Their formulas are:&lt;/p&gt;&lt;!--kg-card-begin: html--&gt;&lt;table cellspacing=\&quot;0\&quot; style=\&quot;border-collapse:collapse; border:none; width:100%\&quot;&gt;\n\t&lt;tbody&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;ELF64 Code&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:237px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Name&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:221px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;&lt;b&gt;Operation&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;&lt;span style=\&quot;background-color:#ffffff\&quot;&gt;275&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:237px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;&lt;span style=\&quot;background-color:#ffffff\&quot;&gt;R_&amp;lt;CLS&amp;gt;_ ADR_PREL_PG_HI21&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:221px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;&lt;span style=\&quot;background-color:#ffffff\&quot;&gt;Page(S+A) - Page(P)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t\t&lt;tr&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:98px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#1f2328\&quot;&gt;277&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:237px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;R_&amp;lt;CLS&amp;gt;_ ADD_ABS_LO12_NC&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t\t&lt;td style=\&quot;vertical-align:top; width:221px\&quot;&gt;\n\t\t\t&lt;p&gt;&lt;span style=\&quot;font-size:9pt\&quot;&gt;&lt;span style=\&quot;font-family:'Courier New',monospace\&quot;&gt;&lt;span style=\&quot;color:#000000\&quot;&gt;S + A&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;\n\t\t\t&lt;/td&gt;\n\t\t&lt;/tr&gt;\n\t&lt;/tbody&gt;\n&lt;/table&gt;&lt;!--kg-card-end: html--&gt;&lt;p&gt;where:&lt;/p&gt;&lt;p&gt;&lt;code&gt;Page(expr)&lt;/code&gt; is the page address of the expression expr, defined as &lt;code&gt;(expr &amp;amp; ~0xFFF)&lt;/code&gt;. (This applies even if the machine page size supported by the platform has a different value.)&lt;/p&gt;&lt;p&gt;It’s a bit unclear why we have two new types, while in x86 we had only one. Let’s investigate the assembly code:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ objdump --disassemble --section=.text obj.o\n\nobj.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;get_hello&amp;gt;:\n   0:\t90000000 \tadrp\tx0, 0 &amp;lt;get_hello&amp;gt;\n   4:\t91000000 \tadd\tx0, x0, #0x0\n   8:\td65f03c0 \tret\n\n000000000000000c &amp;lt;get_var&amp;gt;:\n   c:\t90000000 \tadrp\tx0, 0 &amp;lt;get_hello&amp;gt;\n  10:\t91000000 \tadd\tx0, x0, #0x0\n  14:\tb9400000 \tldr\tw0, [x0]\n  18:\td65f03c0 \tret\n\n000000000000001c &amp;lt;set_var&amp;gt;:\n  1c:\td10043ff \tsub\tsp, sp, #0x10\n  20:\tb9000fe0 \tstr\tw0, [sp, #12]\n  24:\t90000000 \tadrp\tx0, 0 &amp;lt;get_hello&amp;gt;\n  28:\t91000000 \tadd\tx0, x0, #0x0\n  2c:\tb9400fe1 \tldr\tw1, [sp, #12]\n  30:\tb9000001 \tstr\tw1, [x0]\n  34:\td503201f \tnop\n  38:\t910043ff \tadd\tsp, sp, #0x10\n  3c:\td65f03c0 \tret&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;We see that all &lt;code&gt;adrp&lt;/code&gt; instructions are followed by &lt;code&gt;add&lt;/code&gt; instructions. The &lt;code&gt;[add](https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADD--immediate---Add--immediate--?lang=en)&lt;/code&gt; instruction adds an immediate value to the source register and writes the result to the destination register. The source and destination registers can be the same, the immediate value is 12 bits. The &lt;code&gt;[adrp](https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADRP--Form-PC-relative-address-to-4KB-page-?lang=en)&lt;/code&gt; instruction generates a &lt;code&gt;pc&lt;/code&gt;-relative (program counter) address and writes the result to the destination register. It takes &lt;code&gt;pc&lt;/code&gt; of the instruction itself and adds a 21-bit immediate value shifted left by 12 bits. If the immediate value weren’t shifted it would lie in a range of +/-1 MB memory, which isn’t enough. The left shift increases the range up to +/-1 GB. However, because the 12 bits are masked out with the shift, we need to store them somewhere and restore later. That’s why we see add instruction following &lt;code&gt;adrp&lt;/code&gt; and two types instead of one. Also, it’s a bit tricky to encode &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADRP--Form-PC-relative-address-to-4KB-page-?lang=en\&quot;&gt;&lt;code&gt;adrp&lt;/code&gt;&lt;/a&gt;: 2 low bits of immediate value are placed in the position 30:29 and the rest in the position 23:5. Due to size limitations, the aarch64 instructions try to make the most out of 32 bits.&lt;/p&gt;&lt;p&gt;In the code we are going to use the formulas to calculate the values and description of &lt;code&gt;adrp&lt;/code&gt; and &lt;code&gt;add&lt;/code&gt; instructions to obtain the final opcode:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;#define R_AARCH64_CALL26 283\n#define R_AARCH64_ADD_ABS_LO12_NC 277\n#define R_AARCH64_ADR_PREL_PG_HI21 275\n...\n\n{\ncase R_AARCH64_CALL26:\n\t/* The mask separates opcode (6 bits) and the immediate value */\n\tuint32_t mask_bl = (0xffffffff &amp;lt;&amp;lt; 26);\n\t/* S+A-P, divided by 4 */\n\tval = (symbol_address + relocations[i].r_addend - patch_offset) &amp;gt;&amp;gt; 2;\n\t/* Concatenate opcode and value to get final instruction */\n\t*((uint32_t *)patch_offset) &amp;amp;= mask_bl;\n\tval &amp;amp;= ~mask_bl;\n\t*((uint32_t *)patch_offset) |= val;\n\tbreak;\ncase R_AARCH64_ADD_ABS_LO12_NC:\n\t/* The mask of `add` instruction to separate \n\t* opcode, registers and calculated value \n\t*/\n\tuint32_t mask_add = 0b11111111110000000000001111111111;\n\t/* S + A */\n\tuint32_t val = *(symbol_address + relocations[i].r_addend);\n\tval &amp;amp;= ~mask_add;\n\t*((uint32_t *)patch_offset) &amp;amp;= mask_add;\n\t/* Final instruction */\n\t*((uint32_t *)patch_offset) |= val;\ncase R_AARCH64_ADR_PREL_PG_HI21:\n\t/* Page(S+A)-Page(P), Page(expr) is defined as (expr &amp;amp; ~0xFFF) */\n\tval = (((uint64_t)(symbol_address + relocations[i].r_addend)) &amp;amp; ~0xFFF) - (((uint64_t)patch_offset) &amp;amp; ~0xFFF);\n\t/* Shift right the calculated value by 12 bits.\n\t * During decoding it will be shifted left as described above, \n\t * so we do the opposite.\n\t*/\n\tval &amp;gt;&amp;gt;= 12;\n\t/* Separate the lower and upper bits to place them in different positions */ \n\tuint32_t immlo = (val &amp;amp; (0xf &amp;gt;&amp;gt; 2)) &amp;lt;&amp;lt; 29 ;\n\tuint32_t immhi = (val &amp;amp; ((0xffffff &amp;gt;&amp;gt; 13) &amp;lt;&amp;lt; 2)) &amp;lt;&amp;lt; 22;\n\t*((uint32_t *)patch_offset) |= immlo;\n\t*((uint32_t *)patch_offset) |= immhi;\n\tbreak;\n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Compile and run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c \n$ ./loader\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52\nExecuting get_hello...\nget_hello() = Hello, world!\nExecuting get_var...\nget_var() = 5\nExecuting set_var(42)...\nExecuting get_var again...\nget_var() = 42&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;It works! The final code is &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/4/2\&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;executing-example-from-part-3-on-aarch64\&quot;&gt;Executing example from Part 3 on aarch64&lt;/h2&gt;\n            &lt;a href=\&quot;#executing-example-from-part-3-on-aarch64\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Our &lt;a href=\&quot;/how-to-execute-an-object-file-part-3/\&quot;&gt;Part 3&lt;/a&gt; is about resolving external dependencies. When we write code we don’t think much about how to allocate memory or print debug information to the console. Instead, we involve functions from the system libraries. But the code of system libraries needs to be passed through to our programs somehow. Additionally, for optimization purposes, it would be nice if this code would be stored in one place and shared between all programs. And another wish — we don’t want to resolve all the functions and global variables from the libraries, only those which we need and at those times when we need them. To solve these problems, ELF introduced two sections: PLT (the procedure linkage table) and GOT (the global offset table). The dynamic loader creates a list which contains all external functions and variables from the shared library, but doesn’t resolve them immediately; instead they are placed in the PLT section. Each external symbol is presented by a small function, a stub, e.g. &lt;code&gt;puts@plt&lt;/code&gt;. When an external symbol is requested, the stub checks if it was resolved previously. If not, the stub searches for an absolute address of the symbol, returns to the requester and writes it in the GOT table. The next time, the address returns directly from the GOT table.&lt;/p&gt;&lt;p&gt;In &lt;a href=\&quot;/how-to-execute-an-object-file-part-3/\&quot;&gt;Part 3&lt;/a&gt; we implemented a simplified PLT/GOT resolution. Firstly, we added a new function &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/obj.c#L35\&quot;&gt;&lt;code&gt;say_hello&lt;/code&gt;&lt;/a&gt; in the &lt;code&gt;obj.c&lt;/code&gt;, which calls unresolved system library function &lt;code&gt;puts&lt;/code&gt;. Further we added an optional wrapper &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L73\&quot;&gt;&lt;code&gt;my_puts&lt;/code&gt;&lt;/a&gt; in the &lt;code&gt;loader.c&lt;/code&gt;. The wrapper isn’t required, we could’ve resolved directly to a standard function, but it&amp;#39;s a good example of how the implementation of some functions can be overwritten with custom code. In the next steps we added our PLT/GOT resolution:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;PLT section we replaced with a &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L340\&quot;&gt;jumptable&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;GOT we replaced with &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238-L248\&quot;&gt;assembly instructions&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Basically, we created a small stub with assembly code (our &lt;code&gt;jumptable&lt;/code&gt;) to resolve the global address of our &lt;code&gt;my_puts&lt;/code&gt; wrapper and jump to it.&lt;/p&gt;&lt;p&gt;The approach for aarch64 is the same. But the &lt;code&gt;jumptable&lt;/code&gt; is very different as it consists of different assembly instructions.&lt;/p&gt;&lt;p&gt;The big difference here compared to the other parts is that we need to work with a 64-bit address for the GOT resolution. Our custom PLT or &lt;code&gt;jumptable&lt;/code&gt; is placed close to the main code of &lt;code&gt;obj.c&lt;/code&gt; and can operate with the relative addresses as before. For the GOT or referencing &lt;code&gt;my_puts&lt;/code&gt; wrapper we’ll use different branch instructions — &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BR--Branch-to-Register-\&quot;&gt;&lt;code&gt;br&lt;/code&gt;&lt;/a&gt; or &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BLR--Branch-with-Link-to-Register-\&quot;&gt;&lt;code&gt;blr&lt;/code&gt;&lt;/a&gt;. These instructions branch to the register, where the aarch64 registers can hold 64-bit values.&lt;/p&gt;&lt;p&gt;We can check how it resolves with the native PLT/GOT in our loader assembly code:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ objdump --disassemble --section=.text loader\n...\n1d2c:\t97fffb45 \tbl\ta40 &amp;lt;puts@plt&amp;gt;\n1d30:\tf94017e0 \tldr\tx0, [sp, #40]\n1d34:\td63f0000 \tblr\tx0\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The first instruction is &lt;code&gt;bl&lt;/code&gt; jump to &lt;code&gt;puts@plt&lt;/code&gt; stub. The next &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/LDR--immediate---Load-Register--immediate--\&quot;&gt;&lt;code&gt;ldr&lt;/code&gt;&lt;/a&gt; instruction tells us that some value was loaded into the register &lt;code&gt;x0&lt;/code&gt; from the stack. Each function has its own &lt;a href=\&quot;https://en.wikipedia.org/wiki/Call_stack#Stack_and_frame_pointers\&quot;&gt;stack frame&lt;/a&gt; to hold the local variables. The last &lt;code&gt;blr&lt;/code&gt; instruction makes a jump to the address stored in &lt;code&gt;x0&lt;/code&gt; register. There is an agreement in the register naming: if the stored value is 64-bits then the register is called &lt;code&gt;x0-x30&lt;/code&gt;; if only 32-bits are used then it’s called &lt;code&gt;w0-w30&lt;/code&gt; (the value will be stored in the lower 32-bits and upper 32-bits will be zeroed).&lt;/p&gt;&lt;p&gt;We need to do something similar — place the absolute address of our &lt;code&gt;my_puts&lt;/code&gt; wrapper in some register and call &lt;code&gt;br&lt;/code&gt; on this register. We don’t need to store the link before branching, the call will be returned to &lt;code&gt;say_hello&lt;/code&gt; from &lt;code&gt;obj.c&lt;/code&gt;, which is why a plain &lt;code&gt;br&lt;/code&gt; will be enough. Let’s check an assembly of simple C-function:&lt;/p&gt;&lt;p&gt;hello.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;#include &amp;lt;stdint.h&amp;gt;\n\nvoid say_hello(void)\n{\n    uint64_t reg = 0x555555550c14;\n}&lt;/pre&gt;&lt;/code&gt;\n            \n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -c hello.c\n$ objdump --disassemble --section=.text hello.o\n\nhello.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;say_hello&amp;gt;:\n   0:\td10043ff \tsub\tsp, sp, #0x10\n   4:\td2818280 \tmov\tx0, #0xc14                 \t// #3092\n   8:\tf2aaaaa0 \tmovk\tx0, #0x5555, lsl #16\n   c:\tf2caaaa0 \tmovk\tx0, #0x5555, lsl #32\n  10:\tf90007e0 \tstr\tx0, [sp, #8]\n  14:\td503201f \tnop\n  18:\t910043ff \tadd\tsp, sp, #0x10\n  1c:\td65f03c0 \tret&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The number &lt;code&gt;0x555555550c14&lt;/code&gt; is the address returned by &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238\&quot;&gt;&lt;code&gt;lookup_ext_function&lt;/code&gt;&lt;/a&gt;. We’ve printed it out to use as an example, but any &lt;a href=\&quot;https://www.kernel.org/doc/html/latest/arch/arm64/memory.html\&quot;&gt;48-bits&lt;/a&gt; hex value can be used.&lt;/p&gt;&lt;p&gt;In our output we see that the value was split in three sections and written in &lt;code&gt;x0&lt;/code&gt; register with three instructions: one &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOV--inverted-wide-immediate---Move--inverted-wide-immediate---an-alias-of-MOVN-\&quot;&gt;&lt;code&gt;mov&lt;/code&gt;&lt;/a&gt; and two &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOVK--Move-wide-with-keep-?lang=en\&quot;&gt;&lt;code&gt;movk&lt;/code&gt;&lt;/a&gt;. The documentation says that there are only 16 bits for the immediate value, but a shift can be applied (in our case left shift &lt;code&gt;lsl&lt;/code&gt;).&lt;/p&gt;&lt;p&gt;However, we can’t use &lt;code&gt;x0&lt;/code&gt; in our context. By &lt;a href=\&quot;https://developer.arm.com/documentation/den0024/a/The-ABI-for-ARM-64-bit-Architecture/Register-use-in-the-AArch64-Procedure-Call-Standard/Parameters-in-general-purpose-registers\&quot;&gt;convention&lt;/a&gt; the registers &lt;code&gt;x0-x7&lt;/code&gt; are caller-saved and used to pass function parameters between calls to other functions. Let’s use &lt;code&gt;x9&lt;/code&gt; then.&lt;/p&gt;&lt;p&gt;We need to modify our loader. Firstly let’s change the jumptable structure.&lt;/p&gt;&lt;p&gt;loader.c:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;...\nstruct ext_jump {\n\tuint32_t instr[4];\n};\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;As we saw above, we need four instructions: &lt;code&gt;mov&lt;/code&gt;, &lt;code&gt;movk&lt;/code&gt;, &lt;code&gt;movk&lt;/code&gt;, &lt;code&gt;br&lt;/code&gt;. We don’t need a stack frame as we aren’t preserving any local variables. We just want to load the address into the register and branch to it. But we can’t write human-readable code&lt;/p&gt;&lt;p&gt;e.g. &lt;code&gt;mov &nbsp;x0, #0xc14&lt;/code&gt; into instructions, we need machine binary or hex representation, e.g. &lt;code&gt;d2818280&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Let’s write a simple assembly code to get it:&lt;/p&gt;&lt;p&gt;hw.s:&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;.global _start\n\n_start: mov     x9, #0xc14 \n        movk    x9, #0x5555, lsl #16\n        movk    x9, #0x5555, lsl #32\n        br      x9&lt;/pre&gt;&lt;/code&gt;\n            \n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ as -o hw.o hw.s\n$ objdump --disassemble --section=.text hw.o\n\nhw.o:     file format elf64-littleaarch64\n\n\nDisassembly of section .text:\n\n0000000000000000 &amp;lt;_start&amp;gt;:\n   0:\td2818289 \tmov\tx9, #0xc14                 \t// #3092\n   4:\tf2aaaaa9 \tmovk\tx9, #0x5555, lsl #16\n   8:\tf2caaaa9 \tmovk\tx9, #0x5555, lsl #32\n   c:\td61f0120 \tbr\tx9&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Almost done! But there’s one more thing to consider. Even if the value &lt;code&gt;0x555555550c14&lt;/code&gt; is a real &lt;code&gt;my_puts&lt;/code&gt; wrapper address, it will be different on each run if &lt;a href=\&quot;https://en.wikipedia.org/wiki/Address_space_layout_randomization\&quot;&gt;ASLR(Address space layout randomization)&lt;/a&gt; is enabled. We need to patch these instructions to put the value which will be returned by &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238\&quot;&gt;&lt;code&gt;lookup_ext_function&lt;/code&gt;&lt;/a&gt; on each run. We’ll split the obtained value in three parts, 16-bits each, and replace them in our &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOV--inverted-wide-immediate---Move--inverted-wide-immediate---an-alias-of-MOVN-\&quot;&gt;&lt;code&gt;mov&lt;/code&gt;&lt;/a&gt; and &lt;a href=\&quot;https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOVK--Move-wide-with-keep-?lang=en\&quot;&gt;&lt;code&gt;movk&lt;/code&gt;&lt;/a&gt; instructions according to the documentation, similar to what we did before for our second part.&lt;/p&gt;\n            &lt;pre class=\&quot;language-cpp\&quot;&gt;&lt;code class=\&quot;language-cpp\&quot;&gt;if (symbols[symbol_idx].st_shndx == SHN_UNDEF) {\n\tstatic int curr_jmp_idx = 0;\n\n\tuint64_t addr = lookup_ext_function(strtab +  symbols[symbol_idx].st_name);\n\tuint32_t mov = 0b11010010100000000000000000001001 | ((addr &amp;lt;&amp;lt; 48) &amp;gt;&amp;gt; 43);\n\tuint32_t movk1 = 0b11110010101000000000000000001001 | (((addr &amp;gt;&amp;gt; 16) &amp;lt;&amp;lt; 48) &amp;gt;&amp;gt; 43);\n\tuint32_t movk2 = 0b11110010110000000000000000001001 | (((addr &amp;gt;&amp;gt; 32) &amp;lt;&amp;lt; 48) &amp;gt;&amp;gt; 43);\n\tjumptable[curr_jmp_idx].instr[0] = mov;         // mov  x9, #0x0c14\n\tjumptable[curr_jmp_idx].instr[1] = movk1;       // movk x9, #0x5555, lsl #16\n\tjumptable[curr_jmp_idx].instr[2] = movk2;       // movk x9, #0x5555, lsl #32\n\tjumptable[curr_jmp_idx].instr[3] = 0xd61f0120;  // br   x9\n\n\tsymbol_address = (uint8_t *)(&amp;amp;jumptable[curr_jmp_idx].instr[0]);\n\tcurr_jmp_idx++;\n} else {\n\tsymbol_address = section_runtime_base(&amp;amp;sections[symbols[symbol_idx].st_shndx]) + symbols[symbol_idx].st_value;\n}\nuint32_t val;\nswitch (type)\n{\ncase R_AARCH64_CALL26:\n\t/* The mask separates opcode (6 bits) and the immediate value */\n\tuint32_t mask_bl = (0xffffffff &amp;lt;&amp;lt; 26);\n\t/* S+A-P, divided by 4 */\n\tval = (symbol_address + relocations[i].r_addend - patch_offset) &amp;gt;&amp;gt; 2;\n\t/* Concatenate opcode and value to get final instruction */\n\t*((uint32_t *)patch_offset) &amp;amp;= mask_bl;\n\tval &amp;amp;= ~mask_bl;\n\t*((uint32_t *)patch_offset) |= val;\n\tbreak;\n...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;In the code we took the address of the first instruction &lt;code&gt;&amp;amp;jumptable[curr_jmp_idx].instr[0]&lt;/code&gt; and wrote it in the &lt;code&gt;symbol_address&lt;/code&gt;, further because the &lt;code&gt;type&lt;/code&gt; is still &lt;code&gt;R_AARCH64_CALL26&lt;/code&gt; it will be put into &lt;code&gt;bl&lt;/code&gt; - jump to the relative address. Where our relative address is the first &lt;code&gt;mov&lt;/code&gt; instruction. The whole &lt;code&gt;jumptable&lt;/code&gt; code will be executed and finished with the &lt;code&gt;blr&lt;/code&gt; instruction.&lt;/p&gt;&lt;p&gt;The final run:&lt;/p&gt;\n            &lt;pre class=\&quot;language-bash\&quot;&gt;&lt;code class=\&quot;language-bash\&quot;&gt;$ gcc -o loader loader.c\n$ ./loader\nExecuting add5...\nadd5(42) = 47\nExecuting add10...\nadd10(42) = 52\nExecuting get_hello...\nget_hello() = Hello, world!\nExecuting get_var...\nget_var() = 5\nExecuting set_var(42)...\nExecuting get_var again...\nget_var() = 42\nExecuting say_hello...\nmy_puts executed\nHello, world!&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The final code is &lt;a href=\&quot;https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/4/3\&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;summary\&quot;&gt;Summary&lt;/h2&gt;\n            &lt;a href=\&quot;#summary\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;There are several things we covered in this blog post. We gave a brief introduction on how the binary got executed on Linux and how all components are linked together. We saw a big difference between x86 and aarch64 assembly. We learned how we can hook into the code and change its behavior. But just as it was said in the first blog post of this series, the most important thing is to remember to always think about security first. Processing external inputs should always be done with great care. Bounds and integrity checks have been omitted for the purposes of keeping the examples short, so readers should be aware that the code is not production ready and is designed for educational purposes only.&lt;/p&gt;&quot;],&quot;published_at&quot;:[0,&quot;2023-11-17T14:00:35.000+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-10-09T23:26:26.129Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7v5UY4RrgvrEIaQ7k6TcVa/8a3cb0bf88d8a3aa3a780c71dff0bef1/how-to-execute-an-object-file-part-4.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;383iv0UQ6Lp0GZwOAxGq2p&quot;],&quot;name&quot;:[0,&quot;Linux&quot;],&quot;slug&quot;:[0,&quot;linux&quot;]}],[0,{&quot;id&quot;:[0,&quot;6lhzEBz2B56RKa4nUEAGYJ&quot;],&quot;name&quot;:[0,&quot;Programming&quot;],&quot;slug&quot;:[0,&quot;programming&quot;]}],[0,{&quot;id&quot;:[0,&quot;2UVIYusJwlvsmPYl2AvSuR&quot;],&quot;name&quot;:[0,&quot;Deep Dive&quot;],&quot;slug&quot;:[0,&quot;deep-dive&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Oxana Kharitonova&quot;],&quot;slug&quot;:[0,&quot;oxana&quot;],&quot;bio&quot;:[0,null],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3VMs5mLnM2JGDuB1x0sRSE/957ab30efef528d9fa8ccf73f1c20242/oxana.png&quot;],&quot;location&quot;:[0,&quot;London&quot;],&quot;website&quot;:[0,null],&quot;twitter&quot;:[0,null],&quot;facebook&quot;:[0,null]}]]],&quot;meta_description&quot;:[0,&quot;The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;How to execute an object file: part 4, AArch64 edition Config&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/how-to-execute-an-object-file-part-4&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;How to execute an object file: part 4, AArch64 edition&quot;],&quot;description&quot;:[0,&quot;The initial posts are dedicated to the x86 architecture. Since then, the fleet of our working machines has expanded to include a large and growing number of ARM CPUs. This time we’ll repeat this exercise for the aarch64 architecture.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/32iMMwlljd5QlJuzD2MLTo/9f476195e6436ca8bfba6d9e5b9e5ac3/how-to-execute-an-object-file-part-4-zy4TY1.png&quot;]}]}],&quot;initialReadingTime&quot;:[0,&quot;11&quot;],&quot;relatedPosts&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;3UHNgpNPKn2IAwDUzD4m3a&quot;],&quot;title&quot;:[0,&quot;Searching for the cause of hung tasks in the Linux kernel&quot;],&quot;slug&quot;:[0,&quot;searching-for-the-cause-of-hung-tasks-in-the-linux-kernel&quot;],&quot;excerpt&quot;:[0,&quot;The Linux kernel can produce a hung task warning. Searching the Internet and the kernel docs, you can find a brief explanation that the process is stuck in the uninterruptible state.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;&lt;p&gt;Depending on your configuration, the Linux kernel can produce a hung task warning message in its log. Searching the Internet and the kernel documentation, you can find a brief explanation that the kernel process is stuck in the uninterruptable state and hasn’t been scheduled on the CPU for an unexpectedly long period of time. That explains the warning’s meaning, but doesn’t provide the reason it occurred. In this blog post we’re going to explore how the hung task warning works, why it happens, whether it is a bug in the Linux kernel or application itself, and whether it is worth monitoring at all.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;info-task-xxx-1495882-blocked-for-more-than-yyy-seconds\&quot;&gt;INFO: task XXX:1495882 blocked for more than YYY seconds.&lt;/h3&gt;\n            &lt;a href=\&quot;#info-task-xxx-1495882-blocked-for-more-than-yyy-seconds\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;The hung task message in the kernel log looks like this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;INFO: task XXX:1495882 blocked for more than YYY seconds.\n     Tainted: G          O       6.6.39-cloudflare-2024.7.3 #1\n&amp;quot;echo 0 &amp;gt; /proc/sys/kernel/hung_task_timeout_secs&amp;quot; disables this message.\ntask:XXX         state:D stack:0     pid:1495882 ppid:1      flags:0x00004002\n. . .&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Processes in Linux can be in different states. Some of them are running or ready to run on the CPU — they are in the &lt;a href=\&quot;https://elixir.bootlin.com/linux/v6.12.6/source/include/linux/sched.h#L99\&quot;&gt;&lt;code&gt;&lt;u&gt;TASK_RUNNING&lt;/u&gt;&lt;/code&gt;&lt;/a&gt; state. Others are waiting for some signal or event to happen, e.g. network packets to arrive or terminal input from a user. They are in a &lt;code&gt;TASK_INTERRUPTIBLE&lt;/code&gt; state and can spend an arbitrary length of time in this state until being woken up by a signal. The most important thing about these states is that they still can receive signals, and be terminated by a signal. In contrast, a process in the &lt;code&gt;TASK_UNINTERRUPTIBLE&lt;/code&gt; state is waiting only for certain special classes of events to wake them up, and can’t be interrupted by a signal. The signals are not delivered until the process emerges from this state and only a system reboot can clear the process. It’s marked with the letter &lt;code&gt;D&lt;/code&gt; in the log shown above.&lt;/p&gt;&lt;p&gt;What if this wake up event doesn’t happen or happens with a significant delay? (A “significant delay” may be on the order of seconds or minutes, depending on the system.) Then our dependent process is hung in this state. What if this dependent process holds some lock and prevents other processes from acquiring it? Or if we see many processes in the D state? Then it might tell us that some of the system resources are overwhelmed or are not working correctly. At the same time, this state is very valuable, especially if we want to preserve the process memory. It might be useful if part of the data is written to disk and another part is still in the process memory — we don’t want inconsistent data on a disk. Or maybe we want a snapshot of the process memory when the bug is hit. To preserve this behaviour, but make it more controlled, a new state was introduced in the kernel: &lt;a href=\&quot;https://lwn.net/Articles/288056/\&quot;&gt;&lt;code&gt;&lt;u&gt;TASK_KILLABLE&lt;/u&gt;&lt;/code&gt;&lt;/a&gt; — it still protects a process, but allows termination with a fatal signal.&nbsp;&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;how-linux-identifies-the-hung-process\&quot;&gt;How Linux identifies the hung process&lt;/h3&gt;\n            &lt;a href=\&quot;#how-linux-identifies-the-hung-process\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;The Linux kernel has a special thread called &lt;code&gt;khungtaskd&lt;/code&gt;. It runs regularly depending on the settings, iterating over all processes in the &lt;code&gt;D&lt;/code&gt; state. If a process is in this state for more than YYY seconds, we’ll see a message in the kernel log. There are settings for this daemon that can be changed according to your wishes:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ sudo sysctl -a --pattern hung\nkernel.hung_task_all_cpu_backtrace = 0\nkernel.hung_task_check_count = 4194304\nkernel.hung_task_check_interval_secs = 0\nkernel.hung_task_panic = 0\nkernel.hung_task_timeout_secs = 10\nkernel.hung_task_warnings = 200&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;At Cloudflare, we changed the notification threshold &lt;code&gt;kernel.hung_task_timeout_secs&lt;/code&gt; from the default 120 seconds to 10 seconds. You can adjust the value for your system depending on configuration and how critical this delay is for you. If the process spends more than &lt;code&gt;hung_task_timeout_secs&lt;/code&gt; seconds in the D state, a log entry is written, and our internal monitoring system emits an alert based on this log. Another important setting here is &lt;code&gt;kernel.hung_task_warnings&lt;/code&gt; — the total number of messages that will be sent to the log. We limit it to 200 messages and reset it every 15 minutes. It allows us not to be overwhelmed by the same issue, and at the same time doesn’t stop our monitoring for too long. You can make it unlimited by &lt;a href=\&quot;https://docs.kernel.org/admin-guide/sysctl/kernel.html#hung-task-warnings\&quot;&gt;&lt;u&gt;setting the value to &amp;quot;-1&amp;quot;&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;To better understand the root causes of the hung tasks and how a system can be affected, we’re going to review more detailed examples.&nbsp;&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;example-1-or-xfs\&quot;&gt;Example #1 or XFS&lt;/h3&gt;\n            &lt;a href=\&quot;#example-1-or-xfs\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;Typically, there is a meaningful process or application name in the log, but sometimes you might see something like this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;INFO: task kworker/13:0:834409 blocked for more than 11 seconds.\n \tTainted: G      \tO   \t6.6.39-cloudflare-2024.7.3 #1\n&amp;quot;echo 0 &amp;gt; /proc/sys/kernel/hung_task_timeout_secs&amp;quot; disables this message.\ntask:kworker/13:0\tstate:D stack:0 \tpid:834409 ppid:2   flags:0x00004000\nWorkqueue: xfs-sync/dm-6 xfs_log_worker&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;In this log, &lt;code&gt;kworker&lt;/code&gt; is the kernel thread. It’s used as a deferring mechanism, meaning a piece of work will be scheduled to be executed in the future. Under &lt;code&gt;kworker&lt;/code&gt;, the work is aggregated from different tasks, which makes it difficult to tell which application is experiencing a delay. Luckily, the &lt;code&gt;kworker&lt;/code&gt; is accompanied by the &lt;a href=\&quot;https://docs.kernel.org/core-api/workqueue.html\&quot;&gt;&lt;code&gt;&lt;u&gt;Workqueue&lt;/u&gt;&lt;/code&gt;&lt;/a&gt; line. &lt;code&gt;Workqueue&lt;/code&gt; is a linked list, usually predefined in the kernel, where these pieces of work are added and performed by the &lt;code&gt;kworker&lt;/code&gt; in the order they were added to the queue. The &lt;code&gt;Workqueue&lt;/code&gt; name &lt;code&gt;xfs-sync&lt;/code&gt; and &lt;a href=\&quot;https://elixir.bootlin.com/linux/v6.12.6/source/kernel/workqueue.c#L6096\&quot;&gt;&lt;u&gt;the function which it points to&lt;/u&gt;&lt;/a&gt;, &lt;code&gt;xfs_log_worker&lt;/code&gt;, might give a good clue where to look. Here we can make an assumption that the &lt;a href=\&quot;https://en.wikipedia.org/wiki/XFS\&quot;&gt;&lt;u&gt;XFS&lt;/u&gt;&lt;/a&gt; is under pressure and check the relevant metrics. It helped us to discover that due to some configuration changes, we forgot &lt;code&gt;no_read_workqueue&lt;/code&gt; / &lt;code&gt;no_write_workqueue&lt;/code&gt; flags that were introduced some time ago to &lt;a href=\&quot;https://blog.cloudflare.com/speeding-up-linux-disk-encryption/\&quot;&gt;&lt;u&gt;speed up Linux disk encryption&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;i&gt;Summary&lt;/i&gt;: In this case, nothing critical happened to the system, but the hung tasks warnings gave us an alert that our file system had slowed down.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;example-2-or-coredump\&quot;&gt;Example #2 or Coredump&lt;/h3&gt;\n            &lt;a href=\&quot;#example-2-or-coredump\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;Let’s take a look at the next hung task log and its decoded stack trace:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;INFO: task test:964 blocked for more than 5 seconds.\n      Not tainted 6.6.72-cloudflare-2025.1.7 #1\n&amp;quot;echo 0 &amp;gt; /proc/sys/kernel/hung_task_timeout_secs&amp;quot; disables this message.\ntask:test            state:D stack:0     pid:964   ppid:916    flags:0x00004000\nCall Trace:\n&amp;lt;TASK&amp;gt;\n__schedule (linux/kernel/sched/core.c:5378 linux/kernel/sched/core.c:6697) \nschedule (linux/arch/x86/include/asm/preempt.h:85 (discriminator 13) linux/kernel/sched/core.c:6772 (discriminator 13)) \n[do_exit (linux/kernel/exit.c:433 (discriminator 4) linux/kernel/exit.c:825 (discriminator 4)) \n? finish_task_switch.isra.0 (linux/arch/x86/include/asm/irqflags.h:42 linux/arch/x86/include/asm/irqflags.h:77 linux/kernel/sched/sched.h:1385 linux/kernel/sched/core.c:5132 linux/kernel/sched/core.c:5250) \ndo_group_exit (linux/kernel/exit.c:1005) \nget_signal (linux/kernel/signal.c:2869) \n? srso_return_thunk (linux/arch/x86/lib/retpoline.S:217) \n? hrtimer_try_to_cancel.part.0 (linux/kernel/time/hrtimer.c:1347) \narch_do_signal_or_restart (linux/arch/x86/kernel/signal.c:310) \n? srso_return_thunk (linux/arch/x86/lib/retpoline.S:217) \n? hrtimer_nanosleep (linux/kernel/time/hrtimer.c:2105) \nexit_to_user_mode_prepare (linux/kernel/entry/common.c:176 linux/kernel/entry/common.c:210) \nsyscall_exit_to_user_mode (linux/arch/x86/include/asm/entry-common.h:91 linux/kernel/entry/common.c:141 linux/kernel/entry/common.c:304) \n? srso_return_thunk (linux/arch/x86/lib/retpoline.S:217) \ndo_syscall_64 (linux/arch/x86/entry/common.c:88) \nentry_SYSCALL_64_after_hwframe (linux/arch/x86/entry/entry_64.S:121) \n&amp;lt;/TASK&amp;gt;&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The stack trace says that the process or application &lt;code&gt;test&lt;/code&gt; was blocked &lt;code&gt;for more than 5 seconds&lt;/code&gt;. We might recognise this user space application by the name, but why is it blocked? It’s always helpful to check the stack trace when looking for a cause. The most interesting line here is &lt;code&gt;do_exit (linux/kernel/exit.c:433 (discriminator 4) linux/kernel/exit.c:825 (discriminator 4))&lt;/code&gt;. The &lt;a href=\&quot;https://elixir.bootlin.com/linux/v6.6.67/source/kernel/exit.c#L825\&quot;&gt;&lt;u&gt;source code&lt;/u&gt;&lt;/a&gt; points to the &lt;code&gt;coredump_task_exit&lt;/code&gt; function. Additionally, checking the process metrics revealed that the application crashed during the time when the warning message appeared in the log. When a process is terminated based on some set of signals (abnormally), &lt;a href=\&quot;https://man7.org/linux/man-pages/man5/core.5.html\&quot;&gt;&lt;u&gt;the Linux kernel can provide a core dump file&lt;/u&gt;&lt;/a&gt;, if enabled. The mechanism — when a process terminates, the kernel makes a snapshot of the process memory before exiting and either writes it to a file or sends it through the socket to another handler — can be &lt;a href=\&quot;https://systemd.io/COREDUMP/\&quot;&gt;&lt;u&gt;systemd-coredump&lt;/u&gt;&lt;/a&gt; or your custom one. When it happens, the kernel moves the process to the &lt;code&gt;D&lt;/code&gt; state to preserve its memory and early termination. The higher the process memory usage, the longer it takes to get a core dump file, and the higher the chance of getting a hung task warning.&lt;/p&gt;&lt;p&gt;Let’s check our hypothesis by triggering it with a small Go program. We’ll use the default Linux coredump handler and will decrease the hung task threshold to 1 second.&lt;/p&gt;&lt;p&gt;Coredump settings:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ sudo sysctl -a --pattern kernel.core\nkernel.core_pattern = core\nkernel.core_pipe_limit = 16\nkernel.core_uses_pid = 1&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;You can make changes with &lt;a href=\&quot;https://man7.org/linux/man-pages/man8/sysctl.8.html\&quot;&gt;&lt;u&gt;sysctl&lt;/u&gt;&lt;/a&gt;:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ sudo sysctl -w kernel.core_uses_pid=1&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Hung task settings:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ sudo sysctl -a --pattern hung\nkernel.hung_task_all_cpu_backtrace = 0\nkernel.hung_task_check_count = 4194304\nkernel.hung_task_check_interval_secs = 0\nkernel.hung_task_panic = 0\nkernel.hung_task_timeout_secs = 1\nkernel.hung_task_warnings = -1&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Go program:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ cat main.go\npackage main\n\nimport (\n\t&amp;quot;os&amp;quot;\n\t&amp;quot;time&amp;quot;\n)\n\nfunc main() {\n\t_, err := os.ReadFile(&amp;quot;test.file&amp;quot;)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\ttime.Sleep(8 * time.Minute) \n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;This program reads a 10&nbsp;GB file into process memory. Let’s create the file:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ yes this is 10GB file | head -c 10GB &amp;gt; test.file&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The last step is to build the Go program, crash it, and watch our kernel log:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ go mod init test\n$ go build .\n$ GOTRACEBACK=crash ./test\n$ (Ctrl+\\)&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Hooray! We can see our hung task warning:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ sudo dmesg -T | tail -n 31\nINFO: task test:8734 blocked for more than 22 seconds.\n      Not tainted 6.6.72-cloudflare-2025.1.7 #1\n      Blocked by coredump.\n&amp;quot;echo 0 &amp;gt; /proc/sys/kernel/hung_task_timeout_secs&amp;quot; disables this message.\ntask:test            state:D stack:0     pid:8734  ppid:8406   task_flags:0x400448 flags:0x00004000&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;By the way, have you noticed the &lt;code&gt;Blocked by coredump.&lt;/code&gt; line in the log? It was recently added to the &lt;a href=\&quot;https://git.kernel.org/pub/scm/linux/kernel/git/akpm/mm.git/commit/?h=mm-nonmm-stable&amp;id=23f3f7625cfb55f92e950950e70899312f54afb7\&quot;&gt;&lt;u&gt;upstream&lt;/u&gt;&lt;/a&gt; code to improve visibility and remove the blame from the process itself. The patch also added the &lt;code&gt;task_flags&lt;/code&gt; information, as &lt;code&gt;Blocked by coredump&lt;/code&gt; is detected via the flag &lt;a href=\&quot;https://elixir.bootlin.com/linux/v6.13.1/source/include/linux/sched.h#L1675\&quot;&gt;&lt;code&gt;&lt;u&gt;PF_POSTCOREDUMP&lt;/u&gt;&lt;/code&gt;&lt;/a&gt;, and knowing all the task flags is useful for further root-cause analysis.&lt;/p&gt;&lt;p&gt;&lt;i&gt;Summary&lt;/i&gt;: This example showed that even if everything suggests that the application is the problem, the real root cause can be something else — in this case, &lt;code&gt;coredump&lt;/code&gt;.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;example-3-or-rtnl_mutex\&quot;&gt;Example #3 or rtnl_mutex&lt;/h3&gt;\n            &lt;a href=\&quot;#example-3-or-rtnl_mutex\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;This one was tricky to debug. Usually, the alerts are limited by one or two different processes, meaning only a certain application or subsystem experiences an issue. In this case, we saw dozens of unrelated tasks hanging for minutes with no improvements over time. Nothing else was in the log, most of the system metrics were fine, and existing traffic was being served, but it was not possible to ssh to the server. New Kubernetes container creations were also stalling. Analyzing the stack traces of different tasks initially revealed that all the traces were limited to just three functions:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;rtnetlink_rcv_msg+0x9/0x3c0\ndev_ethtool+0xc6/0x2db0 \nbonding_show_bonds+0x20/0xb0&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Further investigation showed that all of these functions were waiting for &lt;a href=\&quot;https://elixir.bootlin.com/linux/v6.6.74/source/net/core/rtnetlink.c#L76\&quot;&gt;&lt;code&gt;&lt;u&gt;rtnl_lock&lt;/u&gt;&lt;/code&gt;&lt;/a&gt; to be acquired. It looked like some application acquired the &lt;code&gt;rtnl_mutex&lt;/code&gt; and didn’t release it. All other processes were in the &lt;code&gt;D&lt;/code&gt; state waiting for this lock.&lt;/p&gt;&lt;p&gt;The RTNL lock is primarily used by the kernel networking subsystem for any network-related config, for both writing and reading. The RTNL is a global &lt;b&gt;mutex&lt;/b&gt; lock, although &lt;a href=\&quot;https://lpc.events/event/18/contributions/1959/\&quot;&gt;&lt;u&gt;upstream efforts&lt;/u&gt;&lt;/a&gt; are being made for splitting up RTNL per network namespace (netns).&lt;/p&gt;&lt;p&gt;From the hung task reports, we can observe the “victims” that are being stalled waiting for the lock, but how do we identify the task that is holding this lock for too long? For troubleshooting this, we leveraged &lt;code&gt;BPF&lt;/code&gt; via a &lt;code&gt;bpftrace&lt;/code&gt; script, as this allows us to inspect the running kernel state. The &lt;a href=\&quot;https://elixir.bootlin.com/linux/v6.6.75/source/include/linux/mutex.h#L67\&quot;&gt;&lt;u&gt;kernel&amp;#39;s mutex implementation&lt;/u&gt;&lt;/a&gt; has a struct member called &lt;code&gt;owner&lt;/code&gt;. It contains a pointer to the &lt;a href=\&quot;https://elixir.bootlin.com/linux/v6.6.75/source/include/linux/sched.h#L746\&quot;&gt;&lt;code&gt;&lt;u&gt;task_struct&lt;/u&gt;&lt;/code&gt;&lt;/a&gt; from the mutex-owning process, except it is encoded as type &lt;code&gt;atomic_long_t&lt;/code&gt;. This is because the mutex implementation stores some state information in the lower 3-bits (mask 0x7) of this pointer. Thus, to read and dereference this &lt;code&gt;task_struct&lt;/code&gt; pointer, we must first mask off the lower bits (0x7).&lt;/p&gt;&lt;p&gt;Our &lt;code&gt;bpftrace&lt;/code&gt; script to determine who holds the mutex is as follows:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;#!/usr/bin/env bpftrace\ninterval:s:10 {\n  $rtnl_mutex = (struct mutex *) kaddr(&amp;quot;rtnl_mutex&amp;quot;);\n  $owner = (struct task_struct *) ($rtnl_mutex-&amp;gt;owner.counter &amp;amp; ~0x07);\n  if ($owner != 0) {\n    printf(&amp;quot;rtnl_mutex-&amp;gt;owner = %u %s\\n&amp;quot;, $owner-&amp;gt;pid, $owner-&amp;gt;comm);\n  }\n}&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;In this script, the &lt;code&gt;rtnl_mutex&lt;/code&gt; lock is a global lock whose address can be exposed via &lt;code&gt;/proc/kallsyms&lt;/code&gt; – using &lt;code&gt;bpftrace&lt;/code&gt; helper function &lt;code&gt;kaddr()&lt;/code&gt;, we can access the struct mutex pointer from the &lt;code&gt;kallsyms&lt;/code&gt;. Thus, we can periodically (via &lt;code&gt;interval:s:10&lt;/code&gt;) check if someone is holding this lock.&lt;/p&gt;&lt;p&gt;In the output we had this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;rtnl_mutex-&amp;gt;owner = 3895365 calico-node&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;This allowed us to quickly identify &lt;code&gt;calico-node&lt;/code&gt; as the process holding the RTNL lock for too long. To quickly observe where this process itself is stalled, the call stack is available via &lt;code&gt;/proc/3895365/stack&lt;/code&gt;. This showed us that the root cause was a Wireguard config change, with function &lt;code&gt;wg_set_device()&lt;/code&gt; holding the RTNL lock, and &lt;code&gt;peer_remove_after_dead()&lt;/code&gt; waiting too long for a &lt;code&gt;napi_disable()&lt;/code&gt; call. We continued debugging via a tool called &lt;a href=\&quot;https://drgn.readthedocs.io/en/latest/user_guide.html#stack-traces\&quot;&gt;&lt;code&gt;&lt;u&gt;drgn&lt;/u&gt;&lt;/code&gt;&lt;/a&gt;, which is a programmable debugger that can debug a running kernel via a Python-like interactive shell. We still haven’t discovered the root cause for the Wireguard issue and have &lt;a href=\&quot;https://lore.kernel.org/lkml/CALrw=nGoSW=M-SApcvkP4cfYwWRj=z7WonKi6fEksWjMZTs81A@mail.gmail.com/\&quot;&gt;&lt;u&gt;asked the upstream&lt;/u&gt;&lt;/a&gt; for help, but that is another story.&lt;/p&gt;&lt;p&gt;&lt;i&gt;Summary&lt;/i&gt;: The hung task messages were the only ones which we had in the kernel log. Each stack trace of these messages was unique, but by carefully analyzing them, we could spot similarities and continue debugging with other instruments.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;epilogue\&quot;&gt;Epilogue&lt;/h3&gt;\n            &lt;a href=\&quot;#epilogue\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;Your system might have different hung task warnings, and we have many others not mentioned here. Each case is unique, and there is no standard approach to debug them. But hopefully this blog post helps you better understand why it’s good to have these warnings enabled, how they work, and what the meaning is behind them. We tried to provide some navigation guidance for the debugging process as well:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;analyzing the stack trace might be a good starting point for debugging it, even if all the messages look unrelated, like we saw in example #3&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;keep in mind that the alert might be misleading, pointing to the victim and not the offender, as we saw in example #2 and example #3&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;if the kernel doesn’t schedule your application on the CPU, puts it in the D state, and emits the warning – the real problem might exist in the application code&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Good luck with your debugging, and hopefully this material will help you on this journey!&lt;/p&gt;&quot;],&quot;published_at&quot;:[0,&quot;2025-02-14T14:00+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2025-03-03T07:09:45.578Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4iHBIzAkLrDyr0Gc4NAtK3/6c26fa93870ea112c62a791a30bcf705/image1.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;2UVIYusJwlvsmPYl2AvSuR&quot;],&quot;name&quot;:[0,&quot;Deep Dive&quot;],&quot;slug&quot;:[0,&quot;deep-dive&quot;]}],[0,{&quot;id&quot;:[0,&quot;383iv0UQ6Lp0GZwOAxGq2p&quot;],&quot;name&quot;:[0,&quot;Linux&quot;],&quot;slug&quot;:[0,&quot;linux&quot;]}],[0,{&quot;id&quot;:[0,&quot;73alK6sbtKLS6uB7ZrYrjj&quot;],&quot;name&quot;:[0,&quot;Kernel&quot;],&quot;slug&quot;:[0,&quot;kernel&quot;]}],[0,{&quot;id&quot;:[0,&quot;3VJOfQ8TnNJwqu1GIGwPuA&quot;],&quot;name&quot;:[0,&quot;Monitoring&quot;],&quot;slug&quot;:[0,&quot;monitoring&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Oxana Kharitonova&quot;],&quot;slug&quot;:[0,&quot;oxana&quot;],&quot;bio&quot;:[0,null],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3VMs5mLnM2JGDuB1x0sRSE/957ab30efef528d9fa8ccf73f1c20242/oxana.png&quot;],&quot;location&quot;:[0,&quot;London&quot;],&quot;website&quot;:[0,null],&quot;twitter&quot;:[0,null],&quot;facebook&quot;:[0,null]}],[0,{&quot;name&quot;:[0,&quot;Jesper Brouer&quot;],&quot;slug&quot;:[0,&quot;jesper-brouer&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/QAY4H7YQSvJvLIPB5Ff0p/6f6aa104cc897511714dddc9ea4ebe1a/Jesper_Brouer.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;The Linux kernel can produce a hung task warning. Searching the Internet and the kernel docs, you can find a brief explanation that the process is stuck in the uninterruptible state. That explains the warning’s meaning, but doesn’t provide the reason it occurred. In this blog post we’re going to explore how the warning works.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;LOC: Searching for the cause of hung tasks in the Linux kernel&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;Translated for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;Translated for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/searching-for-the-cause-of-hung-tasks-in-the-linux-kernel&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Searching for the cause of hung tasks in the Linux kernel&quot;],&quot;description&quot;:[0,&quot;The Linux kernel can produce a hung task warning. Searching the Internet and the kernel docs, you can find a brief explanation that the process is stuck in the uninterruptible state. That explains the warning’s meaning, but doesn’t provide the reason it occurred. In this blog post we’re going to explore how the warning works.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2dasu8nuHwyI37n0WhScLi/4f710b8e0eeee6ba46efa49c4fb6ae49/Searching_for_the_cause_of_hung_tasks_in_the_Linux_kernel-OG.png&quot;]}]}],[0,{&quot;id&quot;:[0,&quot;64DSvKdN853gq5Bx3Cyfij&quot;],&quot;title&quot;:[0,&quot;Over 700 million events/second: How we make sense of too much data&quot;],&quot;slug&quot;:[0,&quot;how-we-make-sense-of-too-much-data&quot;],&quot;excerpt&quot;:[0,&quot;Here we explain how we made our data pipeline scale to 700 million events per second while becoming more resilient than ever before. We share some math behind our approach and some of the designs of &quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;&lt;p&gt;Cloudflare&amp;#39;s network provides an enormous array of services to our customers. We collect and deliver associated data to customers in the form of event logs and aggregated analytics. As of December 2024, our data pipeline is ingesting up to 706M events per second generated by Cloudflare&amp;#39;s services, and that represents 100x growth since our &lt;a href=\&quot;https://blog.cloudflare.com/http-analytics-for-6m-requests-per-second-using-clickhouse/\&quot;&gt;&lt;u&gt;2018 data pipeline blog post&lt;/u&gt;&lt;/a&gt;.&nbsp;&lt;/p&gt;&lt;p&gt;At peak, we are moving 107 &lt;a href=\&quot;https://simple.wikipedia.org/wiki/Gibibyte\&quot;&gt;&lt;u&gt;GiB&lt;/u&gt;&lt;/a&gt;/s of compressed data, either pushing it directly to customers or subjecting it to additional queueing and batching.&lt;/p&gt;&lt;p&gt;All of these data streams power things like &lt;a href=\&quot;https://developers.cloudflare.com/logs/\&quot;&gt;&lt;u&gt;Logs&lt;/u&gt;&lt;/a&gt;, &lt;a href=\&quot;https://developers.cloudflare.com/analytics/\&quot;&gt;&lt;u&gt;Analytics&lt;/u&gt;&lt;/a&gt;, and billing, as well as other products, such as training machine learning models for bot detection. This blog post is focused on techniques we use to efficiently and accurately deal with the high volume of data we ingest for our Analytics products. A previous &lt;a href=\&quot;https://blog.cloudflare.com/cloudflare-incident-on-november-14-2024-resulting-in-lost-logs/\&quot;&gt;&lt;u&gt;blog post&lt;/u&gt;&lt;/a&gt; provides a deeper dive into the data pipeline for Logs.&nbsp;&lt;/p&gt;&lt;p&gt;The pipeline can be roughly described by the following diagram.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5ihv6JXx19nJiEyfCaCg8V/ad7081720514bafd070cc38a04bc7097/BLOG-2486_2.jpg\&quot; alt=\&quot;BLOG-2486 2\&quot; class=\&quot;kg-image\&quot; width=\&quot;1999\&quot; height=\&quot;1939\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;The data pipeline has multiple stages, and each can and will naturally break or slow down because of hardware failures or misconfiguration. And when that happens, there is just too much data to be able to buffer it all for very long. Eventually some will get dropped, causing gaps in analytics and a degraded product experience unless proper mitigations are in place.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;dropping-data-to-retain-information\&quot;&gt;Dropping data to retain information&lt;/h3&gt;\n            &lt;a href=\&quot;#dropping-data-to-retain-information\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;How does one retain valuable information from more than half a billion events per second, when some must be dropped? Drop it in a controlled way, by downsampling.&lt;/p&gt;&lt;p&gt;Here is a visual analogy showing the difference between uncontrolled data loss and downsampling. In both cases the same number of pixels were delivered. One is a higher resolution view of just a small portion of a popular painting, while the other shows the full painting, albeit blurry and highly pixelated.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4kUGB4RLQzFb7cphMpHqAg/e7ccf871c73e0e8ca9dcac32fe265f18/Screenshot_2025-01-24_at_10.57.17_AM.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1008\&quot; height=\&quot;409\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;As we noted above, any point in the pipeline can fail, so we want the ability to downsample at any point as needed. Some services proactively downsample data at the source before it even hits Logfwdr. This makes the information extracted from that data a little bit blurry, but much more useful than what otherwise would be delivered: random chunks of the original with gaps in between, or even nothing at all. The amount of &amp;quot;blur&amp;quot; is outside our control (we make our best effort to deliver full data), but there is a robust way to estimate it, as discussed in the &lt;a href=\&quot;/how-we-make-sense-of-too-much-data/#extracting-value-from-downsampled-data\&quot;&gt;&lt;u&gt;next section&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Logfwdr can decide to downsample data sitting in the buffer when it overflows. Logfwdr handles many data streams at once, so we need to prioritize them by assigning each data stream a weight and then applying &lt;a href=\&quot;https://en.wikipedia.org/wiki/Max-min_fairness\&quot;&gt;&lt;u&gt;max-min fairness&lt;/u&gt;&lt;/a&gt; to better utilize the buffer. It allows each data stream to store as much as it needs, as long as the whole buffer is not saturated. Once it is saturated, streams divide it fairly according to their weighted size.&lt;/p&gt;&lt;p&gt;In our implementation (Go), each data stream is driven by a goroutine, and they cooperate via channels. They consult a single tracker object every time they allocate and deallocate memory. The tracker uses a &lt;a href=\&quot;https://en.wikipedia.org/wiki/Heap_(data_structure)\&quot;&gt;&lt;u&gt;max-heap&lt;/u&gt;&lt;/a&gt; to always know who the heaviest participant is and what the total usage is. Whenever the total usage goes over the limit, the tracker repeatedly sends the &amp;quot;please shed some load&amp;quot; signal to the heaviest participant, until the usage is again under the limit.&lt;/p&gt;&lt;p&gt;The effect of this is that healthy streams, which buffer a tiny amount, allocate whatever they need without losses. But any lagging streams split the remaining memory allowance fairly.&lt;/p&gt;&lt;p&gt;We downsample more or less uniformly, by always taking some of the least downsampled batches from the buffer (using min-heap to find those) and merging them together upon downsampling.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/15VP0VYkrvkQboX9hrOy0q/e3d087fe704bd1b0ee41eb5b7a24b899/BLOG-2486_4.png\&quot; alt=\&quot;BLOG-2486 4\&quot; class=\&quot;kg-image\&quot; width=\&quot;1999\&quot; height=\&quot;923\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;&lt;sup&gt;&lt;i&gt;Merging keeps the batches roughly the same size and their number under control.&lt;/i&gt;&lt;/sup&gt;&lt;/p&gt;&lt;p&gt;Downsampling is cheap, but since data in the buffer is compressed, it causes recompression, which is the single most expensive thing we do to the data. But using extra CPU time is the last thing you want to do when the system is under heavy load! We compensate for the recompression costs by starting to downsample the fresh data as well (before it gets compressed for the first time) whenever the stream is in the &amp;quot;shed the load&amp;quot; state.&lt;/p&gt;&lt;p&gt;We called this approach &amp;quot;bottomless buffers&amp;quot;, because you can squeeze effectively infinite amounts of data in there, and it will just automatically be thinned out. Bottomless buffers resemble &lt;a href=\&quot;https://en.wikipedia.org/wiki/Reservoir_sampling\&quot;&gt;&lt;u&gt;reservoir sampling&lt;/u&gt;&lt;/a&gt;, where the buffer is the reservoir and the population comes as the input stream. But there are some differences. First is that in our pipeline the input stream of data never ends, while reservoir sampling assumes it ends to finalize the sample. Secondly, the resulting sample also never ends.&lt;/p&gt;&lt;p&gt;Let&amp;#39;s look at the next stage in the pipeline: Logreceiver. It sits in front of a distributed queue. The purpose of logreceiver is to partition each stream of data by a key that makes it easier for Logpush, Analytics inserters, or some other process to consume.&lt;/p&gt;&lt;p&gt;Logreceiver proactively performs adaptive sampling of analytics. This improves the accuracy of analytics for small customers (receiving on the order of 10 events per day), while more aggressively downsampling large customers (millions of events per second). Logreceiver then pushes the same data at multiple resolutions (100%, 10%, 1%, etc.) into different topics in the distributed queue. This allows it to keep pushing something rather than nothing when the queue is overloaded, by just skipping writing the high-resolution samples of data.&lt;/p&gt;&lt;p&gt;The same goes for Inserters: they can skip &lt;i&gt;reading or writing&lt;/i&gt; high-resolution data. The Analytics APIs can skip &lt;i&gt;reading&lt;/i&gt; high resolution data. The analytical database might be unable to read high resolution data because of overload or degraded cluster state or because there is just too much to read (very wide time range or very large customer). Adaptively dropping to lower resolutions allows the APIs to return &lt;i&gt;some&lt;/i&gt; results in all of those cases.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;extracting-value-from-downsampled-data\&quot;&gt;Extracting value from downsampled data&lt;/h3&gt;\n            &lt;a href=\&quot;#extracting-value-from-downsampled-data\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;Okay, we have some downsampled data in the analytical database. It looks like the original data, but with some rows missing. How do we make sense of it? How do we know if the results can be trusted?&lt;/p&gt;&lt;p&gt;Let&amp;#39;s look at the math.&lt;/p&gt;Since the amount of sampling can vary over time and between nodes in the distributed system, we need to store this information along with the data. With each event $x_i$ we store its sample interval, which is the reciprocal to its inclusion probability $\\pi_i = \\frac{1}{\\text{sample interval}}$. For example, if we sample 1 in every 1,000 events, each of the events included in the resulting sample will have its $\\pi_i = 0.001$, so the sample interval will be 1,000. When we further downsample that batch of data, the inclusion probabilities (and the sample intervals) multiply together: a 1 in 1,000 sample from a 1 in 1,000 sample is a 1 in 1,000,000 sample of the original population. The sample interval of an event can also be interpreted roughly as the number of original events that this event represents, so in the literature it is known as weight $w_i = \\frac{1}{\\pi_i}$.\n&lt;/p&gt;\nWe rely on the &lt;a href=\&quot;https://en.wikipedia.org/wiki/Horvitz%E2%80%93Thompson_estimator\&quot;&gt;Horvitz-Thompson estimator&lt;/a&gt; (HT, &lt;a href=\&quot;https://www.stat.cmu.edu/~brian/905-2008/papers/Horvitz-Thompson-1952-jasa.pdf\&quot;&gt;paper&lt;/a&gt;) in order to derive analytics about $x_i$. It gives two estimates: the analytical estimate (e.g. the population total or size) and the estimate of the variance of that estimate. The latter enables us to figure out how accurate the results are by building &lt;a href=\&quot;https://en.wikipedia.org/wiki/Confidence_interval\&quot;&gt;confidence intervals&lt;/a&gt;. They define ranges that cover the true value with a given probability &lt;i&gt;(confidence level)&lt;/i&gt;. A typical confidence level is 0.95, at which a confidence interval (a, b) tells that you can be 95% sure the true SUM or COUNT is between a and b.\n&lt;/p&gt;&lt;p&gt;So far, we know how to use the HT estimator for doing SUM, COUNT, and AVG.&lt;/p&gt;Given a sample of size $n$, consisting of values $x_i$ and their inclusion probabilities $\\pi_i$, the HT estimator for the population total (i.e. SUM) would be\n\n$$\\widehat{T}=\\sum_{i=1}^n{\\frac{x_i}{\\pi_i}}=\\sum_{i=1}^n{x_i w_i}.$$\n\nThe variance of $\\widehat{T}$ is:\n\n$$\\widehat{V}(\\widehat{T}) = \\sum_{i=1}^n{x_i^2 \\frac{1 - \\pi_i}{\\pi_i^2}} + \\sum_{i \\neq j}^n{x_i x_j \\frac{\\pi_{ij} - \\pi_i \\pi_j}{\\pi_{ij} \\pi_i \\pi_j}},$$\n\nwhere $\\pi_{ij}$ is the probability of both $i$-th and $j$-th events being sampled together.\n&lt;/p&gt;\nWe use &lt;a href=\&quot;https://en.wikipedia.org/wiki/Poisson_sampling\&quot;&gt;Poisson sampling&lt;/a&gt;, where each event is subjected to an independent &lt;a href=\&quot;https://en.wikipedia.org/wiki/Bernoulli_trial\&quot;&gt;Bernoulli trial&lt;/a&gt; (\&quot;coin toss\&quot;) which determines whether the event becomes part of the sample. Since each trial is independent, we can equate $\\pi_{ij} = \\pi_i \\pi_j$, which when plugged in the variance estimator above turns the right-hand sum to zero:\n\n$$\\widehat{V}(\\widehat{T}) = \\sum_{i=1}^n{x_i^2 \\frac{1 - \\pi_i}{\\pi_i^2}} + \\sum_{i \\neq j}^n{x_i x_j \\frac{0}{\\pi_{ij} \\pi_i \\pi_j}},$$\n\nthus\n\n$$\\widehat{V}(\\widehat{T}) = \\sum_{i=1}^n{x_i^2 \\frac{1 - \\pi_i}{\\pi_i^2}} = \\sum_{i=1}^n{x_i^2 w_i (w_i-1)}.$$\n\nFor COUNT we use the same estimator, but plug in $x_i = 1$. This gives us:\n\n$$\\begin{align}\n\\widehat{C} &amp;= \\sum_{i=1}^n{\\frac{1}{\\pi_i}} = \\sum_{i=1}^n{w_i},\\\\\n\\widehat{V}(\\widehat{C}) &amp;= \\sum_{i=1}^n{\\frac{1 - \\pi_i}{\\pi_i^2}} = \\sum_{i=1}^n{w_i (w_i-1)}.\n\\end{align}$$\n\nFor AVG we would use\n\n$$\\begin{align}\n\\widehat{\\mu} &amp;= \\frac{\\widehat{T}}{N},\\\\\n\\widehat{V}(\\widehat{\\mu}) &amp;= \\frac{\\widehat{V}(\\widehat{T})}{N^2},\n\\end{align}$$\n\nif we could, but the original population size $N$ is not known, it is not stored anywhere, and it is not even possible to store because of custom filtering at query time. Plugging $\\widehat{C}$ instead of $N$ only partially works. It gives a valid estimator for the mean itself, but not for its variance, so the constructed confidence intervals are unusable.\n&lt;/p&gt;\nIn all cases the corresponding pair of estimates are used as the $\\mu$ and $\\sigma^2$ of the normal distribution (because of the &lt;a href=\&quot;https://en.wikipedia.org/wiki/Central_limit_theorem\&quot;&gt;central limit theorem&lt;/a&gt;), and then the bounds for the confidence interval (of confidence level ) are:\n\n$$\\Big( \\mu - \\Phi^{-1}\\big(\\frac{1 + \\alpha}{2}\\big) \\cdot \\sigma, \\quad \\mu + \\Phi^{-1}\\big(\\frac{1 + \\alpha}{2}\\big) \\cdot \\sigma\\Big).$$&lt;p&gt;We do not know the N, but there is a workaround: simultaneous confidence intervals. Construct confidence intervals for SUM and COUNT independently, and then combine them into a confidence interval for AVG. This is known as the &lt;a href=\&quot;https://www.sciencedirect.com/topics/mathematics/bonferroni-method\&quot;&gt;&lt;u&gt;Bonferroni method&lt;/u&gt;&lt;/a&gt;. It requires generating wider (half the &amp;quot;inconfidence&amp;quot;) intervals for SUM and COUNT. Here is a simplified visual representation, but the actual estimator will have to take into account the possibility of the orange area going below zero.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/69Vvi2CHSW8Gew0TWHSndj/1489cfe1ff57df4e7e1ca3c31a8444a5/BLOG-2486_5.png\&quot; alt=\&quot;BLOG-2486 5\&quot; class=\&quot;kg-image\&quot; width=\&quot;991\&quot; height=\&quot;504\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;In SQL, the estimators and confidence intervals look like this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-javascript\&quot;&gt;&lt;code class=\&quot;language-javascript\&quot;&gt;WITH sum(x * _sample_interval)                              AS t,\n     sum(x * x * _sample_interval * (_sample_interval - 1)) AS vt,\n     sum(_sample_interval)                                  AS c,\n     sum(_sample_interval * (_sample_interval - 1))         AS vc,\n     -- ClickHouse does not expose the erf⁻¹ function, so we precompute some magic numbers,\n     -- (only for 95% confidence, will be different otherwise):\n     --   1.959963984540054 = Φ⁻¹((1+0.950)/2) = √2 * erf⁻¹(0.950)\n     --   2.241402727604945 = Φ⁻¹((1+0.975)/2) = √2 * erf⁻¹(0.975)\n     1.959963984540054 * sqrt(vt) AS err950_t,\n     1.959963984540054 * sqrt(vc) AS err950_c,\n     2.241402727604945 * sqrt(vt) AS err975_t,\n     2.241402727604945 * sqrt(vc) AS err975_c\nSELECT t - err950_t AS lo_total,\n       t            AS est_total,\n       t + err950_t AS hi_total,\n       c - err950_c AS lo_count,\n       c            AS est_count,\n       c + err950_c AS hi_count,\n       (t - err975_t) / (c + err975_c) AS lo_average,\n       t / c                           AS est_average,\n       (t + err975_t) / (c - err975_c) AS hi_average\nFROM ...&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Construct a confidence interval for each timeslot on the timeseries, and you get a confidence band, clearly showing the accuracy of the analytics. The figure below shows an example of such a band in shading around the line.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4JEnnC6P4BhM8qB8J5yKqt/3635835967085f9b24f64a5731457ddc/BLOG-2486_6.png\&quot; alt=\&quot;BLOG-2486 6\&quot; class=\&quot;kg-image\&quot; width=\&quot;1726\&quot; height=\&quot;574\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;sampling-is-easy-to-screw-up\&quot;&gt;Sampling is easy to screw up&lt;/h3&gt;\n            &lt;a href=\&quot;#sampling-is-easy-to-screw-up\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;We started using confidence bands on our internal dashboards, and after a while noticed something scary: a systematic error! For one particular website the &amp;quot;total bytes served&amp;quot; estimate was higher than the true control value obtained from rollups, and the confidence bands were way off. See the figure below, where the true value (blue line) is outside the yellow confidence band at all times.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/CHCyKyXqPMj8DnMpBUf3N/772fb61f02b79c59417f66d9dc0b5d19/BLOG-2486_7.png\&quot; alt=\&quot;BLOG-2486 7\&quot; class=\&quot;kg-image\&quot; width=\&quot;1013\&quot; height=\&quot;716\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;We checked the stored data for corruption, it was fine. We checked the math in the queries, it was fine. It was only after reading through the source code for all of the systems responsible for sampling that we found a candidate for the root cause.&lt;/p&gt;&lt;p&gt;We used simple random sampling everywhere, basically &amp;quot;tossing a coin&amp;quot; for each event, but in Logreceiver sampling was done differently. Instead of sampling &lt;i&gt;randomly&lt;/i&gt; it would perform &lt;i&gt;systematic sampling&lt;/i&gt; by picking events at equal intervals starting from the first one in the batch.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4xUwjxdylG5ARlFlDtv1OC/76db68677b7ae072b0a065f59d82c6f2/BLOG-2486_8.png\&quot; alt=\&quot;BLOG-2486 8\&quot; class=\&quot;kg-image\&quot; width=\&quot;763\&quot; height=\&quot;158\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;Why would that be a problem?&lt;/p&gt;There are two reasons. The first is that we can no longer claim $\\pi_{ij} = \\pi_i \\pi_j$, so the simplified variance estimator stops working and confidence intervals cannot be trusted. But even worse, the estimator for the total becomes biased. To understand why exactly, we wrote a short repro code in Python:\n&lt;br&gt;&lt;/p&gt;\n            &lt;pre class=\&quot;language-javascript\&quot;&gt;&lt;code class=\&quot;language-javascript\&quot;&gt;import itertools\n\ndef take_every(src, period):\n    for i, x in enumerate(src):\n    if i % period == 0:\n        yield x\n\npattern = [10, 1, 1, 1, 1, 1]\nsample_interval = 10 # bad if it has common factors with len(pattern)\ntrue_mean = sum(pattern) / len(pattern)\n\norig = itertools.cycle(pattern)\nsample_size = 10000\nsample = itertools.islice(take_every(orig, sample_interval), sample_size)\n\nsample_mean = sum(sample) / sample_size\n\nprint(f&amp;quot;{true_mean=} {sample_mean=}&amp;quot;)&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;After playing with different values for &lt;code&gt;&lt;b&gt;pattern&lt;/b&gt;&lt;/code&gt; and &lt;code&gt;&lt;b&gt;sample_interval&lt;/b&gt;&lt;/code&gt; in the code above, we realized where the bias was coming from.&lt;/p&gt;&lt;p&gt;Imagine a person opening a huge generated HTML page with many small/cached resources, such as icons. The first response will be big, immediately followed by a burst of small responses. If the website is not visited that much, responses will tend to end up all together at the start of a batch in Logfwdr. Logreceiver does not cut batches, only concatenates them. The first response remains first, so it always gets picked and skews the estimate up.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2WZUzqCwr2A6WgX1T5UE8z/7a2e08b611fb64e64a61e3d5c792fe23/BLOG-2486_9.png\&quot; alt=\&quot;BLOG-2486 9\&quot; class=\&quot;kg-image\&quot; width=\&quot;888\&quot; height=\&quot;659\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;We checked the hypothesis against the raw unsampled data that we happened to have because that particular website was also using one of the &lt;a href=\&quot;https://developers.cloudflare.com/logs/\&quot;&gt;&lt;u&gt;Logs&lt;/u&gt;&lt;/a&gt; products. We took all events in a given time range, and grouped them by cutting at gaps of at least one minute. In each group, we ranked all events by time and looked at the variable of interest (response size in bytes), and put it on a scatter plot against the rank inside the group.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2IXtqGkRjV0xs3wvwx609A/81e67736cacbccdd839c2177769ee4fe/BLOG-2486_10.png\&quot; alt=\&quot;BLOG-2486 10\&quot; class=\&quot;kg-image\&quot; width=\&quot;1379\&quot; height=\&quot;861\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;A clear pattern! The first response is much more likely to be larger than average.&lt;/p&gt;&lt;p&gt;We fixed the issue by making Logreceiver shuffle the data before sampling. As we rolled out the fix, the estimation and the true value converged.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/4TL1pKDLw7MA6yGMSCahJN/227cb22054e0e8fe65c7766aa6e4b541/BLOG-2486_11.png\&quot; alt=\&quot;BLOG-2486 11\&quot; class=\&quot;kg-image\&quot; width=\&quot;1371\&quot; height=\&quot;716\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;Now, after battle testing it for a while, we are confident the HT estimator is implemented properly and we are using the correct sampling process.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;using-cloudflares-analytics-apis-to-query-sampled-data\&quot;&gt;Using Cloudflare's analytics APIs to query sampled data&lt;/h3&gt;\n            &lt;a href=\&quot;#using-cloudflares-analytics-apis-to-query-sampled-data\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;We already power most of our analytics datasets with sampled data. For example, the &lt;a href=\&quot;https://developers.cloudflare.com/analytics/analytics-engine/\&quot;&gt;&lt;u&gt;Workers Analytics Engine&lt;/u&gt;&lt;/a&gt; exposes the &lt;a href=\&quot;https://developers.cloudflare.com/analytics/analytics-engine/sql-api/#sampling\&quot;&gt;&lt;u&gt;sample interval&lt;/u&gt;&lt;/a&gt; in SQL, allowing our customers to build their own dashboards with confidence bands. In the GraphQL API, all of the data nodes that have &amp;quot;&lt;a href=\&quot;https://developers.cloudflare.com/analytics/graphql-api/sampling/#adaptive-sampling\&quot;&gt;&lt;u&gt;Adaptive&lt;/u&gt;&lt;/a&gt;&amp;quot; in their name are based on sampled data, and the sample interval is exposed as a field there as well, though it is not possible to build confidence intervals from that alone. We are working on exposing confidence intervals in the GraphQL API, and as an experiment have added them to the count and edgeResponseBytes (sum) fields on the httpRequestsAdaptiveGroups nodes. This is available under &lt;code&gt;&lt;b&gt;confidence(level: X)&lt;/b&gt;&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Here is a sample GraphQL query:&lt;/p&gt;\n            &lt;pre class=\&quot;language-javascript\&quot;&gt;&lt;code class=\&quot;language-javascript\&quot;&gt;query HTTPRequestsWithConfidence(\n  $accountTag: string\n  $zoneTag: string\n  $datetimeStart: string\n  $datetimeEnd: string\n) {\n  viewer {\n    zones(filter: { zoneTag: $zoneTag }) {\n      httpRequestsAdaptiveGroups(\n        filter: {\n          datetime_geq: $datetimeStart\n          datetime_leq: $datetimeEnd\n      }\n      limit: 100\n    ) {\n      confidence(level: 0.95) {\n        level\n        count {\n          estimate\n          lower\n          upper\n          sampleSize\n        }\n        sum {\n          edgeResponseBytes {\n            estimate\n            lower\n            upper\n            sampleSize\n          }\n        }\n      }\n    }\n  }\n}\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The query above asks for the estimates and the 95% confidence intervals for &lt;code&gt;&lt;b&gt;SUM(edgeResponseBytes)&lt;/b&gt;&lt;/code&gt; and &lt;code&gt;&lt;b&gt;COUNT&lt;/b&gt;&lt;/code&gt;. The results will also show the sample size, which is good to know, as we rely on the &lt;a href=\&quot;https://en.wikipedia.org/wiki/Central_limit_theorem\&quot;&gt;&lt;u&gt;central limit theorem&lt;/u&gt;&lt;/a&gt; to build the confidence intervals, thus small samples don&amp;#39;t work very well.&lt;/p&gt;&lt;p&gt;Here is the response from this query:&lt;/p&gt;\n            &lt;pre class=\&quot;language-javascript\&quot;&gt;&lt;code class=\&quot;language-javascript\&quot;&gt;{\n  &amp;quot;data&amp;quot;: {\n    &amp;quot;viewer&amp;quot;: {\n      &amp;quot;zones&amp;quot;: [\n        {\n          &amp;quot;httpRequestsAdaptiveGroups&amp;quot;: [\n            {\n              &amp;quot;confidence&amp;quot;: {\n                &amp;quot;level&amp;quot;: 0.95,\n                &amp;quot;count&amp;quot;: {\n                  &amp;quot;estimate&amp;quot;: 96947,\n                  &amp;quot;lower&amp;quot;: &amp;quot;96874.24&amp;quot;,\n                  &amp;quot;upper&amp;quot;: &amp;quot;97019.76&amp;quot;,\n                  &amp;quot;sampleSize&amp;quot;: 96294\n                },\n                &amp;quot;sum&amp;quot;: {\n                  &amp;quot;edgeResponseBytes&amp;quot;: {\n                    &amp;quot;estimate&amp;quot;: 495797559,\n                    &amp;quot;lower&amp;quot;: &amp;quot;495262898.54&amp;quot;,\n                    &amp;quot;upper&amp;quot;: &amp;quot;496332219.46&amp;quot;,\n                    &amp;quot;sampleSize&amp;quot;: 96294\n                  }\n                }\n              }\n            }\n          ]\n        }\n      ]\n    }\n  },\n  &amp;quot;errors&amp;quot;: null\n}\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The response shows the estimated count is 96947, and we are 95% confident that the true count lies in the range 96874.24 to 97019.76. Similarly, the estimate and range for the sum of response bytes are provided.&lt;/p&gt;&lt;p&gt;The estimates are based on a sample size of 96294 rows, which is plenty of samples to calculate good confidence intervals.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h3 id=\&quot;conclusion\&quot;&gt;Conclusion&lt;/h3&gt;\n            &lt;a href=\&quot;#conclusion\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n        &lt;p&gt;We have discussed what kept our data pipeline scalable and resilient despite doubling in size every 1.5 years, how the math works, and how it is easy to mess up. We are constantly working on better ways to keep the data pipeline, and the products based on it, useful to our customers. If you are interested in doing things like that and want to help us build a better Internet, check out our &lt;a href=\&quot;http://www.cloudflare.com/careers\&quot;&gt;&lt;u&gt;careers page&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;&quot;],&quot;published_at&quot;:[0,&quot;2025-01-27T14:00+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2025-01-27T14:00:02.609Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/75NKwswtRHDDkYNKWPeKlr/8ecd9aba303acb2a48b2087226dab070/BLOG-2486_1.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;2MJs149fz91foS5KPlD4hr&quot;],&quot;name&quot;:[0,&quot;Bugs&quot;],&quot;slug&quot;:[0,&quot;bugs&quot;]}],[0,{&quot;id&quot;:[0,&quot;2OotqBxtRdi5MuC90AlyxE&quot;],&quot;name&quot;:[0,&quot;Analytics&quot;],&quot;slug&quot;:[0,&quot;analytics&quot;]}],[0,{&quot;id&quot;:[0,&quot;5fXI7jwkVL8rNyKrfpk0Lw&quot;],&quot;name&quot;:[0,&quot;Data&quot;],&quot;slug&quot;:[0,&quot;data&quot;]}],[0,{&quot;id&quot;:[0,&quot;6GfYtlrIy3UkkZHclLS3LX&quot;],&quot;name&quot;:[0,&quot;GraphQL&quot;],&quot;slug&quot;:[0,&quot;graphql&quot;]}],[0,{&quot;id&quot;:[0,&quot;1pPf2NNj9SXrC0A0ERKp9v&quot;],&quot;name&quot;:[0,&quot;SQL&quot;],&quot;slug&quot;:[0,&quot;sql&quot;]}],[0,{&quot;id&quot;:[0,&quot;KDI5hQcs301H8vxpGKXO0&quot;],&quot;name&quot;:[0,&quot;Go&quot;],&quot;slug&quot;:[0,&quot;go&quot;]}],[0,{&quot;id&quot;:[0,&quot;2UVIYusJwlvsmPYl2AvSuR&quot;],&quot;name&quot;:[0,&quot;Deep Dive&quot;],&quot;slug&quot;:[0,&quot;deep-dive&quot;]}],[0,{&quot;id&quot;:[0,&quot;64P6m4UbJfOqbY74LBs8GN&quot;],&quot;name&quot;:[0,&quot;Sampling&quot;],&quot;slug&quot;:[0,&quot;sampling&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Constantin Pan&quot;],&quot;slug&quot;:[0,&quot;constantin-pan&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2ICl6tt16EVQTzZBDsUY8e/ea13d3c440b722fdcd261a9240105222/_tmp_mini_magick20220928-42-1vrdnmo.jpg&quot;],&quot;location&quot;:[0,&quot;London&quot;],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}],[0,{&quot;name&quot;:[0,&quot;Jim Hawkridge&quot;],&quot;slug&quot;:[0,&quot;jim-hawkridge&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2Exc0INWMvhkHxGvQWUYlK/bf19c60e186ba3457df51302858959fe/_tmp_mini_magick20220928-42-1isuz89.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;Here we explain how we made our data pipeline scale to 700 million events per second while becoming more resilient than ever before. We share some math behind our approach and some of the designs of &quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/how-we-make-sense-of-too-much-data&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Over 700 million events/second: How we make sense of too much data&quot;],&quot;description&quot;:[0,&quot;Here we explain how we made our data pipeline scale to 700 million events per second while becoming more resilient than ever before. We share some math behind our approach and some of the designs of our systems, as well as issues that we had to face and bugs we had to chase.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3IbyM2qrP1QNY2qYgOLZo8/f235ea2206c509938d943cdef8a084c8/BLOG-2486_OG.png&quot;]}]}],[0,{&quot;id&quot;:[0,&quot;6ZxrGIedGqREgTs02vpt0t&quot;],&quot;title&quot;:[0,&quot;Multi-Path TCP: revolutionizing connectivity, one path at a time&quot;],&quot;slug&quot;:[0,&quot;multi-path-tcp-revolutionizing-connectivity-one-path-at-a-time&quot;],&quot;excerpt&quot;:[0,&quot;Multi-Path TCP (MPTCP) leverages multiple network interfaces, like Wi-Fi and cellular, to provide seamless mobility for more reliable connectivity. While promising, MPTCP is still in its early stages,&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;&lt;p&gt;&lt;/p&gt;&lt;p&gt;The Internet is designed to provide multiple paths between two endpoints. Attempts to exploit multi-path opportunities are almost as old as the Internet, culminating in &lt;a href=\&quot;https://datatracker.ietf.org/doc/html/rfc2991\&quot;&gt;&lt;u&gt;RFCs&lt;/u&gt;&lt;/a&gt; documenting some of the challenges. Still, today, virtually all end-to-end communication uses only one available path at a time. Why? It turns out that in multi-path setups, even the smallest differences between paths can harm the connection quality due to &lt;a href=\&quot;https://en.wikipedia.org/wiki/Equal-cost_multi-path_routing#History\&quot;&gt;&lt;u&gt;packet reordering&lt;/u&gt;&lt;/a&gt; and other issues. As a result, Internet devices usually use a single path and let the routers handle the path selection.&lt;/p&gt;&lt;p&gt;There is another way. Enter Multi-Path TCP (MPTCP), which exploits the presence of multiple interfaces on a device, such as a mobile phone that has both Wi-Fi and cellular antennas, to achieve multi-path connectivity.&lt;/p&gt;&lt;p&gt;MPTCP has had a long history — see the &lt;a href=\&quot;https://en.wikipedia.org/wiki/Multipath_TCP\&quot;&gt;&lt;u&gt;Wikipedia article&lt;/u&gt;&lt;/a&gt; and the &lt;a href=\&quot;https://datatracker.ietf.org/doc/html/rfc8684\&quot;&gt;&lt;u&gt;spec (RFC 8684)&lt;/u&gt;&lt;/a&gt; for details. It&amp;#39;s a major extension to the TCP protocol, and historically most of the TCP changes failed to gain traction. However, MPTCP is supposed to be mostly an operating system feature, making it easy to enable. Applications should only need minor code changes to support it.&lt;/p&gt;&lt;p&gt;There is a caveat, however: MPTCP is still fairly immature, and while it can use multiple paths, giving it superpowers over regular TCP, it&amp;#39;s not always strictly better than it. Whether MPTCP should be used over TCP is really a case-by-case basis.&lt;/p&gt;&lt;p&gt;In this blog post we show how to set up MPTCP to find out.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;subflows\&quot;&gt;Subflows&lt;/h2&gt;\n            &lt;a href=\&quot;#subflows\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          \n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3r8AP5BHbvtYEtXmYSXFwO/36e95cbac93cdecf2f5ee65945abf0b3/Screenshot_2024-12-23_at_3.07.37_PM.png\&quot; alt=\&quot;BLOG-2637 2\&quot; class=\&quot;kg-image\&quot; width=\&quot;1922\&quot; height=\&quot;1004\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;Internally, MPTCP extends TCP by introducing &amp;quot;subflows&amp;quot;. When everything is working, a single TCP connection can be backed by multiple MPTCP subflows, each using different paths. This is a big deal - a single TCP byte stream is now no longer identified by a single 5-tuple. On Linux you can see the subflows with &lt;code&gt;ss -M&lt;/code&gt;, like:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;marek$ ss -tMn dport = :443 | cat\ntcp   ESTAB 0  \t0 192.168.2.143%enx2800af081bee:57756 104.28.152.1:443\ntcp   ESTAB 0  \t0       192.168.1.149%wlp0s20f3:44719 104.28.152.1:443\nmptcp ESTAB 0  \t0                 192.168.2.143:57756 104.28.152.1:443&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Here you can see a single MPTCP connection, composed of two underlying TCP flows.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;mptcp-aspirations\&quot;&gt;MPTCP aspirations&lt;/h2&gt;\n            &lt;a href=\&quot;#mptcp-aspirations\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Being able to separate the lifetime of a connection from the lifetime of a flow allows MPTCP to address two problems present in classical TCP: aggregation and mobility.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;b&gt;Aggregation&lt;/b&gt;: MPTCP can aggregate the bandwidth of many network interfaces. For example, in a data center scenario, it&amp;#39;s common to use interface bonding. A single flow can make use of just one physical interface. MPTCP, by being able to launch many subflows, can expose greater overall bandwidth. I&amp;#39;m personally not convinced if this is a real problem. As we&amp;#39;ll learn below, modern Linux has a &lt;a href=\&quot;https://dl.ifip.org/db/conf/networking/networking2016/1570234725.pdf\&quot;&gt;&lt;u&gt;BLESS-like MPTCP scheduler&lt;/u&gt;&lt;/a&gt; and macOS stack has the &amp;quot;aggregation&amp;quot; mode, so aggregation should work, but I&amp;#39;m not sure how practical it is. However, there are &lt;a href=\&quot;https://www.openmptcprouter.com/\&quot;&gt;&lt;u&gt;certainly projects that are trying to do link aggregation&lt;/u&gt;&lt;/a&gt; using MPTCP.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;b&gt;Mobility&lt;/b&gt;: On a customer device, a TCP stream is typically broken if the underlying network interface goes away. This is not an uncommon occurrence — consider a smartphone dropping from Wi-Fi to cellular. MPTCP can fix this — it can create and destroy many subflows over the lifetime of a single connection and survive multiple network changes.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Improving reliability for mobile clients is a big deal. While some software can use QUIC, which also works on &lt;a href=\&quot;https://www.ietf.org/archive/id/draft-ietf-quic-multipath-11.html\&quot;&gt;&lt;u&gt;Multipath Extensions&lt;/u&gt;&lt;/a&gt;, a large number of classical services still use TCP. A great example is SSH: it would be very nice if you could walk around with a laptop and keep an SSH session open and switch Wi-Fi networks seamlessly, without breaking the connection.&lt;/p&gt;&lt;p&gt;MPTCP work was initially driven by &lt;a href=\&quot;https://uclouvain.be/fr/index.html\&quot;&gt;&lt;u&gt;UCLouvain in Belgium&lt;/u&gt;&lt;/a&gt;. The first serious adoption was on the iPhone. Apparently, users have a tendency to use Siri while they are walking out of their home. It&amp;#39;s very common to lose Wi-Fi connectivity while they are doing this. (&lt;a href=\&quot;https://youtu.be/BucQ1lfbtd4?t=533\&quot;&gt;&lt;u&gt;source&lt;/u&gt;&lt;/a&gt;)&nbsp;&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;implementations\&quot;&gt;Implementations&lt;/h2&gt;\n            &lt;a href=\&quot;#implementations\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Currently, there are only two major MPTCP implementations — Linux kernel support from v5.6, but realistically you need at least kernel v6.1 (&lt;a href=\&quot;https://oracle.github.io/kconfigs/?config=UTS_RELEASE&amp;config=MPTCP\&quot;&gt;&lt;u&gt;MPTCP is not supported on Android&lt;/u&gt;&lt;/a&gt; yet) and iOS from version 7 / Mac OS X from 10.10.&lt;/p&gt;&lt;p&gt;Typically, Linux is used on the server side, and iOS/macOS as the client. It&amp;#39;s possible to get Linux to work as a client-side, but it&amp;#39;s not straightforward, as we&amp;#39;ll learn soon. Beware — there is plenty of outdated Linux MPTCP documentation. The code has had a bumpy history and at least two different APIs were proposed. See the Linux kernel source for &lt;a href=\&quot;https://docs.kernel.org/networking/mptcp.html\&quot;&gt;&lt;u&gt;the mainline API&lt;/u&gt;&lt;/a&gt; and the &lt;a href=\&quot;https://www.mptcp.dev/\&quot;&gt;&lt;u&gt;mptcp.dev&lt;/u&gt;&lt;/a&gt; website.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;linux-as-a-server\&quot;&gt;Linux as a server&lt;/h2&gt;\n            &lt;a href=\&quot;#linux-as-a-server\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Conceptually, the MPTCP design is pretty sensible. After the initial TCP handshake, each peer may announce additional addresses (and ports) on which it can be reached. There are two ways of doing this. First, in the handshake TCP packet each peer specifies the &amp;quot;&lt;i&gt;Do not attempt to establish new subflows to this address and port&lt;/i&gt;&amp;quot; bit, also known as bit [C], in the MPTCP TCP extensions header.&lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/bT8oz3wxpw7alftvdYg5n/b7614a4d10b6c81e18027f6785391ede/BLOG-2637_3.png\&quot; alt=\&quot;BLOG-2637 3\&quot; class=\&quot;kg-image\&quot; width=\&quot;1062\&quot; height=\&quot;252\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;&lt;sup&gt;&lt;i&gt;Wireshark dissecting MPTCP flags from a SYN packet. &lt;/i&gt;&lt;/sup&gt;&lt;a href=\&quot;https://github.com/multipath-tcp/mptcp_net-next/issues/535\&quot;&gt;&lt;sup&gt;&lt;i&gt;&lt;u&gt;Tcpdump does not report&lt;/u&gt;&lt;/i&gt;&lt;/sup&gt;&lt;/a&gt;&lt;sup&gt;&lt;i&gt; this flag yet.&lt;/i&gt;&lt;/sup&gt;&lt;/p&gt;&lt;p&gt;With this bit cleared, the other peer is free to assume the two-tuple is fine to be reconnected to. Typically, the &lt;b&gt;server allows&lt;/b&gt; the client to reuse the server IP/port address. Usually, the &lt;b&gt;client is not listening&lt;/b&gt; and disallows the server to connect back to it. There are caveats though. For example, in the context of Cloudflare, where our servers are using Anycast addressing, reconnecting to the server IP/port won&amp;#39;t work. Going twice to the IP/port pair is unlikely to reach the same server. For us it makes sense to set this flag, disallowing clients from reconnecting to our server addresses. This can be done on Linux with:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;# Linux server sysctl - useful for ECMP or Anycast servers\n$ sysctl -w net.mptcp.allow_join_initial_addr_port=0\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;There is also a second way to advertise a listening IP/port. During the lifetime of a connection, a peer can send an ADD-ADDR MPTCP signal which advertises a listening IP/port. This can be managed on Linux by &lt;code&gt;ip mptcp endpoint ... signal&lt;/code&gt;, like:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;# Linux server - extra listening address\n$ ip mptcp endpoint add 192.51.100.1 dev eth0 port 4321 signal\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;With such a config, a Linux peer (typically server) will report the additional IP/port with ADD-ADDR MPTCP signal in an ACK packet, like this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;host &amp;gt; host: Flags [.], ack 1, win 8, options [mptcp 30 add-addr v1 id 1 192.51.100.1:4321 hmac 0x...,nop,nop], length 0\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;It&amp;#39;s important to realize that either peer can send ADD-ADDR messages. Unusual as it might sound, it&amp;#39;s totally fine for the client to advertise extra listening addresses. The most common scenario though, consists of either nobody, or just a server, sending ADD-ADDR.&lt;/p&gt;&lt;p&gt;Technically, to launch an MPTCP socket on Linux, you just need to replace IPPROTO_TCP with IPPROTO_MPTCP in the application code:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;IPPROTO_MPTCP = 262\nsd = socket(AF_INET, SOCK_STREAM, IPPROTO_MPTCP)\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;In practice, though, this introduces some changes to the sockets API. Currently not all setsockopt&amp;#39;s work yet — like &lt;code&gt;TCP_USER_TIMEOUT&lt;/code&gt;. Additionally, at this stage, MPTCP is incompatible with kTLS.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;path-manager-scheduler\&quot;&gt;Path manager / scheduler&lt;/h2&gt;\n            &lt;a href=\&quot;#path-manager-scheduler\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Once the peers have exchanged the address information, MPTCP is ready to kick in and perform the magic. There are two independent pieces of logic that MPTCP handles. First, given the address information, MPTCP must figure out if it should establish additional subflows. The component that decides on this is called &amp;quot;Path Manager&amp;quot;. Then, another component called &amp;quot;scheduler&amp;quot; is responsible for choosing a specific subflow to transmit the data over.&lt;/p&gt;&lt;p&gt;Both peers have a path manager, but typically only the client uses it. A path manager has a hard task to launch enough subflows to get the benefits, but not too many subflows which could waste resources. This is where the MPTCP stacks get complicated.&nbsp;&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;linux-as-client\&quot;&gt;Linux as client&lt;/h2&gt;\n            &lt;a href=\&quot;#linux-as-client\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;On Linux, path manager is an operating system feature, not an application feature. The in-kernel path manager requires some configuration — it must know which IP addresses and interfaces are okay to start new subflows. This is configured with &lt;code&gt;ip mptcp endpoint ... subflow&lt;/code&gt;, like:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ ip mptcp endpoint add dev wlp1s0 192.0.2.3 subflow  # Linux client\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;This informs the path manager that we (typically a client) own a 192.0.2.3 IP address on interface wlp1s0, and that it&amp;#39;s fine to use it as source of a new subflow. There are two additional flags that can be passed here: &amp;quot;backup&amp;quot; and &amp;quot;fullmesh&amp;quot;. Maintaining these &lt;code&gt;ip mptcp endpoints&lt;/code&gt; on a client is annoying. They need to be added and removed every time networks change. Fortunately, &lt;a href=\&quot;https://ubuntu.com/core/docs/networkmanager\&quot;&gt;&lt;u&gt;NetworkManager&lt;/u&gt;&lt;/a&gt; from 1.40 supports managing these by default. If you want to customize the &amp;quot;backup&amp;quot; or &amp;quot;fullmesh&amp;quot; flags, you can do this here (see &lt;a href=\&quot;https://networkmanager.dev/docs/api/1.44.4/settings-connection.html#:~:text=mptcp-flags\&quot;&gt;&lt;u&gt;the documentation&lt;/u&gt;&lt;/a&gt;):&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;ubuntu$ cat /etc/NetworkManager/conf.d/95-mptcp.conf\n# set &amp;quot;subflow&amp;quot; on all managed &amp;quot;ip mptcp endpoints&amp;quot;. 0x22 is the default.\n[connection]\nconnection.mptcp-flags=0x22\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;Path manager also takes a &amp;quot;limit&amp;quot; setting, to set a cap of additional subflows per MPTCP connection, and limit the received ADD-ADDR messages, like:&nbsp;&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ ip mptcp limits set subflow 4 add_addr_accepted 2  # Linux client\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;I experimented with the &amp;quot;mobility&amp;quot; use case on my Ubuntu 22 Linux laptop. I repeatedly enabled and disabled Wi-Fi and Ethernet. On new kernels (v6.12), it works, and I was able to hold a reliable MPTCP connection over many interface changes. I was &lt;a href=\&quot;https://github.com/multipath-tcp/mptcp_net-next/issues/534\&quot;&gt;&lt;u&gt;less lucky with the Ubuntu v6.8&lt;/u&gt;&lt;/a&gt; kernel. Unfortunately, the &lt;a href=\&quot;https://github.com/multipath-tcp/mptcp_net-next/issues/536\&quot;&gt;&lt;u&gt;default path manager on Linux&lt;/u&gt;&lt;/a&gt; client only works when the flag &amp;quot;&lt;i&gt;Do not attempt to establish new subflows to this address and port&lt;/i&gt;&amp;quot; is cleared on the server. Server-announced ADD-ADDR don&amp;#39;t result in new subflows created, unless &lt;code&gt;ip mptcp endpoint&lt;/code&gt; has a &lt;code&gt;fullmesh&lt;/code&gt; flag.&lt;/p&gt;&lt;p&gt;It feels like the underlying MPTCP transport code works, but the path manager requires a bit more intelligence. With a new kernel, it&amp;#39;s possible to get the &amp;quot;interactive&amp;quot; case working out of the box, but not for the ADD-ADDR case.&nbsp;&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;custom-path-manager\&quot;&gt;Custom path manager&lt;/h2&gt;\n            &lt;a href=\&quot;#custom-path-manager\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Linux allows for two implementations of a path manager component. It can either use built-in kernel implementation (default), or userspace netlink daemon.&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;$ sysctl -w net.mptcp.pm_type=1 # use userspace path manager\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;However, from what I found there is no serious implementation of configurable userspace path manager. The existing &lt;a href=\&quot;https://github.com/multipath-tcp/mptcpd/blob/main/plugins/path_managers/sspi.c\&quot;&gt;&lt;u&gt;implementations don&amp;#39;t do much&lt;/u&gt;&lt;/a&gt;, and the API &lt;a href=\&quot;https://github.com/multipath-tcp/mptcp_net-next/issues/533\&quot;&gt;&lt;u&gt;seems&lt;/u&gt;&lt;/a&gt; &lt;a href=\&quot;https://github.com/multipath-tcp/mptcp_net-next/issues/532\&quot;&gt;&lt;u&gt;immature&lt;/u&gt;&lt;/a&gt; yet.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;scheduler-and-bpf-extensions\&quot;&gt;Scheduler and BPF extensions&lt;/h2&gt;\n            &lt;a href=\&quot;#scheduler-and-bpf-extensions\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Thus far we&amp;#39;ve covered Path Manager, but what about the scheduler that chooses which link to actually use? It seems that on Linux there is only one built-in &amp;quot;default&amp;quot; scheduler, and it can do basic failover on packet loss. The developers want to write &lt;a href=\&quot;https://github.com/multipath-tcp/mptcp_net-next/issues/75\&quot;&gt;&lt;u&gt;MPTCP schedulers in BPF&lt;/u&gt;&lt;/a&gt;, and this work is in-progress.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;macos\&quot;&gt;macOS&lt;/h2&gt;\n            &lt;a href=\&quot;#macos\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;As opposed to Linux, macOS and iOS expose a raw MPTCP API. On those operating systems, path manager is not handled by the kernel, but instead can be an application responsibility. The exposed low-level API is based on &lt;code&gt;connectx()&lt;/code&gt;. For example, &lt;a href=\&quot;https://github.com/apple-oss-distributions/network_cmds/blob/97bfa5b71464f1286b51104ba3e60db78cd832c9/mptcp_client/mptcp_client.c#L461\&quot;&gt;&lt;u&gt;here&amp;#39;s an example of obscure code&lt;/u&gt;&lt;/a&gt; that establishes one connection with two subflows:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;int sock = socket(AF_MULTIPATH, SOCK_STREAM, 0);\nconnectx(sock, ..., &amp;amp;cid1);\nconnectx(sock, ..., &amp;amp;cid2);\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;This powerful API is hard to use though, as it would require every application to listen for network changes. Fortunately, macOS and iOS also expose higher-level APIs. One &lt;a href=\&quot;https://github.com/mptcp-apps/mptcp-hello/blob/main/c/macOS/main.c\&quot;&gt;&lt;u&gt;example is nw_connection&lt;/u&gt;&lt;/a&gt; in C, which uses nw_parameters_set_multipath_service.&lt;/p&gt;&lt;p&gt;Another, more common example is using &lt;code&gt;Network.framework&lt;/code&gt;, and would &lt;a href=\&quot;https://gist.github.com/majek/cb54b537c74506164d2a7fa2d6601491\&quot;&gt;&lt;u&gt;look like this&lt;/u&gt;&lt;/a&gt;:&lt;/p&gt;\n            &lt;pre class=\&quot;language-Rust\&quot;&gt;&lt;code class=\&quot;language-Rust\&quot;&gt;let parameters = NWParameters.tcp\nparameters.multipathServiceType = .interactive\nlet connection = NWConnection(host: host, port: port, using: parameters) \n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;The API supports three MPTCP service type modes:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;&lt;i&gt;Handover Mode&lt;/i&gt;: Tries to minimize cellular. Uses only Wi-Fi. Uses cellular only when &lt;a href=\&quot;https://support.apple.com/en-us/102228\&quot;&gt;&lt;u&gt;Wi-Fi Assist&lt;/u&gt;&lt;/a&gt; is enabled and makes such a decision.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;i&gt;Interactive Mode&lt;/i&gt;: Used for Siri. Reduces latency. Only for low-bandwidth flows.&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&lt;i&gt;Aggregation Mode&lt;/i&gt;: Enables resource pooling but it&amp;#39;s only available for developer accounts and not deployable.&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/47MukOs6bhCMOkO1JL15sP/7dd75417b855b681bde504122d5af01e/Screenshot_2024-12-23_at_2.59.51_PM.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1072\&quot; height=\&quot;820\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;&lt;p&gt;The MPTCP API is nicely integrated with the &lt;a href=\&quot;https://support.apple.com/en-us/102228\&quot;&gt;&lt;u&gt;iPhone &amp;quot;Wi-Fi Assist&amp;quot; feature&lt;/u&gt;&lt;/a&gt;. While the official documentation is lacking, it&amp;#39;s possible to find &lt;a href=\&quot;https://youtu.be/BucQ1lfbtd4?t=533\&quot;&gt;&lt;u&gt;sources explaining&lt;/u&gt;&lt;/a&gt; how it actually works. I was able to successfully test both the cleared &amp;quot;&lt;i&gt;Do not attempt to establish new subflows&amp;quot;&lt;/i&gt; bit and ADD-ADDR scenarios. Hurray!&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;ipv6-caveat\&quot;&gt;IPv6 caveat&lt;/h2&gt;\n            &lt;a href=\&quot;#ipv6-caveat\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Sadly, MPTCP IPv6 has a caveat. Since IPv6 addresses are long, and MPTCP uses the space-constrained TCP Extensions field, there is &lt;a href=\&quot;https://github.com/multipath-tcp/mptcp_net-next/issues/448\&quot;&gt;&lt;u&gt;not enough room for ADD-ADDR messages&lt;/u&gt;&lt;/a&gt; if TCP timestamps are enabled. If you want to use MPTCP and IPv6, it&amp;#39;s something to consider.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;summary\&quot;&gt;Summary&lt;/h2&gt;\n            &lt;a href=\&quot;#summary\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;I find MPTCP very exciting, being one of a few deployable serious TCP extensions. However, current implementations are limited. My experimentation showed that the only practical scenario where currently MPTCP might be useful is:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;Linux as a server&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;macOS/iOS as a client&lt;/p&gt;&lt;/li&gt;&lt;li&gt;&lt;p&gt;&amp;quot;interactive&amp;quot; use case&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;With a bit of effort, Linux can be made to work as a client.&lt;/p&gt;&lt;p&gt;Don&amp;#39;t get me wrong, &lt;a href=\&quot;https://netdevconf.info/0x14/pub/slides/59/mptcp-netdev0x14-final.pdf\&quot;&gt;&lt;u&gt;Linux developers did tremendous work&lt;/u&gt;&lt;/a&gt; to get where we are, but, in my opinion for any serious out-of-the-box use case, we&amp;#39;re not there yet. I&amp;#39;m optimistic that Linux can develop a good MPTCP client story relatively soon, and the possibility of implementing the Path manager and Scheduler in BPF is really enticing.&nbsp;&lt;/p&gt;&lt;p&gt;Time will tell if MPTCP succeeds — it&amp;#39;s been 15 years in the making. In the meantime, &lt;a href=\&quot;https://datatracker.ietf.org/meeting/121/materials/slides-121-quic-multipath-quic-00\&quot;&gt;&lt;u&gt;Multi-Path QUIC&lt;/u&gt;&lt;/a&gt; is under active development, but it&amp;#39;s even further from being usable at this stage.&lt;/p&gt;&lt;p&gt;We&amp;#39;re not quite sure if it makes sense for Cloudflare to support MPTCP. &lt;a href=\&quot;https://community.cloudflare.com/c/feedback/feature-request/30\&quot;&gt;&lt;u&gt;Reach out&lt;/u&gt;&lt;/a&gt; if you have a use case in mind!&lt;/p&gt;&lt;p&gt;&lt;i&gt;Shoutout to &lt;/i&gt;&lt;a href=\&quot;https://fosstodon.org/@matttbe\&quot;&gt;&lt;i&gt;&lt;u&gt;Matthieu Baerts&lt;/u&gt;&lt;/i&gt;&lt;/a&gt;&lt;i&gt; for tremendous help with this blog post.&lt;/i&gt;&lt;/p&gt;&quot;],&quot;published_at&quot;:[0,&quot;2025-01-03T14:00+00:00&quot;],&quot;updated_at&quot;:[0,&quot;2025-01-03T14:00:02.285Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1iRiEC7LY2Bm2W9o0BW9MJ/ddc3053f79278c5268c7f2f3f7db9da6/BLOG-2637_1.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;5NpgoTJYJjhgjSLaY7Gt3p&quot;],&quot;name&quot;:[0,&quot;TCP&quot;],&quot;slug&quot;:[0,&quot;tcp&quot;]}],[0,{&quot;id&quot;:[0,&quot;1U6ifhBwTuaJ2w4pjNOzNT&quot;],&quot;name&quot;:[0,&quot;Network&quot;],&quot;slug&quot;:[0,&quot;network&quot;]}],[0,{&quot;id&quot;:[0,&quot;383iv0UQ6Lp0GZwOAxGq2p&quot;],&quot;name&quot;:[0,&quot;Linux&quot;],&quot;slug&quot;:[0,&quot;linux&quot;]}],[0,{&quot;id&quot;:[0,&quot;2UVIYusJwlvsmPYl2AvSuR&quot;],&quot;name&quot;:[0,&quot;Deep Dive&quot;],&quot;slug&quot;:[0,&quot;deep-dive&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Marek Majkowski&quot;],&quot;slug&quot;:[0,&quot;marek-majkowski&quot;],&quot;bio&quot;:[0,null],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1JuU5qavgwVeqR8BAUrd6U/3a0d0445d41c9a3c42011046efe9c37b/marek-majkowski.jpeg&quot;],&quot;location&quot;:[0,null],&quot;website&quot;:[0,null],&quot;twitter&quot;:[0,&quot;@majek04&quot;],&quot;facebook&quot;:[0,null]}]]],&quot;meta_description&quot;:[0,&quot;Multi-Path TCP (MPTCP) leverages multiple network interfaces, like Wi-Fi and cellular, to provide seamless mobility for more reliable connectivity. While promising, MPTCP is still in its early stages,&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/multi-path-tcp-revolutionizing-connectivity-one-path-at-a-time&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Multi-Path TCP: Revolutionizing connectivity, one path at a time&quot;],&quot;description&quot;:[0,&quot;Multi-Path TCP (MPTCP) leverages multiple network interfaces, like Wi-Fi and cellular, to provide seamless mobility for more reliable connectivity. While promising, MPTCP is still in its early stages, with limited support and practical use cases. This post explores its potential and current limitations.\n&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2YR6jQUMONkr0AAxCB0k1q/110a9298a8bc1e34fe5ca6abb7d4588f/Multi-Path_TCP-_revolutionizing_connectivity__one_path_at_a_time-OG.png&quot;]}]}],[0,{&quot;id&quot;:[0,&quot;5GK429XQHhFzVyKSXGZ2R6&quot;],&quot;title&quot;:[0,&quot;Elephants in tunnels: how Hyperdrive connects to databases inside your VPC networks&quot;],&quot;slug&quot;:[0,&quot;elephants-in-tunnels-how-hyperdrive-connects-to-databases-inside-your-vpc-networks&quot;],&quot;excerpt&quot;:[0,&quot;Hyperdrive (Cloudflare’s globally distributed SQL connection pooler and cache) recently added support for directing database traffic from Workers across Cloudflare Tunnels. We dive deep on what it took to add this feature.&quot;],&quot;featured&quot;:[0,false],&quot;html&quot;:[0,&quot;&lt;p&gt;&lt;/p&gt;&lt;p&gt;With September’s &lt;a href=\&quot;https://blog.cloudflare.com/builder-day-2024-announcements/#connect-to-private-databases-from-workers\&quot;&gt;&lt;u&gt;announcement&lt;/u&gt;&lt;/a&gt; of Hyperdrive’s ability to send database traffic from &lt;a href=\&quot;https://workers.cloudflare.com/\&quot;&gt;&lt;u&gt;Workers&lt;/u&gt;&lt;/a&gt; over &lt;a href=\&quot;https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/\&quot;&gt;&lt;u&gt;Cloudflare Tunnels&lt;/u&gt;&lt;/a&gt;, we wanted to dive into the details of what it took to make this happen.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;hyper-who\&quot;&gt;Hyper-who?&lt;/h2&gt;\n            &lt;a href=\&quot;#hyper-who\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Accessing your data from anywhere in Region Earth can be hard. Traditional databases are powerful, familiar, and feature-rich, but your users can be thousands of miles away from your database. This can cause slower connection startup times, slower queries, and connection exhaustion as everything takes longer to accomplish.&lt;/p&gt;&lt;p&gt;&lt;a href=\&quot;https://developers.cloudflare.com/workers/\&quot;&gt;&lt;u&gt;Cloudflare Workers&lt;/u&gt;&lt;/a&gt; is an incredibly lightweight runtime, which enables our customers to deploy their applications globally by default and renders the &lt;a href=\&quot;https://en.wikipedia.org/wiki/Cold_start_(computing)\&quot;&gt;&lt;u&gt;cold start&lt;/u&gt;&lt;/a&gt; problem almost irrelevant. The trade-off for these light, ephemeral execution contexts is the lack of persistence for things like database connections. Database connections are also notoriously expensive to spin up, with many round trips required between client and server before any query or result bytes can be exchanged.&lt;/p&gt;&lt;p&gt;&lt;a href=\&quot;https://blog.cloudflare.com/hyperdrive-making-regional-databases-feel-distributed\&quot;&gt;&lt;u&gt;Hyperdrive&lt;/u&gt;&lt;/a&gt; is designed to make the centralized databases you already have feel like they’re global while keeping connections to those databases hot. We use our &lt;a href=\&quot;https://www.cloudflare.com/network/\&quot;&gt;&lt;u&gt;global network&lt;/u&gt;&lt;/a&gt; to get faster routes to your database, keep connection pools primed, and cache your most frequently run queries as close to users as possible.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;why-a-tunnel\&quot;&gt;Why a Tunnel?&lt;/h2&gt;\n            &lt;a href=\&quot;#why-a-tunnel\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;For something as sensitive as your database, exposing access to the public Internet can be uncomfortable. It is common to instead host your database on a private network, and allowlist known-safe IP addresses or configure &lt;a href=\&quot;https://www.cloudflare.com/learning/network-layer/what-is-gre-tunneling/\&quot;&gt;&lt;u&gt;GRE tunnels&lt;/u&gt;&lt;/a&gt; to permit traffic to it. This is complex, toilsome, and error-prone.&nbsp;&lt;/p&gt;&lt;p&gt;On Cloudflare’s &lt;a href=\&quot;https://www.cloudflare.com/en-gb/developer-platform/\&quot;&gt;&lt;u&gt;Developer Platform&lt;/u&gt;&lt;/a&gt;, we strive for simplicity and ease-of-use. We cannot expect all of our customers to be experts in configuring networking solutions, and so we went in search of a simpler solution. &lt;a href=\&quot;https://www.cloudflare.com/the-net/top-of-mind-security/customer-zero/\&quot;&gt;&lt;u&gt;Being your own customer&lt;/u&gt;&lt;/a&gt; is rarely a bad choice, and it so happens that Cloudflare offers an excellent option for this scenario: Tunnels.&lt;/p&gt;&lt;p&gt;&lt;a href=\&quot;https://www.cloudflare.com/products/tunnel/\&quot;&gt;&lt;u&gt;Cloudflare Tunnel&lt;/u&gt;&lt;/a&gt; is a Zero Trust product that creates a secure connection between your private network and Cloudflare. Exposing services within your private network can be as simple as &lt;a href=\&quot;https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/downloads/\&quot;&gt;&lt;u&gt;running a &lt;/u&gt;&lt;code&gt;&lt;u&gt;cloudflared&lt;/u&gt;&lt;/code&gt;&lt;u&gt; binary&lt;/u&gt;&lt;/a&gt;, or deploying a Docker container running the &lt;a href=\&quot;https://hub.docker.com/r/cloudflare/cloudflared\&quot;&gt;&lt;code&gt;&lt;u&gt;cloudflared&lt;/u&gt;&lt;/code&gt;&lt;u&gt; image we distribute&lt;/u&gt;&lt;/a&gt;. &lt;/p&gt;\n          &lt;figure class=\&quot;kg-card kg-image-card\&quot;&gt;\n          &lt;Image src=\&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3182f43rbwdH9krF1xhdlC/d22430cdb1efa134031f94fea691c36e/image1.png\&quot; alt=\&quot;\&quot; class=\&quot;kg-image\&quot; width=\&quot;1000\&quot; height=\&quot;180\&quot; loading=\&quot;lazy\&quot;/&gt;\n          &lt;/figure&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;a-custom-handler-and-generic-streams\&quot;&gt;A custom handler and generic streams&lt;/h2&gt;\n            &lt;a href=\&quot;#a-custom-handler-and-generic-streams\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Integrating with Tunnels to support sending Postgres directly through them was a bit of a new challenge for us. Most of the time, when we use Tunnels internally (more on that later!), we rely on the excellent job &lt;code&gt;cloudflared&lt;/code&gt; does of handling all of the mechanics, and we just treat them as pipes. That wouldn’t work for Hyperdrive, though, so we had to dig into how Tunnels actually ingress traffic to build a solution.&lt;/p&gt;&lt;p&gt;Hyperdrive handles Postgres traffic using an entirely custom implementation of the &lt;a href=\&quot;https://www.postgresql.org/docs/current/protocol.html\&quot;&gt;&lt;u&gt;Postgres message protocol&lt;/u&gt;&lt;/a&gt;. This is necessary, because we sometimes have to &lt;a href=\&quot;https://blog.cloudflare.com/postgres-named-prepared-statements-supported-hyperdrive\&quot;&gt;&lt;u&gt;alter the specific type or content&lt;/u&gt;&lt;/a&gt; of messages sent from client to server, or vice versa. Handling individual bytes gives us the flexibility to implement whatever logic any new feature might need.&lt;/p&gt;&lt;p&gt;An additional, perhaps less obvious, benefit of handling Postgres message traffic as just bytes is that we are not bound to the transport layer choices of some &lt;a href=\&quot;https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping\&quot;&gt;&lt;u&gt;ORM&lt;/u&gt;&lt;/a&gt; or library. One of the nuances of running services in Cloudflare is that we may want to egress traffic over different services or protocols, for a variety of different reasons. In this case, being able to egress traffic via a Tunnel would be pretty challenging if we were stuck with whatever raw TCP socket a library had established for us.&lt;/p&gt;&lt;p&gt;The way we accomplish this relies on a mainstay of Rust: &lt;a href=\&quot;https://doc.rust-lang.org/book/ch10-02-traits.html\&quot;&gt;&lt;u&gt;traits&lt;/u&gt;&lt;/a&gt; (which are how Rust lets developers apply logic across generic functions and types). In the Rust ecosystem, there are two traits that define the behavior Hyperdrive wants out of its transport layers: &lt;a href=\&quot;https://docs.rs/tokio/latest/tokio/io/trait.AsyncRead.html\&quot;&gt;&lt;code&gt;&lt;u&gt;AsyncRead&lt;/u&gt;&lt;/code&gt;&lt;/a&gt; and &lt;a href=\&quot;https://docs.rs/tokio/latest/tokio/io/trait.AsyncWrite.html\&quot;&gt;&lt;code&gt;&lt;u&gt;AsyncWrite&lt;/u&gt;&lt;/code&gt;&lt;/a&gt;. There are a couple of others we also need, but we’re going to focus on just these two. These traits enable us to code our entire custom handler against a generic stream of data, without the handler needing to know anything about the underlying protocol used to implement the stream. So, we can pass around a WebSocket connection as a generic I/O stream, wherever it might be needed.&lt;/p&gt;&lt;p&gt;As an example, the code to create a generic TCP stream and send a Postgres startup message across it might look like this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-RUST\&quot;&gt;&lt;code class=\&quot;language-RUST\&quot;&gt;/// Send a startup message to a Postgres server, in the role of a PG client.\n/// https://www.postgresql.org/docs/current/protocol-message-formats.html#PROTOCOL-MESSAGE-FORMATS-STARTUPMESSAGE\npub async fn send_startup&amp;lt;S&amp;gt;(stream: &amp;amp;mut S, user_name: &amp;amp;str, db_name: &amp;amp;str, app_name: &amp;amp;str) -&amp;gt; Result&amp;lt;(), ConnectionError&amp;gt;\nwhere\n    S: AsyncWrite + Unpin,\n{\n    let protocol_number = 196608 as i32;\n    let user_str = &amp;amp;b&amp;quot;user\\0&amp;quot;[..];\n    let user_bytes = user_name.as_bytes();\n    let db_str = &amp;amp;b&amp;quot;database\\0&amp;quot;[..];\n    let db_bytes = db_name.as_bytes();\n    let app_str = &amp;amp;b&amp;quot;application_name\\0&amp;quot;[..];\n    let app_bytes = app_name.as_bytes();\n    let len = 4 + 4\n        + user_str.len() + user_bytes.len() + 1\n        + db_str.len() + db_bytes.len() + 1\n        + app_str.len() + app_bytes.len() + 1 + 1;\n\n    // Construct a BytesMut of our startup message, then send it\n    let mut startup_message = BytesMut::with_capacity(len as usize);\n    startup_message.put_i32(len as i32);\n    startup_message.put_i32(protocol_number);\n    startup_message.put(user_str);\n    startup_message.put_slice(user_bytes);\n    startup_message.put_u8(0);\n    startup_message.put(db_str);\n    startup_message.put_slice(db_bytes);\n    startup_message.put_u8(0);\n    startup_message.put(app_str);\n    startup_message.put_slice(app_bytes);\n    startup_message.put_u8(0);\n    startup_message.put_u8(0);\n\n    match stream.write_all(&amp;amp;startup_message).await {\n        Ok(_) =&amp;gt; Ok(()),\n        Err(err) =&amp;gt; {\n            error!(&amp;quot;Error writing startup to server: {}&amp;quot;, err.to_string());\n            ConnectionError::InternalError\n        }\n    }\n}\n\n/// Connect to a TCP socket\nlet stream = match TcpStream::connect((&amp;quot;localhost&amp;quot;, 5432)).await {\n    Ok(s) =&amp;gt; s,\n    Err(err) =&amp;gt; {\n        error!(&amp;quot;Error connecting to address: {}&amp;quot;, err.to_string());\n        return ConnectionError::InternalError;\n    }\n};\nlet _ = send_startup(&amp;amp;mut stream, &amp;quot;db_user&amp;quot;, &amp;quot;my_db&amp;quot;).await;&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;With this approach, if we wanted to encrypt the stream using &lt;a href=\&quot;https://www.cloudflare.com/learning/ssl/transport-layer-security-tls/#:~:text=Transport%20Layer%20Security%2C%20or%20TLS,web%20browsers%20loading%20a%20website.\&quot;&gt;&lt;u&gt;TLS&lt;/u&gt;&lt;/a&gt; before we write to it (upgrading our existing &lt;code&gt;TcpStream&lt;/code&gt; connection in-place, to an &lt;code&gt;SslStream&lt;/code&gt;), we would only have to change the code we use to create the stream, while generating and sending the traffic would remain unchanged. This is because &lt;code&gt;SslStream&lt;/code&gt; also implements &lt;code&gt;AsyncWrite&lt;/code&gt;!&lt;/p&gt;\n            &lt;pre class=\&quot;language-RUST\&quot;&gt;&lt;code class=\&quot;language-RUST\&quot;&gt;/// We&amp;#039;re handwaving the SSL setup here. You&amp;#039;re welcome.\nlet conn_config = new_tls_client_config()?;\n\n/// Encrypt the TcpStream, returning an SslStream\nlet ssl_stream = match tokio_boring::connect(conn_config, domain, stream).await {\n    Ok(s) =&amp;gt; s,\n    Err(err) =&amp;gt; {\n        error!(&amp;quot;Error during websocket TLS handshake: {}&amp;quot;, err.to_string());\n        return ConnectionError::InternalError;\n    }\n};\nlet _ = send_startup(&amp;amp;mut ssl_stream, &amp;quot;db_user&amp;quot;, &amp;quot;my_db&amp;quot;).await;&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;whence-websocket\&quot;&gt;Whence WebSocket&lt;/h2&gt;\n            &lt;a href=\&quot;#whence-websocket\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;&lt;a href=\&quot;https://datatracker.ietf.org/doc/html/rfc6455\&quot;&gt;&lt;u&gt;WebSocket&lt;/u&gt;&lt;/a&gt; is an application layer protocol that enables bidirectional communication between a client and server. Typically, to establish a WebSocket connection, a client initiates an HTTP request and indicates they wish to upgrade the connection to WebSocket via the “Upgrade” header. Then, once the client and server complete the handshake, both parties can send messages over the connection until one of them terminates it.&lt;/p&gt;&lt;p&gt;Now, it turns out that the way Cloudflare Tunnels work under the hood is that both ends of the tunnel want to speak WebSocket, and rely on a translation layer to convert all traffic to or from WebSocket. The &lt;code&gt;cloudflared&lt;/code&gt; daemon you spin up within your private network handles this for us! For Hyperdrive, however, we did not have a suitable translation layer to send Postgres messages across WebSocket, and had to write one.&lt;/p&gt;&lt;p&gt;One of the (many) fantastic things about Rust traits is that the contract they present is very clear. To be &lt;code&gt;AsyncRead&lt;/code&gt;, you just need to implement &lt;code&gt;poll_read&lt;/code&gt;. To be &lt;code&gt;AsyncWrite&lt;/code&gt;, you need to implement only three functions (&lt;code&gt;poll_write&lt;/code&gt;, &lt;code&gt;poll_flush&lt;/code&gt;, and &lt;code&gt;poll_shutdown&lt;/code&gt;). Further, there is excellent support for WebSocket in Rust built on top of the &lt;a href=\&quot;https://github.com/snapview/tungstenite-rs\&quot;&gt;&lt;u&gt;tungstenite-rs library&lt;/u&gt;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Thus, building our custom WebSocket stream such that it can share the same machinery as all our other generic streams just means translating the existing WebSocket support into these poll functions. There are some existing OSS projects that do this, but for multiple reasons we could not use the existing options. The primary reason is that Hyperdrive operates across multiple threads (thanks to the &lt;a href=\&quot;https://docs.rs/tokio/latest/tokio/runtime/index.html\&quot;&gt;&lt;u&gt;tokio runtime&lt;/u&gt;&lt;/a&gt;), and so we rely on our connections to also handle &lt;a href=\&quot;https://doc.rust-lang.org/std/marker/trait.Send.html\&quot;&gt;&lt;code&gt;&lt;u&gt;Send&lt;/u&gt;&lt;/code&gt;&lt;/a&gt;, &lt;a href=\&quot;https://doc.rust-lang.org/std/marker/trait.Sync.html\&quot;&gt;&lt;code&gt;&lt;u&gt;Sync&lt;/u&gt;&lt;/code&gt;&lt;/a&gt;, and &lt;a href=\&quot;https://doc.rust-lang.org/std/marker/trait.Unpin.html\&quot;&gt;&lt;code&gt;&lt;u&gt;Unpin&lt;/u&gt;&lt;/code&gt;&lt;/a&gt;. None of the available solutions had all five traits handled. It turns out that most of them went with the paradigm of &lt;a href=\&quot;https://docs.rs/futures/latest/futures/sink/trait.Sink.html\&quot;&gt;&lt;code&gt;&lt;u&gt;Sink&lt;/u&gt;&lt;/code&gt;&lt;/a&gt; and &lt;a href=\&quot;https://docs.rs/futures/latest/futures/stream/trait.Stream.html\&quot;&gt;&lt;code&gt;&lt;u&gt;Stream&lt;/u&gt;&lt;/code&gt;&lt;/a&gt;, which provide a solid base from which to translate to &lt;code&gt;AsyncRead&lt;/code&gt; and &lt;code&gt;AsyncWrite&lt;/code&gt;. In fact some of the functions overlap, and can be passed through almost unchanged. For example, &lt;code&gt;poll_flush&lt;/code&gt; and &lt;code&gt;poll_shutdown&lt;/code&gt; have 1-to-1 analogs, and require almost no engineering effort to convert from &lt;code&gt;Sink&lt;/code&gt; to &lt;code&gt;AsyncWrite&lt;/code&gt;.&lt;/p&gt;\n            &lt;pre class=\&quot;language-RUST\&quot;&gt;&lt;code class=\&quot;language-RUST\&quot;&gt;/// We use this struct to implement the traits we need on top of a WebSocketStream\npub struct HyperSocket&amp;lt;S&amp;gt;\nwhere\n    S: AsyncRead + AsyncWrite + Send + Sync + Unpin,\n{\n    inner: WebSocketStream&amp;lt;S&amp;gt;,\n    read_state: Option&amp;lt;ReadState&amp;gt;,\n    write_err: Option&amp;lt;Error&amp;gt;,\n}\n\nimpl&amp;lt;S&amp;gt; AsyncWrite for HyperSocket&amp;lt;S&amp;gt;\nwhere\n    S: AsyncRead + AsyncWrite + Send + Sync + Unpin,\n{\n    fn poll_flush(mut self: Pin&amp;lt;&amp;amp;mut Self&amp;gt;, cx: &amp;amp;mut Context&amp;lt;&amp;#039;_&amp;gt;) -&amp;gt; Poll&amp;lt;io::Result&amp;lt;()&amp;gt;&amp;gt; {\n        match ready!(Pin::new(&amp;amp;mut self.inner).poll_flush(cx)) {\n            Ok(_) =&amp;gt; Poll::Ready(Ok(())),\n            Err(err) =&amp;gt; Poll::Ready(Err(Error::new(ErrorKind::Other, err))),\n        }\n    }\n\n    fn poll_shutdown(mut self: Pin&amp;lt;&amp;amp;mut Self&amp;gt;, cx: &amp;amp;mut Context&amp;lt;&amp;#039;_&amp;gt;) -&amp;gt; Poll&amp;lt;io::Result&amp;lt;()&amp;gt;&amp;gt; {\n        match ready!(Pin::new(&amp;amp;mut self.inner).poll_close(cx)) {\n            Ok(_) =&amp;gt; Poll::Ready(Ok(())),\n            Err(err) =&amp;gt; Poll::Ready(Err(Error::new(ErrorKind::Other, err))),\n        }\n    }\n}\n&lt;/pre&gt;&lt;/code&gt;\n            &lt;p&gt;With that translation done, we can use an existing WebSocket library to upgrade our &lt;code&gt;SslStream&lt;/code&gt; connection to a Cloudflare Tunnel, and wrap the result in our &lt;code&gt;AsyncRead/AsyncWrite&lt;/code&gt; implementation. The result can then be used anywhere that our other transport streams would work, without any changes needed to the rest of our codebase!&nbsp;&lt;/p&gt;&lt;p&gt;That would look something like this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-RUST\&quot;&gt;&lt;code class=\&quot;language-RUST\&quot;&gt;let websocket = match tokio_tungstenite::client_async(request, ssl_stream).await {\n    Ok(ws) =&amp;gt; Ok(ws),\n    Err(err) =&amp;gt; {\n        error!(&amp;quot;Error during websocket conn setup: {}&amp;quot;, err.to_string());\n        return ConnectionError::InternalError;\n    }\n};\nlet websocket_stream = HyperSocket::new(websocket));\nlet _ = send_startup(&amp;amp;mut websocket_stream, &amp;quot;db_user&amp;quot;, &amp;quot;my_db&amp;quot;).await;&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;access-granted\&quot;&gt;Access granted&lt;/h2&gt;\n            &lt;a href=\&quot;#access-granted\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;An observant reader might have noticed that in the code example above we snuck in a variable named request that we passed in when upgrading from an &lt;code&gt;SslStream to a WebSocketStream&lt;/code&gt;. This is for multiple reasons. The first reason is that Tunnels are assigned a hostname and use this hostname for routing. The second and more interesting reason is that (as mentioned above) when negotiating an upgrade from HTTP to WebSocket, a request must be sent to the server hosting the ingress side of the Tunnel to &lt;a href=\&quot;https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism\&quot;&gt;&lt;u&gt;perform the upgrade&lt;/u&gt;&lt;/a&gt;. This is pretty universal, but we also add in an extra piece here.&lt;/p&gt;&lt;p&gt;At Cloudflare, we believe that &lt;a href=\&quot;https://blog.cloudflare.com/secure-by-default-understanding-new-cisa-guide/\&quot;&gt;&lt;u&gt;secure defaults&lt;/u&gt;&lt;/a&gt; and &lt;a href=\&quot;https://www.cloudflare.com/learning/security/glossary/what-is-defense-in-depth/\&quot;&gt;&lt;u&gt;defense in depth&lt;/u&gt;&lt;/a&gt; are the correct ways to build a better Internet. This is why traffic across Tunnels is encrypted, for example. However, that does not necessarily prevent unwanted traffic from being sent into your Tunnel, and therefore egressing out to your database. While Postgres offers a robust set of &lt;a href=\&quot;https://www.postgresql.org/docs/current/user-manag.html\&quot;&gt;&lt;u&gt;access control&lt;/u&gt;&lt;/a&gt; options for protecting your database, wouldn’t it be best if unwanted traffic never got into your private network in the first place?&nbsp;&lt;/p&gt;&lt;p&gt;To that end, all &lt;a href=\&quot;https://developers.cloudflare.com/hyperdrive/configuration/connect-to-private-database/\&quot;&gt;&lt;u&gt;Tunnels set up for use with Hyperdrive&lt;/u&gt;&lt;/a&gt; should have a &lt;a href=\&quot;https://developers.cloudflare.com/cloudflare-one/applications/\&quot;&gt;&lt;u&gt;Zero Trust Access Application&lt;/u&gt;&lt;/a&gt; configured to protect them. These applications should use a &lt;a href=\&quot;https://developers.cloudflare.com/cloudflare-one/identity/service-tokens/\&quot;&gt;&lt;u&gt;Service Token&lt;/u&gt;&lt;/a&gt; to authorize connections. When setting up a new Hyperdrive, you have the option to provide the token’s ID and Secret, which will be encrypted and stored alongside the rest of your configuration. These will be presented as part of the WebSocket upgrade request to authorize the connection, allowing your database traffic through while preventing unwanted access.&lt;/p&gt;&lt;p&gt;This can be done within the request’s headers, and might look something like this:&lt;/p&gt;\n            &lt;pre class=\&quot;language-RUST\&quot;&gt;&lt;code class=\&quot;language-RUST\&quot;&gt;let ws_url = format!(&amp;quot;wss://{}&amp;quot;, host);\nlet mut request = match ws_url.into_client_request() {\n    Ok(req) =&amp;gt; req,\n    Err(err) =&amp;gt; {\n        error!(\n            &amp;quot;Hostname {} could not be parsed into a valid request URL: {}&amp;quot;, \n            host,\n            err.to_string()\n        );\n        return ConnectionError::InternalError;\n    }\n};\nrequest.headers_mut().insert(\n    &amp;quot;CF-Access-Client-Id&amp;quot;,\n    http::header::HeaderValue::from_str(&amp;amp;client_id).unwrap(),\n);\nrequest.headers_mut().insert(\n    &amp;quot;CF-Access-Client-Secret&amp;quot;,\n    http::header::HeaderValue::from_str(&amp;amp;client_secret).unwrap(),\n);\n&lt;/pre&gt;&lt;/code&gt;\n            \n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;building-for-customer-zero\&quot;&gt;Building for customer zero&lt;/h2&gt;\n            &lt;a href=\&quot;#building-for-customer-zero\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;If you’ve been reading the blog for a long time, some of this might sound a bit familiar.&nbsp; This isn’t the first time that we’ve &lt;a href=\&quot;https://blog.cloudflare.com/cloudflare-tunnel-for-postgres/\&quot;&gt;&lt;u&gt;sent Postgres traffic across a tunnel&lt;/u&gt;&lt;/a&gt;, it’s something most of us do from our laptops regularly.&nbsp; This works very well for interactive use cases with low traffic volume and a high tolerance for latency, but historically most of our products have not been able to employ the same approach.&lt;/p&gt;&lt;p&gt;Cloudflare operates &lt;a href=\&quot;https://www.cloudflare.com/network/\&quot;&gt;&lt;u&gt;many data centers&lt;/u&gt;&lt;/a&gt; around the world, and most services run in every one of those data centers. There are some tasks, however, that make the most sense to run in a more centralized fashion. These include tasks such as managing control plane operations, or storing configuration state.&nbsp; Nearly every Cloudflare product houses its control plane information in &lt;a href=\&quot;https://blog.cloudflare.com/performance-isolation-in-a-multi-tenant-database-environment/\&quot;&gt;&lt;u&gt;Postgres clusters&lt;/u&gt;&lt;/a&gt; run centrally in a handful of our data centers, and we use a variety of approaches for accessing that centralized data from elsewhere in our network. For example, many services currently use a push-based model to publish updates to &lt;a href=\&quot;https://blog.cloudflare.com/moving-quicksilver-into-production/\&quot;&gt;&lt;u&gt;Quicksilver&lt;/u&gt;&lt;/a&gt;, and work through the complexities implied by such a model. This has been a recurring challenge for any team looking to build a new product.&lt;/p&gt;&lt;p&gt;Hyperdrive’s entire reason for being is to make it easy to access such central databases from our global network. When we began exploring Tunnel integrations as a feature, many internal teams spoke up immediately and strongly suggested they’d be interested in using it themselves. This was an excellent opportunity for Cloudflare to scratch its own itch, while also getting a lot of traffic on a new feature before releasing it directly to the public. As always, being “customer zero” means that we get fast feedback, more reliability over time, stronger connections between teams, and an overall better suite of products. We jumped at the chance.&lt;/p&gt;&lt;p&gt;As we rolled out early versions of Tunnel integration, we worked closely with internal teams to get them access to it, and fixed any rough spots they encountered. We’re pleased to share that this first batch of teams have found great success building new or refactored products on Hyperdrive over Tunnels. For example: if you’ve already tried out &lt;a href=\&quot;https://blog.cloudflare.com/builder-day-2024-announcements/#continuous-integration-and-delivery\&quot;&gt;&lt;u&gt;Workers Builds&lt;/u&gt;&lt;/a&gt;, or recently &lt;a href=\&quot;https://www.cloudflare.com/trust-hub/reporting-abuse/\&quot;&gt;&lt;u&gt;submitted an abuse report&lt;/u&gt;&lt;/a&gt;, you’re among our first users!&nbsp; At the time of this writing, we have several more internal teams working to onboard, and we on the Hyperdrive team are very excited to see all the different ways in which fast and simple connections from Workers to a centralized database can help Cloudflare just as much as they’ve been helping our external customers.&lt;/p&gt;\n          &lt;div class=\&quot;flex anchor relative\&quot;&gt;\n            &lt;h2 id=\&quot;outro\&quot;&gt;Outro&lt;/h2&gt;\n            &lt;a href=\&quot;#outro\&quot; aria-hidden=\&quot;true\&quot; class=\&quot;relative sm:absolute sm:-left-5\&quot;&gt;\n              &lt;svg width=\&quot;16\&quot; height=\&quot;16\&quot; viewBox=\&quot;0 0 24 24\&quot;&gt;&lt;path fill=\&quot;currentcolor\&quot; d=\&quot;m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z\&quot;&gt;&lt;/path&gt;&lt;/svg&gt;\n            &lt;/a&gt;\n          &lt;/div&gt;\n          &lt;p&gt;Cloudflare is on a mission to make the Internet faster, safer, and more reliable. Hyperdrive was built to make connecting to centralized databases from the Workers runtime as quick and consistent as possible, and this latest development is designed to help all those who want to use Hyperdrive without directly exposing resources within their virtual private clouds (VPCs) on the public web.&lt;/p&gt;&lt;p&gt;To this end, we chose to build a solution around our suite of industry-leading &lt;a href=\&quot;https://developers.cloudflare.com/cloudflare-one/\&quot;&gt;&lt;u&gt;Zero Trust&lt;/u&gt;&lt;/a&gt; tools, and were delighted to find how simple it was to implement in our runtime given the power and extensibility of the Rust &lt;code&gt;trait&lt;/code&gt; system.&nbsp;&lt;/p&gt;&lt;p&gt;Without waiting for the ink to dry, multiple teams within Cloudflare have adopted this new feature to quickly and easily solve what have historically been complex challenges, and are happily operating it in production today.&lt;/p&gt;&lt;p&gt;And now, if you haven&amp;#39;t already, try &lt;a href=\&quot;https://developers.cloudflare.com/hyperdrive/configuration/connect-to-private-database/\&quot;&gt;&lt;u&gt;setting up Hyperdrive across a Tunnel&lt;/u&gt;&lt;/a&gt;, and let us know what you think in the &lt;a href=\&quot;https://discord.com/channels/595317990191398933/1150557986239021106\&quot;&gt;&lt;u&gt;Hyperdrive Discord channel&lt;/u&gt;&lt;/a&gt;!&lt;/p&gt;&quot;],&quot;published_at&quot;:[0,&quot;2024-10-25T14:00+01:00&quot;],&quot;updated_at&quot;:[0,&quot;2024-10-29T13:01:27.233Z&quot;],&quot;feature_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/24ic7s5StC7EDyqYne4WN6/02f061b0aef358ecc2d5da4150e5b0fc/image2.png&quot;],&quot;tags&quot;:[1,[[0,{&quot;id&quot;:[0,&quot;3JAY3z7p7An94s6ScuSQPf&quot;],&quot;name&quot;:[0,&quot;Developer Platform&quot;],&quot;slug&quot;:[0,&quot;developer-platform&quot;]}],[0,{&quot;id&quot;:[0,&quot;2UVIYusJwlvsmPYl2AvSuR&quot;],&quot;name&quot;:[0,&quot;Deep Dive&quot;],&quot;slug&quot;:[0,&quot;deep-dive&quot;]}],[0,{&quot;id&quot;:[0,&quot;6hbkItfupogJP3aRDAq6v8&quot;],&quot;name&quot;:[0,&quot;Cloudflare Workers&quot;],&quot;slug&quot;:[0,&quot;workers&quot;]}],[0,{&quot;id&quot;:[0,&quot;5EP9xxxSTGvFx3RIxjqIgP&quot;],&quot;name&quot;:[0,&quot;Hyperdrive&quot;],&quot;slug&quot;:[0,&quot;hyperdrive&quot;]}],[0,{&quot;id&quot;:[0,&quot;5f5l99WZnbCCF9O6Emw56A&quot;],&quot;name&quot;:[0,&quot;Postgres&quot;],&quot;slug&quot;:[0,&quot;postgres&quot;]}],[0,{&quot;id&quot;:[0,&quot;1pPf2NNj9SXrC0A0ERKp9v&quot;],&quot;name&quot;:[0,&quot;SQL&quot;],&quot;slug&quot;:[0,&quot;sql&quot;]}],[0,{&quot;id&quot;:[0,&quot;w4e8pkoz9c8xNDVhy9eNe&quot;],&quot;name&quot;:[0,&quot;Rust&quot;],&quot;slug&quot;:[0,&quot;rust&quot;]}],[0,{&quot;id&quot;:[0,&quot;1aoMsyWESTqiSKzdHZXOKW&quot;],&quot;name&quot;:[0,&quot;WebSockets&quot;],&quot;slug&quot;:[0,&quot;websockets&quot;]}]]],&quot;relatedTags&quot;:[0],&quot;authors&quot;:[1,[[0,{&quot;name&quot;:[0,&quot;Andrew Repp&quot;],&quot;slug&quot;:[0,&quot;andrew-repp&quot;],&quot;bio&quot;:[0,null],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1moTBd0N5e74Bn9NWn2ksO/9642b164dcf16e501a79e56520548aa2/andrew-repp.jpg&quot;],&quot;location&quot;:[0,&quot;Chicago, IL, USA&quot;],&quot;website&quot;:[0,&quot;http://andrewrepp.com&quot;],&quot;twitter&quot;:[0,null],&quot;facebook&quot;:[0,null]}],[0,{&quot;name&quot;:[0,&quot;Emilio Assunção&quot;],&quot;slug&quot;:[0,&quot;emilio-assuncao&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3tOkImW4PKNYEyP4o7Pkhe/ee40249c46e72656a8e2352485ec7d5e/_tmp_mini_magick20221018-42-16be3qy.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0],&quot;facebook&quot;:[0]}],[0,{&quot;name&quot;:[0,&quot;Abhishek Chanda&quot;],&quot;slug&quot;:[0,&quot;abhishek-chanda&quot;],&quot;bio&quot;:[0],&quot;profile_image&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3P0qYqbNeI32RV8dDNiWyr/851507446803b9f182229b98e512eb5f/_tmp_mini_magick20221012-43-o7wrnr.jpg&quot;],&quot;location&quot;:[0],&quot;website&quot;:[0],&quot;twitter&quot;:[0,&quot;@rony358&quot;],&quot;facebook&quot;:[0]}]]],&quot;meta_description&quot;:[0,&quot;Hyperdrive (Cloudflare’s globally distributed SQL connection pooler and cache) recently added support for directing database traffic from Workers across Cloudflare Tunnels. We dive deep on what it took to add this feature.&quot;],&quot;primary_author&quot;:[0,{}],&quot;localeList&quot;:[0,{&quot;name&quot;:[0,&quot;blog-english-only&quot;],&quot;enUS&quot;:[0,&quot;English for Locale&quot;],&quot;zhCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhHansCN&quot;:[0,&quot;No Page for Locale&quot;],&quot;zhTW&quot;:[0,&quot;No Page for Locale&quot;],&quot;frFR&quot;:[0,&quot;No Page for Locale&quot;],&quot;deDE&quot;:[0,&quot;No Page for Locale&quot;],&quot;itIT&quot;:[0,&quot;No Page for Locale&quot;],&quot;jaJP&quot;:[0,&quot;No Page for Locale&quot;],&quot;koKR&quot;:[0,&quot;No Page for Locale&quot;],&quot;ptBR&quot;:[0,&quot;No Page for Locale&quot;],&quot;esLA&quot;:[0,&quot;No Page for Locale&quot;],&quot;esES&quot;:[0,&quot;No Page for Locale&quot;],&quot;enAU&quot;:[0,&quot;No Page for Locale&quot;],&quot;enCA&quot;:[0,&quot;No Page for Locale&quot;],&quot;enIN&quot;:[0,&quot;No Page for Locale&quot;],&quot;enGB&quot;:[0,&quot;No Page for Locale&quot;],&quot;idID&quot;:[0,&quot;No Page for Locale&quot;],&quot;ruRU&quot;:[0,&quot;No Page for Locale&quot;],&quot;svSE&quot;:[0,&quot;No Page for Locale&quot;],&quot;viVN&quot;:[0,&quot;No Page for Locale&quot;],&quot;plPL&quot;:[0,&quot;No Page for Locale&quot;],&quot;arAR&quot;:[0,&quot;No Page for Locale&quot;],&quot;nlNL&quot;:[0,&quot;No Page for Locale&quot;],&quot;thTH&quot;:[0,&quot;No Page for Locale&quot;],&quot;trTR&quot;:[0,&quot;No Page for Locale&quot;],&quot;heIL&quot;:[0,&quot;No Page for Locale&quot;],&quot;lvLV&quot;:[0,&quot;No Page for Locale&quot;],&quot;etEE&quot;:[0,&quot;No Page for Locale&quot;],&quot;ltLT&quot;:[0,&quot;No Page for Locale&quot;]}],&quot;url&quot;:[0,&quot;https://blog.cloudflare.com/elephants-in-tunnels-how-hyperdrive-connects-to-databases-inside-your-vpc-networks&quot;],&quot;metadata&quot;:[0,{&quot;title&quot;:[0,&quot;Elephants in tunnels: how Hyperdrive connects to databases inside your VPC networks&quot;],&quot;description&quot;:[0,&quot;Hyperdrive (Cloudflare’s globally distributed SQL connection pooler and cache) recently added support for directing database traffic from Workers across Cloudflare Tunnels. We dive deep on what it took to add this feature.&quot;],&quot;imgPreview&quot;:[0,&quot;https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3ut6WBHomsRN0iP92D1hpp/ecdc9573ebc09c140c865494d029f54e/image2.png&quot;]}]}]]],&quot;locale&quot;:[0,&quot;en-us&quot;],&quot;translations&quot;:[0,{&quot;posts.by&quot;:[0,&quot;By&quot;],&quot;footer.gdpr&quot;:[0,&quot;GDPR&quot;],&quot;lang_blurb1&quot;:[0,&quot;This post is also available in {lang1}.&quot;],&quot;lang_blurb2&quot;:[0,&quot;This post is also available in {lang1} and {lang2}.&quot;],&quot;lang_blurb3&quot;:[0,&quot;This post is also available in {lang1}, {lang2} and {lang3}.&quot;],&quot;footer.press&quot;:[0,&quot;Press&quot;],&quot;header.title&quot;:[0,&quot;The Cloudflare Blog&quot;],&quot;search.clear&quot;:[0,&quot;Clear&quot;],&quot;search.filter&quot;:[0,&quot;Filter&quot;],&quot;search.source&quot;:[0,&quot;Source&quot;],&quot;footer.careers&quot;:[0,&quot;Careers&quot;],&quot;footer.company&quot;:[0,&quot;Company&quot;],&quot;footer.support&quot;:[0,&quot;Support&quot;],&quot;footer.the_net&quot;:[0,&quot;theNet&quot;],&quot;search.filters&quot;:[0,&quot;Filters&quot;],&quot;footer.our_team&quot;:[0,&quot;Our team&quot;],&quot;footer.webinars&quot;:[0,&quot;Webinars&quot;],&quot;page.more_posts&quot;:[0,&quot;More posts&quot;],&quot;posts.time_read&quot;:[0,&quot;{time} min read&quot;],&quot;search.language&quot;:[0,&quot;Language&quot;],&quot;footer.community&quot;:[0,&quot;Community&quot;],&quot;footer.resources&quot;:[0,&quot;Resources&quot;],&quot;footer.solutions&quot;:[0,&quot;Solutions&quot;],&quot;footer.trademark&quot;:[0,&quot;Trademark&quot;],&quot;header.subscribe&quot;:[0,&quot;Subscribe&quot;],&quot;footer.compliance&quot;:[0,&quot;Compliance&quot;],&quot;footer.free_plans&quot;:[0,&quot;Free plans&quot;],&quot;footer.impact_ESG&quot;:[0,&quot;Impact/ESG&quot;],&quot;posts.follow_on_X&quot;:[0,&quot;Follow on X&quot;],&quot;footer.help_center&quot;:[0,&quot;Help center&quot;],&quot;footer.network_map&quot;:[0,&quot;Network Map&quot;],&quot;header.please_wait&quot;:[0,&quot;Please Wait&quot;],&quot;page.related_posts&quot;:[0,&quot;Related posts&quot;],&quot;search.result_stat&quot;:[0,&quot;Results &lt;strong&gt;{search_range}&lt;/strong&gt; of &lt;strong&gt;{search_total}&lt;/strong&gt; for &lt;strong&gt;{search_keyword}&lt;/strong&gt;&quot;],&quot;footer.case_studies&quot;:[0,&quot;Case Studies&quot;],&quot;footer.connect_2024&quot;:[0,&quot;Connect 2024&quot;],&quot;footer.terms_of_use&quot;:[0,&quot;Terms of Use&quot;],&quot;footer.white_papers&quot;:[0,&quot;White Papers&quot;],&quot;footer.cloudflare_tv&quot;:[0,&quot;Cloudflare TV&quot;],&quot;footer.community_hub&quot;:[0,&quot;Community Hub&quot;],&quot;footer.compare_plans&quot;:[0,&quot;Compare plans&quot;],&quot;footer.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.contact_sales&quot;:[0,&quot;Contact Sales&quot;],&quot;header.email_address&quot;:[0,&quot;Email Address&quot;],&quot;page.error.not_found&quot;:[0,&quot;Page not found&quot;],&quot;footer.developer_docs&quot;:[0,&quot;Developer docs&quot;],&quot;footer.privacy_policy&quot;:[0,&quot;Privacy Policy&quot;],&quot;footer.request_a_demo&quot;:[0,&quot;Request a demo&quot;],&quot;page.continue_reading&quot;:[0,&quot;Continue reading&quot;],&quot;footer.analysts_report&quot;:[0,&quot;Analyst reports&quot;],&quot;footer.for_enterprises&quot;:[0,&quot;For enterprises&quot;],&quot;footer.getting_started&quot;:[0,&quot;Getting Started&quot;],&quot;footer.learning_center&quot;:[0,&quot;Learning Center&quot;],&quot;footer.project_galileo&quot;:[0,&quot;Project Galileo&quot;],&quot;pagination.newer_posts&quot;:[0,&quot;Newer Posts&quot;],&quot;pagination.older_posts&quot;:[0,&quot;Older Posts&quot;],&quot;posts.social_buttons.x&quot;:[0,&quot;Discuss on X&quot;],&quot;search.icon_aria_label&quot;:[0,&quot;Search&quot;],&quot;search.source_location&quot;:[0,&quot;Source/Location&quot;],&quot;footer.about_cloudflare&quot;:[0,&quot;About Cloudflare&quot;],&quot;footer.athenian_project&quot;:[0,&quot;Athenian Project&quot;],&quot;footer.become_a_partner&quot;:[0,&quot;Become a partner&quot;],&quot;footer.cloudflare_radar&quot;:[0,&quot;Cloudflare Radar&quot;],&quot;footer.network_services&quot;:[0,&quot;Network services&quot;],&quot;footer.trust_and_safety&quot;:[0,&quot;Trust &amp; Safety&quot;],&quot;header.get_started_free&quot;:[0,&quot;Get Started Free&quot;],&quot;page.search.placeholder&quot;:[0,&quot;Search Cloudflare&quot;],&quot;footer.cloudflare_status&quot;:[0,&quot;Cloudflare Status&quot;],&quot;footer.cookie_preference&quot;:[0,&quot;Cookie Preferences&quot;],&quot;header.valid_email_error&quot;:[0,&quot;Must be valid email.&quot;],&quot;search.result_stat_empty&quot;:[0,&quot;Results &lt;strong&gt;{search_range}&lt;/strong&gt; of &lt;strong&gt;{search_total}&lt;/strong&gt;&quot;],&quot;footer.connectivity_cloud&quot;:[0,&quot;Connectivity cloud&quot;],&quot;footer.developer_services&quot;:[0,&quot;Developer services&quot;],&quot;footer.investor_relations&quot;:[0,&quot;Investor relations&quot;],&quot;page.not_found.error_code&quot;:[0,&quot;Error Code: 404&quot;],&quot;search.autocomplete_title&quot;:[0,&quot;Insert a query. Press enter to send&quot;],&quot;footer.logos_and_press_kit&quot;:[0,&quot;Logos &amp; press kit&quot;],&quot;footer.application_services&quot;:[0,&quot;Application services&quot;],&quot;footer.get_a_recommendation&quot;:[0,&quot;Get a recommendation&quot;],&quot;posts.social_buttons.reddit&quot;:[0,&quot;Discuss on Reddit&quot;],&quot;footer.sse_and_sase_services&quot;:[0,&quot;SSE and SASE services&quot;],&quot;page.not_found.outdated_link&quot;:[0,&quot;You may have used an outdated link, or you may have typed the address incorrectly.&quot;],&quot;footer.report_security_issues&quot;:[0,&quot;Report Security Issues&quot;],&quot;page.error.error_message_page&quot;:[0,&quot;Sorry, we can't find the page you are looking for.&quot;],&quot;header.subscribe_notifications&quot;:[0,&quot;Subscribe to receive notifications of new posts:&quot;],&quot;footer.cloudflare_for_campaigns&quot;:[0,&quot;Cloudflare for Campaigns&quot;],&quot;header.subscription_confimation&quot;:[0,&quot;Subscription confirmed. Thank you for subscribing!&quot;],&quot;posts.social_buttons.hackernews&quot;:[0,&quot;Discuss on Hacker News&quot;],&quot;footer.diversity_equity_inclusion&quot;:[0,&quot;Diversity, equity &amp; inclusion&quot;],&quot;footer.critical_infrastructure_defense_project&quot;:[0,&quot;Critical Infrastructure Defense Project&quot;]}],&quot;localesAvailable&quot;:[1,[]],&quot;footerBlurb&quot;:[0,&quot;Cloudflare's connectivity cloud protects &lt;a target='_blank' href='https://www.cloudflare.com/network-services/' rel='noreferrer'&gt;entire corporate networks&lt;/a&gt;, helps customers build &lt;a target='_blank' href='https://workers.cloudflare.com/' rel='noreferrer'&gt;Internet-scale applications efficiently&lt;/a&gt;, accelerates any &lt;a target='_blank' href='https://www.cloudflare.com/performance/accelerate-internet-applications/' rel='noreferrer'&gt;website or Internet application&lt;/a&gt;, &lt;a target='_blank' href='https://www.cloudflare.com/ddos/' rel='noreferrer'&gt;wards off DDoS attacks&lt;/a&gt;, keeps &lt;a target='_blank' href='https://www.cloudflare.com/application-security/' rel='noreferrer'&gt;hackers at bay&lt;/a&gt;, and can help you on &lt;a target='_blank' href='https://www.cloudflare.com/products/zero-trust/' rel='noreferrer'&gt;your journey to Zero Trust&lt;/a&gt;.&lt;br/&gt;&lt;br/&gt;Visit &lt;a target='_blank' href='https://one.one.one.one/' rel='noreferrer'&gt;1.1.1.1&lt;/a&gt; from any device to get started with our free app that makes your Internet faster and safer.&lt;br/&gt;&lt;br/&gt;To learn more about our mission to help build a better Internet, &lt;a target='_blank' href='https://www.cloudflare.com/learning/what-is-cloudflare/' rel='noreferrer'&gt;start here&lt;/a&gt;. If you&amp;apos;re looking for a new career direction, check out &lt;a target='_blank' href='http://www.cloudflare.com/careers' rel='noreferrer'&gt;our open positions&lt;/a&gt;.&quot;]}" client="load" opts="{&quot;name&quot;:&quot;Post&quot;,&quot;value&quot;:true}" await-children=""><main id="post" class="flex flex-row flex-wrap items-center justify-center pt2 pt4-l"><article class="post-full mw-100 ph3 ph0-l fs-20px"><h1 class="f6 f7-l fw4 gray1 pt1 pt3-l mb1">How to execute an object file: part 4, AArch64 edition</h1><p class="f3 fw5 gray5 db di-l mt2">2023-11-17</p><ul class="author-lists flex pl0 mt4"><li class="list flex items-center pr2 mb1-ns"><a href="https://blog.cloudflare.com/author/oxana/" class="static-avatar pr1"><img class="author-profile-image br-100 mr2" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/oxana.avif" alt="Oxana Kharitonova" width="62" height="62"></a><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/oxana/" class="fw4 f3 no-underline black mr3">Oxana Kharitonova</a></div></li></ul><section class="post-full-content"><div class="mb2 gray5">11 min read</div><div class="post-content lh-copy gray1">
            <figure class="kg-card kg-image-card ">
            
            <img src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/image1-1.webp" alt="How to execute an object file: part 4, AArch64 edition" class="kg-image" width="1999" height="1125" loading="lazy">
            
            </figure><p>Translating source code written in a high-level 
programming language into an executable binary typically involves a 
series of steps, namely compiling and assembling the code into object 
files, and then linking those object files into the final executable. 
However, there are certain scenarios where it can be useful to apply an 
alternate approach that involves executing object files directly, 
bypassing the linker. For example, we might use it for malware analysis 
or when part of the code requires an incompatible compiler. We’ll be 
focusing on the latter scenario: when one of our libraries needed to be 
compiled differently from the rest of the code. Learning how to execute 
an object file directly will give you a much better sense of how code is
 compiled and linked together.</p><p>To demonstrate how this was done, we have previously published a series of posts on executing an object file:</p><ul><li><p><a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-1/">How to execute an object file: Part 1</a></p></li><li><p><a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/">How to execute an object file: Part 2</a></p></li><li><p><a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-3/">How to execute an object file: Part 3</a></p></li></ul><p>The
 initial posts are dedicated to the x86 architecture. Since then the 
fleet of our working machines has expanded to include a large and 
growing number of ARM CPUs. This time we’ll repeat this exercise for the
 aarch64 architecture. You can pause here to read the previous blog 
posts before proceeding with this one, or read through the brief summary
 below and reference the earlier posts for more detail. We might 
reiterate some theory as working with ELF files can be daunting, if it’s
 not your day-to-day routine. Also, please be mindful that for 
simplicity, these examples omit bounds and integrity checks. Let the 
journey begin!</p>
          <div class="flex anchor relative">
            <h2 id="introduction">Introduction</h2>
            <a href="#introduction" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>In order to obtain an object file or an executable binary 
from a high-level compiled programming language the code needs to be 
processed by three components: compiler, assembler and linker. The 
compiler generates an assembly listing. This assembly listing is picked 
up by the assembler and translated into an object file. All source 
files, if a program contains multiple, go through these two steps 
generating an object file for each source file. At the final step the 
linker unites all object files into one binary, additionally resolving 
references to the shared libraries (i.e. we don’t implement the <code>printf</code>
 function each time, rather we take it from a system library). Even 
though the approach is platform independent, the compiler output varies 
by platform as the assembly listing is closely tied to the CPU 
architecture.</p><p>GCC (GNU Compiler Collection) can run each step: compiler, assembler and linker separately for us:</p><p>main.c:</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
</span>{
	<span class="hljs-built_in">puts</span>(<span class="hljs-string">"Hello, world!"</span>);
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</code></pre>
            <p>Compiler (output <code>main.s</code> - assembly listing):</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc -S main.c
$ <span class="hljs-built_in">ls</span>
main.c  main.s</code></pre>
            <p>Assembler (output <code>main.o</code> - an object file):</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc -c main.s -o main.o
$ <span class="hljs-built_in">ls</span>
main.c  main.o  main.s</code></pre>
            <p>Linker (<code>main</code> - an object file):</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc main.o -o main
$ <span class="hljs-built_in">ls</span>
main  main.c  main.o  main.s
$ ./main
Hello, world!</code></pre>
            <p>All the examples assume gcc is running on a native 
aarch64 architecture or include a cross compilation flag for those who 
want to reproduce and have no aarch64.</p><p>We have two object files in the output above: <code>main.o</code> and <code>main</code>. Object files are files encoded with the <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF (Executable and Linkable Format)</a> standard. Although, <code>main.o</code> is an ELF file, it doesn’t contain all the information to be fully executable.</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ file main.o
main.o: ELF 64-bit LSB relocatable, ARM aarch64, version 1 (SYSV), not stripped

$ file main
main: ELF 64-bit LSB pie executable, ARM aarch64, version 1 (SYSV), dynamically
linked, interpreter /lib/ld-linux-aarch64.so.1,
BuildID[sha1]=d3ecd2f8ac3b2dec11ed4cc424f15b3e1f130dd4, <span class="hljs-keyword">for</span> GNU/Linux 3.7.0, not stripped</code></pre>
            
          <div class="flex anchor relative">
            <h2 id="the-elf-file">The ELF File</h2>
            <a href="#the-elf-file" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>The central idea of this series of blog posts is to 
understand how to resolve dependencies from object files without 
directly involving the linker. For illustrative purposes we generated an
 object file based on some C-code and used it as a library for our main 
program. Before switching to the code, we need to understand the basics 
of the ELF structure.</p><p>Each ELF file is made up of one <i>ELF header</i>, followed by file data. The data can include: a <i>program header</i> table, a <i>section header</i> table, and the data which is referred to by the program or section header tables.</p>
          <div class="flex anchor relative">
            <h3 id="the-elf-header">The ELF Header</h3>
            <a href="#the-elf-header" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
        <p>The ELF header provides some basic information about the 
file: what architecture the file is compiled for, the program entry 
point and the references to other tables.</p><p>The ELF Header:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ readelf -h main
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF64
  Data:                              2<span class="hljs-string">'s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              DYN (Position-Independent Executable file)
  Machine:                           AArch64
  Version:                           0x1
  Entry point address:               0x640
  Start of program headers:          64 (bytes into file)
  Start of section headers:          68576 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         9
  Size of section headers:           64 (bytes)
  Number of section headers:         29
  Section header string table index: 28</span></code></pre>
            
          <div class="flex anchor relative">
            <h3 id="the-elf-program-header">The ELF Program Header</h3>
            <a href="#the-elf-program-header" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
        <p>The execution process of almost every program starts from an 
auxiliary program, called loader, which arranges the memory and calls 
the program’s entry point. In the following output the loader is marked 
with a line <code>“Requesting program interpreter: /lib/ld-linux-aarch64.so.1”</code>.
 The whole program memory is split into different segments with 
associated size, permissions and type (which instructs the loader on how
 to interpret this block of memory). Because the execution process 
should be performed in the shortest possible time, the <i>sections</i> with the same characteristics and located nearby are grouped into bigger blocks — <i>segments</i> — and placed in the <i>program header</i>. We can say that the <i>program header</i> summarizes the types of data that appear in the <i>section header</i>.</p><p>The ELF Program Header:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ readelf -Wl main

Elf file <span class="hljs-built_in">type</span> is DYN (Position-Independent Executable file)
Entry point 0x640
There are 9 program headers, starting at offset 64

Program Headers:
  Type           Offset   VirtAddr           PhysAddr           FileSiz  MemSiz   Flg Align
  PHDR           0x000040 0x0000000000000040 0x0000000000000040 0x0001f8 0x0001f8 R   0x8
  INTERP         0x000238 0x0000000000000238 0x0000000000000238 0x00001b 0x00001b R   0x1
      [Requesting program interpreter: /lib/ld-linux-aarch64.so.1]
  LOAD           0x000000 0x0000000000000000 0x0000000000000000 0x00088c 0x00088c R E 0x10000
  LOAD           0x00fdc8 0x000000000001fdc8 0x000000000001fdc8 0x000270 0x000278 RW  0x10000
  DYNAMIC        0x00fdd8 0x000000000001fdd8 0x000000000001fdd8 0x0001e0 0x0001e0 RW  0x8
  NOTE           0x000254 0x0000000000000254 0x0000000000000254 0x000044 0x000044 R   0x4
  GNU_EH_FRAME   0x0007a0 0x00000000000007a0 0x00000000000007a0 0x00003c 0x00003c R   0x4
  GNU_STACK      0x000000 0x0000000000000000 0x0000000000000000 0x000000 0x000000 RW  0x10
  GNU_RELRO      0x00fdc8 0x000000000001fdc8 0x000000000001fdc8 0x000238 0x000238 R   0x1

 Section to Segment mapping:
  Segment Sections...
   00     
   01     .interp 
   02     .interp .note.gnu.build-id .note.ABI-tag .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rela.dyn .rela.plt .init .plt .text .fini .rodata .eh_frame_hdr .eh_frame 
   03     .init_array .fini_array .dynamic .got .got.plt .data .bss 
   04     .dynamic 
   05     .note.gnu.build-id .note.ABI-tag 
   06     .eh_frame_hdr 
   07     
   08     .init_array .fini_array .dynamic .got </code></pre>
            
          <div class="flex anchor relative">
            <h3 id="the-elf-section-header">The ELF Section Header</h3>
            <a href="#the-elf-section-header" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
        <p>In the source code of high-level languages, variables, 
functions, and constants are mixed together. However, in assembly you 
might see that the data and instructions are separated into different 
blocks. The ELF file content is divided in an even more granular way. 
For example, variables with initial values are placed into different 
sections than the uninitialized ones. This approach optimizes for space,
 otherwise the values for uninitialized variables would be filled with 
zeros. Along with the space efficiency, there are security reasons for 
stratification — executable instructions can’t have writable 
permissions, while memory containing variables can't be executable. The 
section header describes each of these sections.</p><p>The ELF Section Header:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ readelf -SW main
There are 29 section headers, starting at offset 0x10be0:

Section Headers:
  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0
  [ 1] .interp           PROGBITS        0000000000000238 000238 00001b 00   A  0   0  1
  [ 2] .note.gnu.build-id NOTE            0000000000000254 000254 000024 00   A  0   0  4
  [ 3] .note.ABI-tag     NOTE            0000000000000278 000278 000020 00   A  0   0  4
  [ 4] .gnu.hash         GNU_HASH        0000000000000298 000298 00001c 00   A  5   0  8
  [ 5] .dynsym           DYNSYM          00000000000002b8 0002b8 0000f0 18   A  6   3  8
  [ 6] .dynstr           STRTAB          00000000000003a8 0003a8 000092 00   A  0   0  1
  [ 7] .gnu.version      VERSYM          000000000000043a 00043a 000014 02   A  5   0  2
  [ 8] .gnu.version_r    VERNEED         0000000000000450 000450 000030 00   A  6   1  8
  [ 9] .rela.dyn         RELA            0000000000000480 000480 0000c0 18   A  5   0  8
  [10] .rela.plt         RELA            0000000000000540 000540 000078 18  AI  5  22  8
  [11] .init             PROGBITS        00000000000005b8 0005b8 000018 00  AX  0   0  4
  [12] .plt              PROGBITS        00000000000005d0 0005d0 000070 00  AX  0   0 16
  [13] .text             PROGBITS        0000000000000640 000640 000134 00  AX  0   0 64
  [14] .fini             PROGBITS        0000000000000774 000774 000014 00  AX  0   0  4
  [15] .rodata           PROGBITS        0000000000000788 000788 000016 00   A  0   0  8
  [16] .eh_frame_hdr     PROGBITS        00000000000007a0 0007a0 00003c 00   A  0   0  4
  [17] .eh_frame         PROGBITS        00000000000007e0 0007e0 0000ac 00   A  0   0  8
  [18] .init_array       INIT_ARRAY      000000000001fdc8 00fdc8 000008 08  WA  0   0  8
  [19] .fini_array       FINI_ARRAY      000000000001fdd0 00fdd0 000008 08  WA  0   0  8
  [20] .dynamic          DYNAMIC         000000000001fdd8 00fdd8 0001e0 10  WA  6   0  8
  [21] .got              PROGBITS        000000000001ffb8 00ffb8 000030 08  WA  0   0  8
  [22] .got.plt          PROGBITS        000000000001ffe8 00ffe8 000040 08  WA  0   0  8
  [23] .data             PROGBITS        0000000000020028 010028 000010 00  WA  0   0  8
  [24] .bss              NOBITS          0000000000020038 010038 000008 00  WA  0   0  1
  [25] .comment          PROGBITS        0000000000000000 010038 00001f 01  MS  0   0  1
  [26] .symtab           SYMTAB          0000000000000000 010058 000858 18     27  66  8
  [27] .strtab           STRTAB          0000000000000000 0108b0 00022c 00      0   0  1
  [28] .shstrtab         STRTAB          0000000000000000 010adc 000103 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),
  L (<span class="hljs-built_in">link</span> order), O (extra OS processing required), G (group), T (TLS),
  C (compressed), x (unknown), o (OS specific), E (exclude),
  D (mbind), p (processor specific)</code></pre>
            
          <div class="flex anchor relative">
            <h2 id="executing-example-from-part-1-on-aarch64">Executing example from Part 1 on aarch64</h2>
            <a href="#executing-example-from-part-1-on-aarch64" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>Actually, our <a href="https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/1">initial code</a> from <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-1/">Part 1</a> works on aarch64 as is!</p><p>Let’s have a quick summary about what was done in the code:</p><ol><li><p>We need to find the code of two functions (<code>add5</code> and <code>add10</code>) in the <code>.text</code> section of our object file (<code>obj.o</code>)</p></li><li><p>Load the functions in the executable memory</p></li><li><p>Return the memory locations of the functions to the main program</p></li></ol><p>There
 is one nuance: even though all the sections are in the section header, 
neither of them have a string name. Without the names we can’t identify 
them. However, having an additional character field for each section in 
the ELF structure would be inefficient for the space — it must be 
limited by some maximum length and those names which are shorter would 
leave the space unfilled. Instead, ELF provides an additional section, <code>.shstrtab</code>.
 This string table concatenates all the names where each name ends with a
 null terminated byte. We can iterate over the names and match with an 
offset held by other sections to reference their name. But how do we 
find <code>.shstrtab</code> itself if we don’t have a name? To solve this chicken and egg problem, the ELF program header provides a direct pointer to <code>.shstrtab</code>. The similar approach is applied to two other sections: <code>.symtab</code> and <code>.strtab</code>. Where <code>.symtab</code> contains all information about the symbols and <code>.strtab</code> holds the list of symbol names. In the code we work with these tables to resolve all their dependencies and find our functions.</p>
          <div class="flex anchor relative">
            <h2 id="executing-example-from-part-2-on-aarch64">Executing example from Part 2 on aarch64</h2>
            <a href="#executing-example-from-part-2-on-aarch64" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>At the beginning of the second blog post on <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/">how to execute an object file</a> we made the function <code>add10</code> depend on <code>add5</code> instead of being self-contained. This is the first time when we faced relocations. <i>Relocations</i>
 is the process of loading symbols defined outside the current scope. 
The relocated symbols can present global or thread-local variables, 
constant, functions, etc. We’ll start from checking assembly 
instructions which trigger relocations and uncovering how the ELF format
 handles them in a more general way.</p><p>After making <code>add10</code> depend on <code>add5</code> our aarch64 version stopped working as well, similarly to the x86. Let’s take a look at assembly listing:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ objdump --disassemble --section=.text obj.o

obj.o:     file format elf64-littleaarch64


Disassembly of section .text:

0000000000000000 &lt;add5&gt;:
   0:	d10043ff 	sub	sp, sp, <span class="hljs-comment">#0x10</span>
   4:	b9000fe0 	str	w0, [sp, <span class="hljs-comment">#12]</span>
   8:	b9400fe0 	ldr	w0, [sp, <span class="hljs-comment">#12]</span>
   c:	11001400 	add	w0, w0, <span class="hljs-comment">#0x5</span>
  10:	910043ff 	add	sp, sp, <span class="hljs-comment">#0x10</span>
  14:	d65f03c0 	ret

0000000000000018 &lt;add10&gt;:
  18:	a9be7bfd 	stp	x29, x30, [sp, <span class="hljs-comment">#-32]!</span>
  1c:	910003fd 	mov	x29, sp
  20:	b9001fe0 	str	w0, [sp, <span class="hljs-comment">#28]</span>
  24:	b9401fe0 	ldr	w0, [sp, <span class="hljs-comment">#28]</span>
  28:	94000000 	bl	0 &lt;add5&gt;
  2c:	b9001fe0 	str	w0, [sp, <span class="hljs-comment">#28]</span>
  30:	b9401fe0 	ldr	w0, [sp, <span class="hljs-comment">#28]</span>
  34:	94000000 	bl	0 &lt;add5&gt;
  38:	a8c27bfd 	ldp	x29, x30, [sp], <span class="hljs-comment">#32</span>
  3c:	d65f03c0 	ret</code></pre>
            <p>Have you noticed that all the hex values in the second 
column are exactly the same length, in contrast with the instructions 
lengths seen for x86 in Part 2 of our series? This is because all 
Armv8-A instructions are presented in 32 bits. Since it is impossible to
 encode every immediate value into less than 32 bits, some operations 
require more than one instruction, as we’ll see later. For now, we’re 
interested in one instruction <code>- bl</code> (<a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BL--Branch-with-Link-?lang=en">branch with link</a>) on rows <code>28</code> and <code>34</code>. The <code>bl</code> is a “jump” instruction, but before the jump it preserves the next instruction after the current one in the link register (<code>lr</code>). When the callee finishes execution the caller address is recovered from <code>lr</code>.
 Usually, the aarch64 instructions reserve the last 6 bits [31:26] for 
opcode and some auxiliary fields such as running architecture (32 or 64 
bits), condition flag and others. Remaining bits are shared between 
arguments like source register, destination register and immediate 
value. Since the <code>bl</code> instruction does not require a source 
or destination register, the full 26 bits can be used to encode the 
immediate offset instead. However, 26 bits can only encode a small range
 (+/-32 MB), but because the jump can only target a beginning of an 
instruction, it must always be aligned to 4 bytes, which increases the 
effective range of the encoded immediate fourfold, to +/-128 MB.</p><p>Similarly to what we did in <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/">Part 2</a>
 we’re going to resolve our relocations - first by manually calculating 
the correct addresses and then by using an approach similar to what the 
linker does. The current value of our <code>bl</code> instruction is <code>94000000</code> or in binary representation <code>100101**00000000000000000000000000**</code>. All 26 bits are zeros, so we don't jump anywhere. The address is calculated by an offset from the current <i>program counter</i> (<code>pc</code>), which can be positive or negative. In our case we expect it to be <code>-0x28</code> and <code>-0x34</code>. As described above, it should be divided by 4 and taken as <a href="https://en.wikipedia.org/wiki/Two%27s_complement">two's complements</a>: <code>-0x28 / 4 = -0xA == 0xFFFFFFF6</code> and <code>-0x34 / 4 = -0xD == 0xFFFFFFF3</code>.
 From these values we need to take the lower 26 bits and concatenate 
them with the initial 6 bits to get the final instruction. So, the final
 ones will be: <code>100101**11111111111111111111110110** == 0x97FFFFF6</code> and <code>100101**11111111111111111111110011** == 0x97FFFFF3</code>. Have you noticed that all the distance calculations are done relative to the <code>bl</code> (or current <code>pc</code>), not the next instruction as in x86?</p><p>Let’s add to the code and execute:</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes">... 

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">parse_obj</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
</span>{
	...
	<span class="hljs-comment">/* copy the contents of `.text` section from the ELF file */</span>
	<span class="hljs-built_in">memcpy</span>(text_runtime_base, obj.base + text_hdr-&gt;sh_offset, text_hdr-&gt;sh_size);

	*((<span class="hljs-type">uint32_t</span> *)(text_runtime_base + <span class="hljs-number">0x28</span>)) = <span class="hljs-number">0x97FFFFF6</span>;
	*((<span class="hljs-type">uint32_t</span> *)(text_runtime_base + <span class="hljs-number">0x34</span>)) = <span class="hljs-number">0x97FFFFF3</span>;

	<span class="hljs-comment">/* make the `.text` copy readonly and executable */</span>
	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">mprotect</span>(text_runtime_base, <span class="hljs-built_in">page_align</span>(text_hdr-&gt;sh_size), PROT_READ | PROT_EXEC)) {
	...</code></pre>
            <p>Compile and run:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc -o loader loader.c
$ ./loader
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52</code></pre>
            <p>It works! But this is not how the linker handles the 
relocations. The linker resolves relocation based on the type and 
formula assigned to this type. In our <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-2/">Part 2</a> we investigated it quite well. Here again we need to find the type and check the formula for this type:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ readelf --relocs obj.o

Relocation section <span class="hljs-string">'.rela.text'</span> at offset 0x228 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
000000000028  000a0000011b R_AARCH64_CALL26  0000000000000000 add5 + 0
000000000034  000a0000011b R_AARCH64_CALL26  0000000000000000 add5 + 0

Relocation section <span class="hljs-string">'.rela.eh_frame'</span> at offset 0x258 contains 2 entries:
  Offset          Info           Type           Sym. Value    Sym. Name + Addend
00000000001c  000200000105 R_AARCH64_PREL32  0000000000000000 .text + 0
000000000034  000200000105 R_AARCH64_PREL32  0000000000000000 .text + 18</code></pre>
            <p>Our Type is R_AARCH64_CALL26 and the <a href="https://github.com/ARM-software/abi-aa/blob/main/aaelf64/aaelf64.rst#5733relocation-operations">formula</a> for it is:</p><!--kg-card-begin: html--><table cellspacing="0" style="border-collapse:collapse; border:none; width:100%">
	<tbody>
		<tr>
			<td style="vertical-align:top; width:98px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000"><b>ELF64 Code</b></span></span></span></p>
			</td>
			<td style="vertical-align:top; width:179px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000"><b>Name</b></span></span></span></p>
			</td>
			<td style="vertical-align:top; width:145px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000"><b>Operation</b></span></span></span></p>
			</td>
		</tr>
		<tr>
			<td style="vertical-align:top; width:98px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000">283</span></span></span></p>
			</td>
			<td style="vertical-align:top; width:179px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000">R_&lt;CLS&gt;_CALL26</span></span></span></p>
			</td>
			<td style="vertical-align:top; width:145px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000">S + A - P</span></span></span></p>
			</td>
		</tr>
	</tbody>
</table><!--kg-card-end: html--><p>where:</p><ul><li><p><code>S</code> (when used on its own) is the address of the symbol</p></li><li><p><code>A</code> is the addend for the relocation</p></li><li><p><code>P</code> is the address of the place being relocated (derived from <code>r_offset</code>)</p></li></ul><p>Here are the relevant changes to loader.c:</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes"><span class="hljs-comment">/* Replace `#define R_X86_64_PLT32 4` with our Type */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> R_AARCH64_CALL26 283</span>
...

<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">do_text_relocations</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
</span>{
	...
	<span class="hljs-type">uint32_t</span> val;

	<span class="hljs-keyword">switch</span> (type)
	{
	<span class="hljs-keyword">case</span> R_AARCH64_CALL26:
		<span class="hljs-comment">/* The mask separates opcode (6 bits) and the immediate value */</span>
		<span class="hljs-type">uint32_t</span> mask_bl = (<span class="hljs-number">0xffffffff</span> &lt;&lt; <span class="hljs-number">26</span>);
		<span class="hljs-comment">/* S+A-P, divided by 4 */</span>
		val = (symbol_address + relocations[i].r_addend - patch_offset) &gt;&gt; <span class="hljs-number">2</span>;
		<span class="hljs-comment">/* Concatenate opcode and value to get final instruction */</span>
		*((<span class="hljs-type">uint32_t</span> *)patch_offset) &amp;= mask_bl;
		val &amp;= ~mask_bl;
		*((<span class="hljs-type">uint32_t</span> *)patch_offset) |= val;
		<span class="hljs-keyword">break</span>;
	}
	...
}</code></pre>
            <p>Compile and run:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc -o loader loader.c 
$ ./loader
Calculated relocation: 0x97fffff6
Calculated relocation: 0x97fffff3
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52</code></pre>
            <p>So far so good. The next challenge is to <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/2/obj.c#L16-L31">add constant data and global variables</a> to our object file and check relocations again:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ readelf --relocs --wide obj.o

Relocation section <span class="hljs-string">'.rela.text'</span> at offset 0x388 contains 8 entries:
    Offset             Info             Type               Symbol<span class="hljs-string">'s Value  Symbol'</span>s Name + Addend
0000000000000000  0000000500000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .rodata + 0
0000000000000004  0000000500000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .rodata + 0
000000000000000c  0000000300000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .data + 0
0000000000000010  0000000300000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .data + 0
0000000000000024  0000000300000113 R_AARCH64_ADR_PREL_PG_HI21 0000000000000000 .data + 0
0000000000000028  0000000300000115 R_AARCH64_ADD_ABS_LO12_NC 0000000000000000 .data + 0
0000000000000068  000000110000011b R_AARCH64_CALL26       0000000000000040 add5 + 0
0000000000000074  000000110000011b R_AARCH64_CALL26       0000000000000040 add5 + 0
...</code></pre>
            <p>We have even two new relocations: <code>R_AARCH64_ADD_ABS_LO12_NC</code> and <code>R_AARCH64_ADR_PREL_PG_HI21</code>. Their formulas are:</p><!--kg-card-begin: html--><table cellspacing="0" style="border-collapse:collapse; border:none; width:100%">
	<tbody>
		<tr>
			<td style="vertical-align:top; width:98px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000"><b>ELF64 Code</b></span></span></span></p>
			</td>
			<td style="vertical-align:top; width:237px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000"><b>Name</b></span></span></span></p>
			</td>
			<td style="vertical-align:top; width:221px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000"><b>Operation</b></span></span></span></p>
			</td>
		</tr>
		<tr>
			<td style="vertical-align:top; width:98px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#1f2328"><span style="background-color:#ffffff">275</span></span></span></span></p>
			</td>
			<td style="vertical-align:top; width:237px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#1f2328"><span style="background-color:#ffffff">R_&lt;CLS&gt;_ ADR_PREL_PG_HI21</span></span></span></span></p>
			</td>
			<td style="vertical-align:top; width:221px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#1f2328"><span style="background-color:#ffffff">Page(S+A) - Page(P)</span></span></span></span></p>
			</td>
		</tr>
		<tr>
			<td style="vertical-align:top; width:98px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#1f2328">277</span></span></span></p>
			</td>
			<td style="vertical-align:top; width:237px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000">R_&lt;CLS&gt;_ ADD_ABS_LO12_NC</span></span></span></p>
			</td>
			<td style="vertical-align:top; width:221px">
			<p><span style="font-size:9pt"><span style="font-family:'Courier New',monospace"><span style="color:#000000">S + A</span></span></span></p>
			</td>
		</tr>
	</tbody>
</table><!--kg-card-end: html--><p>where:</p><p><code>Page(expr)</code> is the page address of the expression expr, defined as <code>(expr &amp; ~0xFFF)</code>. (This applies even if the machine page size supported by the platform has a different value.)</p><p>It’s a bit unclear why we have two new types, while in x86 we had only one. Let’s investigate the assembly code:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ objdump --disassemble --section=.text obj.o

obj.o:     file format elf64-littleaarch64


Disassembly of section .text:

0000000000000000 &lt;get_hello&gt;:
   0:	90000000 	adrp	x0, 0 &lt;get_hello&gt;
   4:	91000000 	add	x0, x0, <span class="hljs-comment">#0x0</span>
   8:	d65f03c0 	ret

000000000000000c &lt;get_var&gt;:
   c:	90000000 	adrp	x0, 0 &lt;get_hello&gt;
  10:	91000000 	add	x0, x0, <span class="hljs-comment">#0x0</span>
  14:	b9400000 	ldr	w0, [x0]
  18:	d65f03c0 	ret

000000000000001c &lt;set_var&gt;:
  1c:	d10043ff 	sub	sp, sp, <span class="hljs-comment">#0x10</span>
  20:	b9000fe0 	str	w0, [sp, <span class="hljs-comment">#12]</span>
  24:	90000000 	adrp	x0, 0 &lt;get_hello&gt;
  28:	91000000 	add	x0, x0, <span class="hljs-comment">#0x0</span>
  2c:	b9400fe1 	ldr	w1, [sp, <span class="hljs-comment">#12]</span>
  30:	b9000001 	str	w1, [x0]
  34:	d503201f 	nop
  38:	910043ff 	add	sp, sp, <span class="hljs-comment">#0x10</span>
  3c:	d65f03c0 	ret</code></pre>
            <p>We see that all <code>adrp</code> instructions are followed by <code>add</code> instructions. The <code>[add](https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADD--immediate---Add--immediate--?lang=en)</code>
 instruction adds an immediate value to the source register and writes 
the result to the destination register. The source and destination 
registers can be the same, the immediate value is 12 bits. The <code>[adrp](https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADRP--Form-PC-relative-address-to-4KB-page-?lang=en)</code> instruction generates a <code>pc</code>-relative (program counter) address and writes the result to the destination register. It takes <code>pc</code>
 of the instruction itself and adds a 21-bit immediate value shifted 
left by 12 bits. If the immediate value weren’t shifted it would lie in a
 range of +/-1 MB memory, which isn’t enough. The left shift increases 
the range up to +/-1 GB. However, because the 12 bits are masked out 
with the shift, we need to store them somewhere and restore later. 
That’s why we see add instruction following <code>adrp</code> and two types instead of one. Also, it’s a bit tricky to encode <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/ADRP--Form-PC-relative-address-to-4KB-page-?lang=en"><code>adrp</code></a>:
 2 low bits of immediate value are placed in the position 30:29 and the 
rest in the position 23:5. Due to size limitations, the aarch64 
instructions try to make the most out of 32 bits.</p><p>In the code we are going to use the formulas to calculate the values and description of <code>adrp</code> and <code>add</code> instructions to obtain the final opcode:</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes"><span class="hljs-meta">#<span class="hljs-keyword">define</span> R_AARCH64_CALL26 283</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> R_AARCH64_ADD_ABS_LO12_NC 277</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> R_AARCH64_ADR_PREL_PG_HI21 275</span>
...

{
<span class="hljs-keyword">case</span> R_AARCH64_CALL26:
	<span class="hljs-comment">/* The mask separates opcode (6 bits) and the immediate value */</span>
	<span class="hljs-type">uint32_t</span> mask_bl = (<span class="hljs-number">0xffffffff</span> &lt;&lt; <span class="hljs-number">26</span>);
	<span class="hljs-comment">/* S+A-P, divided by 4 */</span>
	val = (symbol_address + relocations[i].r_addend - patch_offset) &gt;&gt; <span class="hljs-number">2</span>;
	<span class="hljs-comment">/* Concatenate opcode and value to get final instruction */</span>
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) &amp;= mask_bl;
	val &amp;= ~mask_bl;
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) |= val;
	<span class="hljs-keyword">break</span>;
<span class="hljs-keyword">case</span> R_AARCH64_ADD_ABS_LO12_NC:
	<span class="hljs-comment">/* The mask of `add` instruction to separate 
	* opcode, registers and calculated value 
	*/</span>
	<span class="hljs-type">uint32_t</span> mask_add = <span class="hljs-number">0b11111111110000000000001111111111</span>;
	<span class="hljs-comment">/* S + A */</span>
	<span class="hljs-type">uint32_t</span> val = *(symbol_address + relocations[i].r_addend);
	val &amp;= ~mask_add;
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) &amp;= mask_add;
	<span class="hljs-comment">/* Final instruction */</span>
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) |= val;
<span class="hljs-keyword">case</span> R_AARCH64_ADR_PREL_PG_HI21:
	<span class="hljs-comment">/* Page(S+A)-Page(P), Page(expr) is defined as (expr &amp; ~0xFFF) */</span>
	val = (((<span class="hljs-type">uint64_t</span>)(symbol_address + relocations[i].r_addend)) &amp; ~<span class="hljs-number">0xFFF</span>) - (((<span class="hljs-type">uint64_t</span>)patch_offset) &amp; ~<span class="hljs-number">0xFFF</span>);
	<span class="hljs-comment">/* Shift right the calculated value by 12 bits.
	 * During decoding it will be shifted left as described above, 
	 * so we do the opposite.
	*/</span>
	val &gt;&gt;= <span class="hljs-number">12</span>;
	<span class="hljs-comment">/* Separate the lower and upper bits to place them in different positions */</span> 
	<span class="hljs-type">uint32_t</span> immlo = (val &amp; (<span class="hljs-number">0xf</span> &gt;&gt; <span class="hljs-number">2</span>)) &lt;&lt; <span class="hljs-number">29</span> ;
	<span class="hljs-type">uint32_t</span> immhi = (val &amp; ((<span class="hljs-number">0xffffff</span> &gt;&gt; <span class="hljs-number">13</span>) &lt;&lt; <span class="hljs-number">2</span>)) &lt;&lt; <span class="hljs-number">22</span>;
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) |= immlo;
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) |= immhi;
	<span class="hljs-keyword">break</span>;
}</code></pre>
            <p>Compile and run:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc -o loader loader.c 
$ ./loader
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52
Executing get_hello...
get_hello() = Hello, world!
Executing get_var...
get_var() = 5
Executing set_var(42)...
Executing get_var again...
get_var() = 42</code></pre>
            <p>It works! The final code is <a href="https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/4/2">here</a>.</p>
          <div class="flex anchor relative">
            <h2 id="executing-example-from-part-3-on-aarch64">Executing example from Part 3 on aarch64</h2>
            <a href="#executing-example-from-part-3-on-aarch64" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>Our <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-3/">Part 3</a>
 is about resolving external dependencies. When we write code we don’t 
think much about how to allocate memory or print debug information to 
the console. Instead, we involve functions from the system libraries. 
But the code of system libraries needs to be passed through to our 
programs somehow. Additionally, for optimization purposes, it would be 
nice if this code would be stored in one place and shared between all 
programs. And another wish — we don’t want to resolve all the functions 
and global variables from the libraries, only those which we need and at
 those times when we need them. To solve these problems, ELF introduced 
two sections: PLT (the procedure linkage table) and GOT (the global 
offset table). The dynamic loader creates a list which contains all 
external functions and variables from the shared library, but doesn’t 
resolve them immediately; instead they are placed in the PLT section. 
Each external symbol is presented by a small function, a stub, e.g. <code>puts@plt</code>.
 When an external symbol is requested, the stub checks if it was 
resolved previously. If not, the stub searches for an absolute address 
of the symbol, returns to the requester and writes it in the GOT table. 
The next time, the address returns directly from the GOT table.</p><p>In <a href="https://blog.cloudflare.com/how-to-execute-an-object-file-part-3/">Part 3</a> we implemented a simplified PLT/GOT resolution. Firstly, we added a new function <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/obj.c#L35"><code>say_hello</code></a> in the <code>obj.c</code>, which calls unresolved system library function <code>puts</code>. Further we added an optional wrapper <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L73"><code>my_puts</code></a> in the <code>loader.c</code>.
 The wrapper isn’t required, we could’ve resolved directly to a standard
 function, but it's a good example of how the implementation of some 
functions can be overwritten with custom code. In the next steps we 
added our PLT/GOT resolution:</p><ul><li><p>PLT section we replaced with a <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L340">jumptable</a></p></li><li><p>GOT we replaced with <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238-L248">assembly instructions</a></p></li></ul><p>Basically, we created a small stub with assembly code (our <code>jumptable</code>) to resolve the global address of our <code>my_puts</code> wrapper and jump to it.</p><p>The approach for aarch64 is the same. But the <code>jumptable</code> is very different as it consists of different assembly instructions.</p><p>The
 big difference here compared to the other parts is that we need to work
 with a 64-bit address for the GOT resolution. Our custom PLT or <code>jumptable</code> is placed close to the main code of <code>obj.c</code> and can operate with the relative addresses as before. For the GOT or referencing <code>my_puts</code> wrapper we’ll use different branch instructions — <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BR--Branch-to-Register-"><code>br</code></a> or <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/BLR--Branch-with-Link-to-Register-"><code>blr</code></a>. These instructions branch to the register, where the aarch64 registers can hold 64-bit values.</p><p>We can check how it resolves with the native PLT/GOT in our loader assembly code:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ objdump --disassemble --section=.text loader
...
1d2c:	97fffb45 	bl	a40 &lt;puts@plt&gt;
1d30:	f94017e0 	ldr	x0, [sp, <span class="hljs-comment">#40]</span>
1d34:	d63f0000 	blr	x0
...</code></pre>
            <p>The first instruction is <code>bl</code> jump to <code>puts@plt</code> stub. The next <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/LDR--immediate---Load-Register--immediate--"><code>ldr</code></a> instruction tells us that some value was loaded into the register <code>x0</code> from the stack. Each function has its own <a href="https://en.wikipedia.org/wiki/Call_stack#Stack_and_frame_pointers">stack frame</a> to hold the local variables. The last <code>blr</code> instruction makes a jump to the address stored in <code>x0</code> register. There is an agreement in the register naming: if the stored value is 64-bits then the register is called <code>x0-x30</code>; if only 32-bits are used then it’s called <code>w0-w30</code> (the value will be stored in the lower 32-bits and upper 32-bits will be zeroed).</p><p>We need to do something similar — place the absolute address of our <code>my_puts</code> wrapper in some register and call <code>br</code> on this register. We don’t need to store the link before branching, the call will be returned to <code>say_hello</code> from <code>obj.c</code>, which is why a plain <code>br</code> will be enough. Let’s check an assembly of simple C-function:</p><p>hello.c:</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">say_hello</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
</span>{
    <span class="hljs-type">uint64_t</span> reg = <span class="hljs-number">0x555555550c14</span>;
}</code></pre>
            
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc -c hello.c
$ objdump --disassemble --section=.text hello.o

hello.o:     file format elf64-littleaarch64


Disassembly of section .text:

0000000000000000 &lt;say_hello&gt;:
   0:	d10043ff 	sub	sp, sp, <span class="hljs-comment">#0x10</span>
   4:	d2818280 	mov	x0, <span class="hljs-comment">#0xc14                 	// #3092</span>
   8:	f2aaaaa0 	movk	x0, <span class="hljs-comment">#0x5555, lsl #16</span>
   c:	f2caaaa0 	movk	x0, <span class="hljs-comment">#0x5555, lsl #32</span>
  10:	f90007e0 	str	x0, [sp, <span class="hljs-comment">#8]</span>
  14:	d503201f 	nop
  18:	910043ff 	add	sp, sp, <span class="hljs-comment">#0x10</span>
  1c:	d65f03c0 	ret</code></pre>
            <p>The number <code>0x555555550c14</code> is the address returned by <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238"><code>lookup_ext_function</code></a>. We’ve printed it out to use as an example, but any <a href="https://www.kernel.org/doc/html/latest/arch/arm64/memory.html">48-bits</a> hex value can be used.</p><p>In our output we see that the value was split in three sections and written in <code>x0</code> register with three instructions: one <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOV--inverted-wide-immediate---Move--inverted-wide-immediate---an-alias-of-MOVN-"><code>mov</code></a> and two <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOVK--Move-wide-with-keep-?lang=en"><code>movk</code></a>.
 The documentation says that there are only 16 bits for the immediate 
value, but a shift can be applied (in our case left shift <code>lsl</code>).</p><p>However, we can’t use <code>x0</code> in our context. By <a href="https://developer.arm.com/documentation/den0024/a/The-ABI-for-ARM-64-bit-Architecture/Register-use-in-the-AArch64-Procedure-Call-Standard/Parameters-in-general-purpose-registers">convention</a> the registers <code>x0-x7</code> are caller-saved and used to pass function parameters between calls to other functions. Let’s use <code>x9</code> then.</p><p>We need to modify our loader. Firstly let’s change the jumptable structure.</p><p>loader.c:</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes">...
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ext_jump</span> {
	<span class="hljs-type">uint32_t</span> instr[<span class="hljs-number">4</span>];
};
...</code></pre>
            <p>As we saw above, we need four instructions: <code>mov</code>, <code>movk</code>, <code>movk</code>, <code>br</code>.
 We don’t need a stack frame as we aren’t preserving any local 
variables. We just want to load the address into the register and branch
 to it. But we can’t write human-readable code</p><p>e.g. <code>mov &nbsp;x0, #0xc14</code> into instructions, we need machine binary or hex representation, e.g. <code>d2818280</code>.</p><p>Let’s write a simple assembly code to get it:</p><p>hw.s:</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes">.global _start

_start: mov     x9, #<span class="hljs-number">0xc14</span> 
        movk    x9, #<span class="hljs-number">0x5555</span>, lsl #<span class="hljs-number">16</span>
        movk    x9, #<span class="hljs-number">0x5555</span>, lsl #<span class="hljs-number">32</span>
        br      x9</code></pre>
            
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ as -o hw.o hw.s
$ objdump --disassemble --section=.text hw.o

hw.o:     file format elf64-littleaarch64


Disassembly of section .text:

0000000000000000 &lt;_start&gt;:
   0:	d2818289 	mov	x9, <span class="hljs-comment">#0xc14                 	// #3092</span>
   4:	f2aaaaa9 	movk	x9, <span class="hljs-comment">#0x5555, lsl #16</span>
   8:	f2caaaa9 	movk	x9, <span class="hljs-comment">#0x5555, lsl #32</span>
   c:	d61f0120 	br	x9</code></pre>
            <p>Almost done! But there’s one more thing to consider. Even if the value <code>0x555555550c14</code> is a real <code>my_puts</code> wrapper address, it will be different on each run if <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR(Address space layout randomization)</a> is enabled. We need to patch these instructions to put the value which will be returned by <a href="https://github.com/cloudflare/cloudflare-blog/blob/master/2021-03-obj-file/3/loader.c#L238"><code>lookup_ext_function</code></a> on each run. We’ll split the obtained value in three parts, 16-bits each, and replace them in our <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOV--inverted-wide-immediate---Move--inverted-wide-immediate---an-alias-of-MOVN-"><code>mov</code></a> and <a href="https://developer.arm.com/documentation/ddi0596/2021-12/Base-Instructions/MOVK--Move-wide-with-keep-?lang=en"><code>movk</code></a> instructions according to the documentation, similar to what we did before for our second part.</p>
            <pre class="language-cpp"><code class="language-cpp hljs" data-highlighted="yes"><span class="hljs-keyword">if</span> (symbols[symbol_idx].st_shndx == SHN_UNDEF) {
	<span class="hljs-type">static</span> <span class="hljs-type">int</span> curr_jmp_idx = <span class="hljs-number">0</span>;

	<span class="hljs-type">uint64_t</span> addr = <span class="hljs-built_in">lookup_ext_function</span>(strtab +  symbols[symbol_idx].st_name);
	<span class="hljs-type">uint32_t</span> mov = <span class="hljs-number">0b11010010100000000000000000001001</span> | ((addr &lt;&lt; <span class="hljs-number">48</span>) &gt;&gt; <span class="hljs-number">43</span>);
	<span class="hljs-type">uint32_t</span> movk1 = <span class="hljs-number">0b11110010101000000000000000001001</span> | (((addr &gt;&gt; <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">48</span>) &gt;&gt; <span class="hljs-number">43</span>);
	<span class="hljs-type">uint32_t</span> movk2 = <span class="hljs-number">0b11110010110000000000000000001001</span> | (((addr &gt;&gt; <span class="hljs-number">32</span>) &lt;&lt; <span class="hljs-number">48</span>) &gt;&gt; <span class="hljs-number">43</span>);
	jumptable[curr_jmp_idx].instr[<span class="hljs-number">0</span>] = mov;         <span class="hljs-comment">// mov  x9, #0x0c14</span>
	jumptable[curr_jmp_idx].instr[<span class="hljs-number">1</span>] = movk1;       <span class="hljs-comment">// movk x9, #0x5555, lsl #16</span>
	jumptable[curr_jmp_idx].instr[<span class="hljs-number">2</span>] = movk2;       <span class="hljs-comment">// movk x9, #0x5555, lsl #32</span>
	jumptable[curr_jmp_idx].instr[<span class="hljs-number">3</span>] = <span class="hljs-number">0xd61f0120</span>;  <span class="hljs-comment">// br   x9</span>

	symbol_address = (<span class="hljs-type">uint8_t</span> *)(&amp;jumptable[curr_jmp_idx].instr[<span class="hljs-number">0</span>]);
	curr_jmp_idx++;
} <span class="hljs-keyword">else</span> {
	symbol_address = <span class="hljs-built_in">section_runtime_base</span>(&amp;sections[symbols[symbol_idx].st_shndx]) + symbols[symbol_idx].st_value;
}
<span class="hljs-type">uint32_t</span> val;
<span class="hljs-keyword">switch</span> (type)
{
<span class="hljs-keyword">case</span> R_AARCH64_CALL26:
	<span class="hljs-comment">/* The mask separates opcode (6 bits) and the immediate value */</span>
	<span class="hljs-type">uint32_t</span> mask_bl = (<span class="hljs-number">0xffffffff</span> &lt;&lt; <span class="hljs-number">26</span>);
	<span class="hljs-comment">/* S+A-P, divided by 4 */</span>
	val = (symbol_address + relocations[i].r_addend - patch_offset) &gt;&gt; <span class="hljs-number">2</span>;
	<span class="hljs-comment">/* Concatenate opcode and value to get final instruction */</span>
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) &amp;= mask_bl;
	val &amp;= ~mask_bl;
	*((<span class="hljs-type">uint32_t</span> *)patch_offset) |= val;
	<span class="hljs-keyword">break</span>;
...</code></pre>
            <p>In the code we took the address of the first instruction <code>&amp;jumptable[curr_jmp_idx].instr[0]</code> and wrote it in the <code>symbol_address</code>, further because the <code>type</code> is still <code>R_AARCH64_CALL26</code> it will be put into <code>bl</code> - jump to the relative address. Where our relative address is the first <code>mov</code> instruction. The whole <code>jumptable</code> code will be executed and finished with the <code>blr</code> instruction.</p><p>The final run:</p>
            <pre class="language-bash"><code class="language-bash hljs" data-highlighted="yes">$ gcc -o loader loader.c
$ ./loader
Executing add5...
add5(42) = 47
Executing add10...
add10(42) = 52
Executing get_hello...
get_hello() = Hello, world!
Executing get_var...
get_var() = 5
Executing set_var(42)...
Executing get_var again...
get_var() = 42
Executing say_hello...
my_puts executed
Hello, world!</code></pre>
            <p>The final code is <a href="https://github.com/cloudflare/cloudflare-blog/tree/master/2021-03-obj-file/4/3">here</a>.</p>
          <div class="flex anchor relative">
            <h2 id="summary">Summary</h2>
            <a href="#summary" aria-hidden="true" class="relative sm:absolute sm:-left-5">
              <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentcolor" d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"></path></svg>
            </a>
          </div>
          <p>There are several things we covered in this blog post. We 
gave a brief introduction on how the binary got executed on Linux and 
how all components are linked together. We saw a big difference between 
x86 and aarch64 assembly. We learned how we can hook into the code and 
change its behavior. But just as it was said in the first blog post of 
this series, the most important thing is to remember to always think 
about security first. Processing external inputs should always be done 
with great care. Bounds and integrity checks have been omitted for the 
purposes of keeping the examples short, so readers should be aware that 
the code is not production ready and is designed for educational 
purposes only.</p></div></section><section class="post-full-content flex flex-row flex-wrap mw7 center mb4"><div class="post-content lh-copy w-100 gray1 bt b--gray8 pt4">Cloudflare's connectivity cloud protects <a target="_blank" href="https://www.cloudflare.com/network-services/" rel="noreferrer">entire corporate networks</a>, helps customers build <a target="_blank" href="https://workers.cloudflare.com/" rel="noreferrer">Internet-scale applications efficiently</a>, accelerates any <a target="_blank" href="https://www.cloudflare.com/performance/accelerate-internet-applications/" rel="noreferrer">website or Internet application</a>, <a target="_blank" href="https://www.cloudflare.com/ddos/" rel="noreferrer">wards off DDoS attacks</a>, keeps <a target="_blank" href="https://www.cloudflare.com/application-security/" rel="noreferrer">hackers at bay</a>, and can help you on <a target="_blank" href="https://www.cloudflare.com/products/zero-trust/" rel="noreferrer">your journey to Zero Trust</a>.<br><br>Visit <a target="_blank" href="https://one.one.one.one/" rel="noreferrer">1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.<br><br>To learn more about our mission to help build a better Internet, <a target="_blank" href="https://www.cloudflare.com/learning/what-is-cloudflare/" rel="noreferrer">start here</a>. If you're looking for a new career direction, check out <a target="_blank" href="http://www.cloudflare.com/careers" rel="noreferrer">our open positions</a>.</div></section><div class="pv2 ph0-l mw7 center" id="social-buttons"><div class="mt5-l mt2 mb4 f2 flex flex-row-ns flex-column flex-wrap"><a id="social-button-hn" title="Discuss on Hacker News" href="https://news.ycombinator.com/item?id=38303607" target="_blank" rel="noreferrer" class="mr2-ns mb0-l white link b pv3 ph3 mb3 " style="background-color: rgb(0, 85, 220);"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 512 512" class="mr2"><g><path d="M31,31v450h450V31H31z M270.1,287.6v94.9h-28.1v-94.9L165,143.5h31.9L256,254.3l59.1-110.8H347
C347,143.5,270.1,287.6,270.1,287.6z"></path></g></svg><span class="v-mid">Discuss on Hacker News</span></a></div></div><iframe sandbox="allow-scripts allow-popups allow-popups-to-escape-sandbox" title="cloudflare-tv-live-link" id="cloudflare-tv-embed" src="https://cloudflare.tv/embed/live.html" loading="lazy"></iframe><a href="https://blog.cloudflare.com/tag/linux/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">Linux</a><a href="https://blog.cloudflare.com/tag/programming/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">Programming</a><a href="https://blog.cloudflare.com/tag/deep-dive/" class="dib pl2 pr2 pt1 pb1 mb2 bg-gray8 no-underline blue3 f2 mr1">Deep Dive</a></article></main><div class="ph3 pv3"><div class=" flex flex-row flex-wrap mw7 center"><div class="w-100 bt b--gray8"><p class="black fw5 f4 mt4">Follow on X</p></div><div class="w-100 pb2"><span>Cloudflare</span><span class="ph2">|</span><a href="https://x.com/@cloudflare" class="no-underline">@cloudflare</a></div></div></div><div data-testid="related-posts-section" class="pv4 ph3 ph0-l flex flex-row flex-wrap mw7 center"><div class="w-100 bt b--gray8"><p class="orange fw5 f4 mt4 ttu">Related posts</p></div><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2025-02-14T14:00+00:00">February 14, 2025  3:00 PM</p><a data-testid="related-posts-article-title" href="https://blog.cloudflare.com/searching-for-the-cause-of-hung-tasks-in-the-linux-kernel/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">Searching for the cause of hung tasks in the Linux kernel</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">The
 Linux kernel can produce a hung task warning. Searching the Internet 
and the kernel docs, you can find a brief explanation that the process 
is stuck in the uninterruptible state....</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By&nbsp;</span><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/oxana/" class="fw5 f2 black no-underline">Oxana Kharitonova</a><span class="fw5 f2 black no-underline">,&nbsp;</span></div></li><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/jesper-brouer/" class="fw5 f2 black no-underline">Jesper Brouer</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="https://blog.cloudflare.com/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/kernel/" class="no-underline f1 fw2 blue3 underline-hover">Kernel,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/monitoring/" class="no-underline f1 fw2 blue3 underline-hover">Monitoring</a>&nbsp;</span></div></article><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2025-01-27T14:00+00:00">January 27, 2025  3:00 PM</p><a data-testid="related-posts-article-title" href="https://blog.cloudflare.com/how-we-make-sense-of-too-much-data/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">Over 700 million events/second: How we make sense of too much data</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">Here
 we explain how we made our data pipeline scale to 700 million events 
per second while becoming more resilient than ever before. We share some
 math behind our approach and some of the designs of ...</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By&nbsp;</span><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/constantin-pan/" class="fw5 f2 black no-underline">Constantin Pan</a><span class="fw5 f2 black no-underline">,&nbsp;</span></div></li><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/jim-hawkridge/" class="fw5 f2 black no-underline">Jim Hawkridge</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="https://blog.cloudflare.com/tag/bugs/" class="no-underline f1 fw2 blue3 underline-hover">Bugs,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/analytics/" class="no-underline f1 fw2 blue3 underline-hover">Analytics,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/data/" class="no-underline f1 fw2 blue3 underline-hover">Data,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/graphql/" class="no-underline f1 fw2 blue3 underline-hover">GraphQL,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/sql/" class="no-underline f1 fw2 blue3 underline-hover">SQL,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/go/" class="no-underline f1 fw2 blue3 underline-hover">Go,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/sampling/" class="no-underline f1 fw2 blue3 underline-hover">Sampling</a>&nbsp;</span></div></article><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2025-01-03T14:00+00:00">January 03, 2025  3:00 PM</p><a data-testid="related-posts-article-title" href="https://blog.cloudflare.com/multi-path-tcp-revolutionizing-connectivity-one-path-at-a-time/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">Multi-Path TCP: revolutionizing connectivity, one path at a time</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">Multi-
Path TCP (MPTCP) leverages multiple network interfaces, like Wi-Fi and 
cellular, to provide seamless mobility for more reliable connectivity. 
While promising, MPTCP is still in its early stages,...</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By&nbsp;</span><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/marek-majkowski/" class="fw5 f2 black no-underline">Marek Majkowski</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="https://blog.cloudflare.com/tag/tcp/" class="no-underline f1 fw2 blue3 underline-hover">TCP,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/network/" class="no-underline f1 fw2 blue3 underline-hover">Network,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/linux/" class="no-underline f1 fw2 blue3 underline-hover">Linux,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive</a>&nbsp;</span></div></article><article data-testid="related-posts-article" class="w-100 w-100-m w-50-l ph3 mb4"><p data-testid="related-posts-article-date" class="f3 fw5 gray5" data-iso-date="2024-10-25T14:00+01:00">October 25, 2024  3:00 PM</p><a data-testid="related-posts-article-title" href="https://blog.cloudflare.com/elephants-in-tunnels-how-hyperdrive-connects-to-databases-inside-your-vpc-networks/" class="no-underline gray1 f4 fw5"><h2 class="gray1 f4 fw5 mt2">Elephants in tunnels: how Hyperdrive connects to databases inside your VPC networks</h2></a><p data-testid="related-posts-article-excerpt" class="gray1 lh-copy">Hyperdrive
 (Cloudflare’s globally distributed SQL connection pooler and cache) 
recently added support for directing database traffic from Workers 
across Cloudflare Tunnels. We dive deep on what it took to add this 
feature....</p><ul class="flex pl0 fw6 f2 mb3 flex flex-wrap"><span>By&nbsp;</span><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/andrew-repp/" class="fw5 f2 black no-underline">Andrew Repp</a><span class="fw5 f2 black no-underline">,&nbsp;</span></div></li><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/emilio-assuncao/" class="fw5 f2 black no-underline">Emilio Assunção</a><span class="fw5 f2 black no-underline">,&nbsp;</span></div></li><li class="list flex items-center" style="white-space: nowrap;"><div class="author-name-tooltip"><a href="https://blog.cloudflare.com/author/abhishek-chanda/" class="fw5 f2 black no-underline">Abhishek Chanda</a></div></li></ul><div data-testid="related-posts-article-tags" class="flex flex-row flex-wrap"><span><a href="https://blog.cloudflare.com/tag/developer-platform/" class="no-underline f1 fw2 blue3 underline-hover">Developer Platform,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/deep-dive/" class="no-underline f1 fw2 blue3 underline-hover">Deep Dive,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/workers/" class="no-underline f1 fw2 blue3 underline-hover">Cloudflare Workers,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/hyperdrive/" class="no-underline f1 fw2 blue3 underline-hover">Hyperdrive,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/postgres/" class="no-underline f1 fw2 blue3 underline-hover">Postgres,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/sql/" class="no-underline f1 fw2 blue3 underline-hover">SQL,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/rust/" class="no-underline f1 fw2 blue3 underline-hover">Rust,</a>&nbsp;</span><span><a href="https://blog.cloudflare.com/tag/websockets/" class="no-underline f1 fw2 blue3 underline-hover">WebSockets</a>&nbsp;</span></div></article></div></astro-island><footer class="pt4 pb4 pl1 pr1 main-footer"><div class="mw8 center dn db-l ph3"><div class="flex flex-row justify-between"><div class="main-footer__menu-group"><ul id="getting-started-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="getting-started-menu">Getting Started<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/free/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="free-plans" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Free plans</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/enterprise/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="enterprise" class="f1 blue3 no-underline underline-hover" rel="noreferrer">For enterprises</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="compare-plans" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Compare plans</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/about-your-website/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="get-a-recommendation" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Get a recommendation</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/enterprise/demo/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="request-a-demo" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Request a demo</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/plans/enterprise/contact/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="contact-sales" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Contact Sales</a></li></ul></div><div class="main-footer__menu-group"><ul id="company-menu" class="list pl0"><li class="pt1 pb1 f1" data-submenu="company-menu">Resources<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/learning/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="learning-center" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Learning Center</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/analysts/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="analysts-report" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Analyst reports</a></li><li class="pt1 pb1"><a href="https://radar.cloudflare.com/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare Radar</a></li><li class="pt1 pb1"><a href="https://cloudflare.tv/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="tv" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare TV</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/case-studies/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="case-studies" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Case Studies</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/resource-hub/?resourcetype=Webinar" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="webinars" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Webinars</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/resource-hub/?resourcetype=Whitepaper" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="white-papers" class="f1 blue3 no-underline underline-hover" rel="noreferrer">White Papers</a></li><li class="pt1 pb1"><a href="https://developers.cloudflare.com/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="developer-docs" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Developer docs</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/the-net/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="theNet" class="f1 blue3 no-underline underline-hover" rel="noreferrer">theNet</a></li></ul></div><div class="main-footer__menu-group"><ul id="sales-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="sales-menu">Solutions<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/connectivity-cloud/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="connectivity-cloud" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Connectivity cloud</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/zero-trust/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="zero-trust" class="f1 blue3 no-underline underline-hover" rel="noreferrer">SSE and SASE services</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/application-services/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="application-services" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Application services</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/network-services/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="network-services" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Network services</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/developer-platform/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="developer-services" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Developer services</a></li></ul></div><div class="main-footer__menu-group"><ul id="community-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="community-menu">Community<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://community.cloudflare.com/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="community_hub" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Community Hub</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/galileo/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="galileo" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Project Galileo</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/athenian/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="athenian" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Athenian Project</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/campaigns/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="cloudflare-for-campaigns" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare for Campaigns</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/partners/technology-partners/cidp/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="critical-infrastructure-defense-project" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Critical Infrastructure Defense Project</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/connect2024/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="connect-2024" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Connect 2024</a></li></ul></div><div class="main-footer__menu-group"><ul id="support-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="support-menu">Support<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://support.cloudflare.com/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="help-center" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Help center</a></li><li class="pt1 pb1"><a href="https://www.cloudflarestatus.com/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="status" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Cloudflare Status</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/compliance/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="compliance" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Compliance</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/gdpr/introduction/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="gdpr" class="f1 blue3 no-underline underline-hover" rel="noreferrer">GDPR</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/trust-hub/abuse-approach/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="trust-and-safety" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Trust &amp; Safety</a></li></ul></div><div class="main-footer__menu-group"><ul id="company-menu" class="list pl0"><li class="pt1 pb1 f1 main-footer__menu-group__header js-toggle-footer-group" data-submenu="company-menu">Company<i class="icon-caret-down"></i></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/about-overview/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="overview" class="f1 blue3 no-underline underline-hover" rel="noreferrer">About Cloudflare</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/people/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="our_team" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Our team</a></li><li class="pt1 pb1"><a href="https://cloudflare.net/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="investor-relations" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Investor relations</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/press/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="press" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Press</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/careers/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="careers" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Careers</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/diversity-equity-and-inclusion/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="diversity-equity-inclusion" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Diversity, equity &amp; inclusion</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/impact/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="impact-ESG" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Impact/ESG</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/network/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="network_map" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Network Map</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/press-kit/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="press-kit" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Logos &amp; press kit</a></li><li class="pt1 pb1"><a href="https://www.cloudflare.com/partners/" target="_blank" data-tracking-category="footer" data-tracking-action="click" data-tracking-label="partners" class="f1 blue3 no-underline underline-hover" rel="noreferrer">Become a partner</a></li></ul></div></div></div><div class="mw8 center ph3"><div class="flex flex-row flex-wrap justify-center md:justify-between items-center pt4"><div class="flex flex-row space-x-4 items-start w-25-l pb4 pb0-l"><a target="_blank" rel="noreferrer" href="https://www.facebook.com/Cloudflare/" class="w-8"><img class="w-8" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/facebook.svg" alt="facebook"></a><a target=" _blank" rel="noreferrer" href="https://x.com/Cloudflare" class="w-8"><img class="w-8" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/twitter.svg" alt="X"></a><a target="_blank" rel="noreferrer" href="https://www.linkedin.com/company/cloudflare" class="w-8"><img class="w-8" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/linkedin.svg" alt="linkedin"></a><a target="_blank" rel="noreferrer" href="https://www.youtube.com/cloudflare" class="w-8"><img class="w-8" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/youtube.svg" alt="youtube"></a><a target="_blank" rel="noreferrer" href="https://www.instagram.com/cloudflare" class="w-8"><img class="w-8" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/instagram.svg" alt="instagram"></a></div><div class="w-70-l tr-l tl-ns"><div><span class="main-footer__copyright f1">© <!-- -->2025<!-- --> Cloudflare, Inc.<!-- --> </span><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/privacypolicy/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Privacy Policy<!-- --> </a><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/website-terms/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Terms of Use<!-- --> </a><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/disclosure/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Report Security Issues<!-- --> </a><span class="main-footer__copyright f1">|</span><img class="mw2 ph1" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/privacy-options.svg" alt="Privacy Options"><a href="#cookie-settings" id="ot-sdk-btn" class="ot-sdk-show-settings main-footer__copyright f1 no-underline underline-hover">Cookie Preferences</a><span class="main-footer__copyright f1">|</span><a href="https://www.cloudflare.com/trademark/" target="_blank" class="main-footer__copyright f1 no-underline underline-hover" rel="noreferrer"> <!-- -->Trademark<!-- --> </a></div></div></div></div></footer><script defer="defer" src="How%20to%20execute%20an%20object%20file_%20part%204,%20AArch64%20edition_files/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon="{&quot;rayId&quot;:&quot;91d3e5bfef0ea070&quot;,&quot;serverTiming&quot;:{&quot;name&quot;:{&quot;cfExtPri&quot;:true,&quot;cfL4&quot;:true,&quot;cfSpeedBrain&quot;:true,&quot;cfCacheStatus&quot;:true}},&quot;version&quot;:&quot;2025.1.0&quot;,&quot;token&quot;:&quot;2bc156e5f250476cb274d269511ffb57&quot;}" crossorigin="anonymous"></script>
<div id="onetrust-consent-sdk"><div class="onetrust-pc-dark-filter ot-hide ot-fade-in"></div></div></body></html>